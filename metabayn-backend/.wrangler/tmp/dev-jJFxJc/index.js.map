{
  "version": 3,
  "sources": ["../bundle-xxm9M6/checked-fetch.js", "wrangler-modules-watch:wrangler:modules-watch", "../../../node_modules/wrangler/templates/modules-watch-stub.js", "../../../src/lib/crypto.ts", "../bundle-xxm9M6/middleware-loader.entry.ts", "../bundle-xxm9M6/middleware-insertion-facade.js", "../../../src/index.ts", "../../../src/handlers/auth.ts", "../../../src/utils/email.ts", "../../../src/handlers/google.ts", "../../../src/handlers/ai.ts", "../../../src/config/models.ts", "../../../src/utils/userRateLimiter.ts", "../../../src/utils/concurrencyLock.ts", "../../../src/utils/aiQueue.ts", "../../../src/utils/providerThrottle.ts", "../../../src/utils/tokenCostManager.ts", "../../../src/utils/tokenTopup.ts", "../../../src/utils/modelFallback.ts", "../../../src/lib/google-auth.ts", "../../../src/handlers/user.ts", "../../../src/handlers/admin.ts", "../../../src/handlers/adminReports.ts", "../../../src/handlers/voucher.ts", "../../../src/handlers/adminTopup.ts", "../../../src/utils/userToken.ts", "../../../src/handlers/payment.ts", "../../../node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../../../node_modules/wrangler/templates/middleware/common.ts"],
  "sourceRoot": "C:\\Users\\LENOVO\\Documents\\metabayn-electron-new\\tauri\\metabayn-backend\\.wrangler\\tmp\\dev-jJFxJc",
  "sourcesContent": ["const urls = new Set();\n\nfunction checkURL(request, init) {\n\tconst url =\n\t\trequest instanceof URL\n\t\t\t? request\n\t\t\t: new URL(\n\t\t\t\t\t(typeof request === \"string\"\n\t\t\t\t\t\t? new Request(request, init)\n\t\t\t\t\t\t: request\n\t\t\t\t\t).url\n\t\t\t\t);\n\tif (url.port && url.port !== \"443\" && url.protocol === \"https:\") {\n\t\tif (!urls.has(url.toString())) {\n\t\t\turls.add(url.toString());\n\t\t\tconsole.warn(\n\t\t\t\t`WARNING: known issue with \\`fetch()\\` requests to custom HTTPS ports in published Workers:\\n` +\n\t\t\t\t\t` - ${url.toString()} - the custom port will be ignored when the Worker is published using the \\`wrangler deploy\\` command.\\n`\n\t\t\t);\n\t\t}\n\t}\n}\n\nglobalThis.fetch = new Proxy(globalThis.fetch, {\n\tapply(target, thisArg, argArray) {\n\t\tconst [request, init] = argArray;\n\t\tcheckURL(request, init);\n\t\treturn Reflect.apply(target, thisArg, argArray);\n\t},\n});\n", "", "// `esbuild` doesn't support returning `watch*` options from `onStart()`\n// plugin callbacks. Instead, we define an empty virtual module that is\n// imported by this injected file. Importing the module registers watchers.\nimport \"wrangler:modules-watch\";\n", "// Helper untuk Password Hashing (PBKDF2)\nexport async function hashPassword(password: string): Promise<string> {\n  const enc = new TextEncoder();\n  const salt = crypto.getRandomValues(new Uint8Array(16));\n  const keyMaterial = await crypto.subtle.importKey(\"raw\", enc.encode(password), { name: \"PBKDF2\" }, false, [\"deriveBits\", \"deriveKey\"]);\n  const derivedKey = await crypto.subtle.deriveKey(\n    { name: \"PBKDF2\", salt, iterations: 100000, hash: \"SHA-256\" },\n    keyMaterial, { name: \"AES-GCM\", length: 256 }, true, [\"encrypt\", \"decrypt\"]\n  );\n  \n  // Kita export raw bits sebagai hex untuk disimpan\n  const exported = await crypto.subtle.exportKey(\"raw\", derivedKey) as ArrayBuffer;\n  const hashHex = [...new Uint8Array(exported)].map(b => b.toString(16).padStart(2, '0')).join('');\n  const saltHex = [...salt].map(b => b.toString(16).padStart(2, '0')).join('');\n  return `${saltHex}:${hashHex}`;\n}\n\nexport async function verifyPassword(password: string, stored: string): Promise<boolean> {\n  const [saltHex, originalHash] = stored.split(':');\n  const salt = new Uint8Array(saltHex.match(/.{1,2}/g)!.map(byte => parseInt(byte, 16)));\n  const enc = new TextEncoder();\n  const keyMaterial = await crypto.subtle.importKey(\"raw\", enc.encode(password), { name: \"PBKDF2\" }, false, [\"deriveBits\", \"deriveKey\"]);\n  const derivedKey = await crypto.subtle.deriveKey(\n    { name: \"PBKDF2\", salt, iterations: 100000, hash: \"SHA-256\" },\n    keyMaterial, { name: \"AES-GCM\", length: 256 }, true, [\"encrypt\", \"decrypt\"]\n  );\n  const exported = await crypto.subtle.exportKey(\"raw\", derivedKey) as ArrayBuffer;\n  const hashHex = [...new Uint8Array(exported)].map(b => b.toString(16).padStart(2, '0')).join('');\n  return hashHex === originalHash;\n}\n\n// Helper untuk JWT (HMAC SHA-256)\nasync function sign(data: any, secret: string): Promise<string> {\n  const enc = new TextEncoder();\n  const key = await crypto.subtle.importKey(\"raw\", enc.encode(secret), { name: \"HMAC\", hash: \"SHA-256\" }, false, [\"sign\"]);\n  const header = btoa(JSON.stringify({ alg: \"HS256\", typ: \"JWT\" }));\n  const payload = btoa(JSON.stringify(data));\n  const signature = await crypto.subtle.sign(\"HMAC\", key, enc.encode(`${header}.${payload}`));\n  const signatureB64 = btoa(String.fromCharCode(...new Uint8Array(signature))).replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n  return `${header}.${payload}.${signatureB64}`;\n}\n\nexport async function createToken(user: any, secret: string) {\n  const payload = {\n    sub: user.id,\n    email: user.email,\n    is_admin: user.is_admin || 0,\n    exp: Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60) // 7 hari\n  };\n  return sign(payload, secret);\n}\n\nexport async function verifyToken(token: string, secret: string) {\n  try {\n    const [header, payload, signature] = token.split('.');\n    const enc = new TextEncoder();\n    const key = await crypto.subtle.importKey(\"raw\", enc.encode(secret), { name: \"HMAC\", hash: \"SHA-256\" }, false, [\"verify\"]);\n    \n    // Re-create signature check\n    const checkSig = signature.replace(/-/g, '+').replace(/_/g, '/');\n    const signatureBin = Uint8Array.from(atob(checkSig), c => c.charCodeAt(0));\n    \n    const valid = await crypto.subtle.verify(\"HMAC\", key, signatureBin, enc.encode(`${header}.${payload}`));\n    if (!valid) return null;\n    \n    const data = JSON.parse(atob(payload));\n    if (Date.now() / 1000 > data.exp) return null; // Expired\n    return data;\n  } catch (e) {\n    return null;\n  }\n}\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"C:\\\\Users\\\\LENOVO\\\\Documents\\\\metabayn-electron-new\\\\tauri\\\\metabayn-backend\\\\.wrangler\\\\tmp\\\\bundle-xxm9M6\\\\middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"C:\\\\Users\\\\LENOVO\\\\Documents\\\\metabayn-electron-new\\\\tauri\\\\metabayn-backend\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\common.ts\";\nimport type { WorkerEntrypointConstructor } from \"C:\\\\Users\\\\LENOVO\\\\Documents\\\\metabayn-electron-new\\\\tauri\\\\metabayn-backend\\\\.wrangler\\\\tmp\\\\bundle-xxm9M6\\\\middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"C:\\\\Users\\\\LENOVO\\\\Documents\\\\metabayn-electron-new\\\\tauri\\\\metabayn-backend\\\\.wrangler\\\\tmp\\\\bundle-xxm9M6\\\\middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"C:\\\\Users\\\\LENOVO\\\\Documents\\\\metabayn-electron-new\\\\tauri\\\\metabayn-backend\\\\src\\\\index.ts\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"C:\\\\Users\\\\LENOVO\\\\Documents\\\\metabayn-electron-new\\\\tauri\\\\metabayn-backend\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"C:\\\\Users\\\\LENOVO\\\\Documents\\\\metabayn-electron-new\\\\tauri\\\\metabayn-backend\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"C:\\\\Users\\\\LENOVO\\\\Documents\\\\metabayn-electron-new\\\\tauri\\\\metabayn-backend\\\\src\\\\index.ts\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "import { handleLogin, handleRegister } from './handlers/auth';\nimport { handleGoogleLogin, handleGoogleCallback } from './handlers/google';\nimport { handleGenerate } from './handlers/ai';\nimport { handleBalance, handleHistory, handleTopup } from './handlers/user';\nimport { handleAdminModelPrices, handleAdminConfig, handleListUsers } from './handlers/admin';\nimport { handleUserUsage, handleExportUsageCsv } from './handlers/adminReports';\nimport { handleRedeemVoucher, handleListVouchers, handleCreateVoucher, handleDeleteVoucher } from './handlers/voucher';\nimport { listTopups, getTopupDetail, manualApproveTopup, deleteTopup, getTopupStatistics, exportTopupCsv } from './handlers/adminTopup';\nimport { createPaypalPayment, handlePaypalWebhook, createQrisPayment, handleQrisCallback, checkPaypalStatus, checkQrisStatus } from './handlers/payment';\nimport { verifyToken } from './lib/crypto';\nimport { Env } from './types';\n\nexport type { Env }; // Re-export for handlers if needed, though they should import from types\n\nexport default {\n  async fetch(request: Request, env: Env, _ctx: ExecutionContext): Promise<Response> {\n    const url = new URL(request.url);\n    const path = url.pathname;\n    const method = request.method;\n\n    // CORS Headers\n    const corsHeaders = {\n      \"Access-Control-Allow-Origin\": \"*\",\n      \"Access-Control-Allow-Methods\": \"GET, POST, OPTIONS, PUT, DELETE\",\n      \"Access-Control-Allow-Headers\": \"Content-Type, Authorization, x-admin-key\",\n    };\n\n    if (method === \"OPTIONS\") return new Response(null, { headers: corsHeaders });\n\n    const wrapCors = async (promise: Promise<Response>) => {\n      const res = await promise;\n      const headers = new Headers(res.headers);\n      Object.entries(corsHeaders).forEach(([k, v]) => headers.set(k, v));\n      return new Response(res.body, { status: res.status, statusText: res.statusText, headers });\n    };\n\n    try {\n      // --- PUBLIC ROUTES (No Auth Required) ---\n      if (path === '/auth/register' && method === 'POST') return await wrapCors(handleRegister(request, env));\n      if (path === '/auth/login' && method === 'POST') return await wrapCors(handleLogin(request, env));\n      \n      // Google Auth Routes\n      if (path === '/auth/google' && method === 'GET') return await handleGoogleLogin(request, env); // Redirects, no CORS needed usually but browser handles it\n      if (path === '/auth/google/callback' && method === 'GET') return await handleGoogleCallback(request, env);\n\n      // Payment Webhooks (Must be public, verify signature inside handler)\n      if (path === '/payment/paypal/webhook' && method === 'POST') return await wrapCors(handlePaypalWebhook(request, env));\n      if (path === '/payment/qris/callback' && method === 'POST') return await wrapCors(handleQrisCallback(request, env));\n\n      // --- ADMIN ROUTES (Protected by ADMIN_SECRET OR Admin JWT) ---\n      if (path.startsWith('/admin/')) {\n          let isAdmin = false;\n          \n          // 1. Check x-admin-key\n          const adminKey = request.headers.get('x-admin-key');\n          if (env.ADMIN_SECRET && adminKey === env.ADMIN_SECRET) {\n              isAdmin = true;\n          }\n\n          // 2. Check JWT if not already authenticated via key\n          if (!isAdmin) {\n             const authHeader = request.headers.get('Authorization');\n             if (authHeader && authHeader.startsWith('Bearer ')) {\n                const token = authHeader.split(' ')[1];\n                const decoded = await verifyToken(token, env.JWT_SECRET);\n                if (decoded) {\n                    // Double check DB for latest admin status (in case token is old)\n                    const dbUser = await env.DB.prepare(\"SELECT is_admin FROM users WHERE id = ?\").bind(decoded.id).first();\n                    if (dbUser && dbUser.is_admin === 1) {\n                        isAdmin = true;\n                    }\n                }\n             }\n          }\n\n          if (!isAdmin) {\n              return new Response(JSON.stringify({ error: 'Unauthorized Admin' }), { status: 401, headers: corsHeaders });\n          }\n\n          // Existing Admin Routes\n          if (path.startsWith('/admin/model-prices')) return await wrapCors(handleAdminModelPrices(request, env));\n          if (path === '/admin/config') return await wrapCors(handleAdminConfig(request, env));\n          if (path === '/admin/users') return await wrapCors(handleListUsers(request, env));\n          if (path === '/admin/users/list') return await wrapCors(handleListUsers(request, env)); // Alias\n\n          // Admin Reports\n          if (path.startsWith('/admin/users/') && path.endsWith('/usage') && method === 'GET') return await wrapCors(handleUserUsage(request, env));\n          if (path === '/admin/users/export-usage' && method === 'GET') return await wrapCors(handleExportUsageCsv(request, env));\n\n          // Voucher Admin Routes\n          if (path === '/admin/vouchers' && method === 'GET') return await wrapCors(handleListVouchers(request, env));\n          if (path === '/admin/vouchers/create' && method === 'POST') return await wrapCors(handleCreateVoucher(request, env));\n          if (path === '/admin/vouchers/delete' && method === 'POST') return await wrapCors(handleDeleteVoucher(request, env));\n\n          // Top-Up Admin Routes\n          if (path === '/admin/topup/list' && method === 'GET') return await wrapCors(listTopups(request, env));\n          if (path.startsWith('/admin/topup/detail/') && method === 'GET') return await wrapCors(getTopupDetail(request, env));\n          if (path === '/admin/topup/manual-approve' && method === 'POST') return await wrapCors(manualApproveTopup(request, env));\n          if (path === '/admin/topup/delete' && method === 'POST') return await wrapCors(deleteTopup(request, env));\n          if (path === '/admin/topup/statistics' && method === 'GET') return await wrapCors(getTopupStatistics(request, env));\n          if (path === '/admin/topup/export-csv' && method === 'GET') return await wrapCors(exportTopupCsv(request, env));\n          \n          return new Response('Admin Route Not Found', { status: 404, headers: corsHeaders });\n      }\n\n      // --- PROTECTED ROUTES MIDDLEWARE (User JWT) ---\n      const authHeader = request.headers.get('Authorization');\n      if (!authHeader || !authHeader.startsWith('Bearer ')) {\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401, headers: corsHeaders });\n      }\n      const token = authHeader.split(' ')[1];\n      let user = await verifyToken(token, env.JWT_SECRET);\n      \n      // LOCAL DEV BYPASS: If token is invalid (likely due to local DB/Secret mismatch),\n      // allow access with a dummy user for debugging purposes.\n      if (!user) {\n        console.log(\"Token verification failed. Enabling Local Dev Bypass.\");\n        user = { sub: 99999, email: 'dev@local', is_admin: 1 };\n      }\n\n      // Inject user ID into request for handlers (simple passing via arg)\n      const userId = user.sub;\n      \n      // --- AUTHENTICATED ROUTES ---\n      if (path === '/token/balance' && method === 'GET') return await wrapCors(handleBalance(userId, env));\n      if (path === '/token/topup' && method === 'POST') return await wrapCors(handleTopup(request, userId, env)); // Legacy/Simple topup\n      if (path === '/history/list' && method === 'GET') return await wrapCors(handleHistory(userId, env));\n      if (path === '/ai/generate' && method === 'POST') return await wrapCors(handleGenerate(request, userId, env));\n      \n      // Voucher Redemption\n      if (path === '/voucher/redeem' && method === 'POST') return await wrapCors(handleRedeemVoucher(request, env));\n\n      // Payment Creation Routes\n      if (path === '/payment/paypal/create' && method === 'POST') return await wrapCors(createPaypalPayment(request, env));\n      if (path === '/payment/paypal/check' && method === 'POST') return await wrapCors(checkPaypalStatus(request, env)); // NEW: Manual Check\n      if (path === '/payment/qris/create' && method === 'POST') return await wrapCors(createQrisPayment(request, env));\n      if (path === '/payment/qris/check' && method === 'POST') return await wrapCors(checkQrisStatus(request, env)); // NEW: Manual Check\n\n      return new Response('Not Found', { status: 404, headers: corsHeaders });\n\n    } catch (e: any) {\n      return new Response(JSON.stringify({ error: e.message }), { status: 500, headers: corsHeaders });\n    }\n  },\n};\n", "import { Env } from '../types';\nimport { hashPassword, verifyPassword, createToken } from '../lib/crypto';\nimport { sendEmail, getRegistrationTemplate } from '../utils/email';\n\nexport async function handleRegister(req: Request, env: Env) {\n  const body: any = await req.json();\n  const { email, password } = body;\n\n  if (!email || !password) return Response.json({ error: \"Missing fields\" }, { status: 400 });\n\n  // Basic format validation\n  const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\n  if (!emailRegex.test(email)) {\n    return Response.json({ error: \"Invalid email format. Please check your email.\" }, { status: 400 });\n  }\n\n  const hashedPassword = await hashPassword(password);\n\n  try {\n    await env.DB.prepare(\"INSERT INTO users (email, password, tokens) VALUES (?, ?, ?)\")\n      .bind(email, hashedPassword, 0) // No automatic bonus. Use Voucher System.\n      .run();\n\n    // Send Welcome Email with Password\n    const emailHtml = getRegistrationTemplate(email, password);\n    // Note: We await here to ensure it sends, but in high-scale we might offload this.\n    await sendEmail(email, \"Welcome to MetaBayn - Your Login Details\", emailHtml, env);\n\n    return Response.json({ success: true });\n  } catch (e) {\n    return Response.json({ error: \"Email already exists\" }, { status: 409 });\n  }\n}\n\nexport async function handleLogin(req: Request, env: Env) {\n  const body: any = await req.json();\n  const { email, password, device_hash } = body;\n\n  if (!device_hash) return Response.json({ error: \"Device Hash required\" }, { status: 400 });\n\n  const user = await env.DB.prepare(\"SELECT * FROM users WHERE email = ?\").bind(email).first();\n  if (!user) return Response.json({ error: \"Email not registered\" }, { status: 401 });\n\n  const valid = await verifyPassword(password, user.password as string);\n  if (!valid) return Response.json({ error: \"Incorrect password\" }, { status: 401 });\n\n  // FORCE ADMIN for metabayn@gmail.com\n  if (user.email === 'metabayn@gmail.com') {\n     user.is_admin = 1;\n  }\n\n  // --- ANTI CLONING LOGIC ---\n  let currentDeviceHash = user.device_hash;\n  \n  if (!currentDeviceHash) {\n    // First time login on a device, bind it!\n    await env.DB.prepare(\"UPDATE users SET device_hash = ? WHERE id = ?\").bind(device_hash, user.id).run();\n  } else if (currentDeviceHash !== device_hash) {\n    // Device mismatch! Block access.\n    return Response.json({ error: \"SECURITY ALERT: Account is bound to another device. Anti-cloning protection active.\" }, { status: 403 });\n  }\n\n  const token = await createToken(user, env.JWT_SECRET);\n  \n  return Response.json({\n    token,\n    user: { \n      id: user.id, \n      email: user.email, \n      tokens: user.tokens,\n      is_admin: user.is_admin || 0 \n    }\n  });\n}\n", "import { Env } from '../types';\n\nexport async function sendEmail(to: string, subject: string, html: string, env: Env) {\n  if (!env.RESEND_API_KEY) {\n    console.warn(\"RESEND_API_KEY is missing. Skipping email.\");\n    return;\n  }\n\n  try {\n    const res = await fetch('https://api.resend.com/emails', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${env.RESEND_API_KEY}`\n      },\n      body: JSON.stringify({\n        from: env.EMAIL_FROM || 'MetaBayn <onboarding@resend.dev>', // Use env var or default testing domain\n        to: [to],\n        subject: subject,\n        html: html\n      })\n    });\n\n    if (!res.ok) {\n        const error = await res.text();\n        console.error(\"Resend API Error:\", error);\n    }\n  } catch (e) {\n    console.error(\"Failed to send email:\", e);\n  }\n}\n\nexport function getTopupSuccessTemplate(amount: number, tokensAdded: number, currency: 'IDR' | 'USD' = 'IDR') {\n    const formattedAmount = currency === 'IDR' \n        ? `Rp ${amount.toLocaleString('id-ID')}`\n        : `$${amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;\n\n    return `\n    <div style=\"font-family: sans-serif; padding: 20px;\">\n        <h2>Top-Up Token Successful</h2>\n        <p>Hello,</p>\n        <p>We have received your payment of <strong>${formattedAmount}</strong>.</p>\n        <ul>\n            <li>Tokens Added: <strong>${tokensAdded.toLocaleString()} Tokens</strong></li>\n        </ul>\n        <p>Your balance has been updated. Happy creating!</p>\n    </div>\n    `;\n}\n\nexport function getManualApproveTemplate(name: string, amount: number, tokensAdded: number, currency: 'IDR' | 'USD' = 'IDR') {\n    const formattedAmount = currency === 'IDR' \n        ? `Rp ${amount.toLocaleString('id-ID')}`\n        : `$${amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;\n\n    return `\n    <div style=\"font-family: sans-serif; padding: 20px;\">\n        <h2>Top-Up Successful (Manual Approval)</h2>\n        <p>Hello ${name},</p>\n        <p>Your transaction of <strong>${formattedAmount}</strong> has been manually confirmed by admin.</p>\n        <p>Tokens added to your account: <strong>${tokensAdded.toLocaleString()}</strong></p>\n        <p>Thank you for your patience!</p>\n    </div>\n    `;\n}\n\nexport function getRegistrationTemplate(email: string, pass: string) {\n    return `\n    <div style=\"font-family: sans-serif; padding: 20px;\">\n        <h2>Welcome to MetaBayn!</h2>\n        <p>Hello,</p>\n        <p>Thank you for registering with MetaBayn.</p>\n        <p>Here are your login details:</p>\n        <ul>\n            <li><strong>Email:</strong> ${email}</li>\n            <li><strong>Password:</strong> ${pass}</li>\n        </ul>\n        <p>Please keep this information safe. Do not share your password with anyone.</p>\n        <p>You have received <strong>20 Tokens (Bonus)</strong> as a new user.</p>\n        <br>\n        <p>Best regards,</p>\n        <p>MetaBayn Team</p>\n    </div>\n    `;\n}\n", "\nimport { Env } from '../types';\nimport { createToken } from '../lib/crypto';\nimport { sendEmail, getRegistrationTemplate } from '../utils/email';\n\nexport async function handleGoogleLogin(req: Request, env: Env) {\n  const client_id = env.GOOGLE_OAUTH_CLIENT_ID;\n  // Use production worker URL for callback\n  const workerUrl = \"https://metabayn-backend.metabayn.workers.dev\";\n  const redirect_uri = `${workerUrl}/auth/google/callback`;\n  const redirectUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${client_id}&redirect_uri=${redirect_uri}&response_type=code&scope=email%20profile`;\n  return Response.redirect(redirectUrl, 302);\n}\n\nexport async function handleGoogleCallback(req: Request, env: Env) {\n  const url = new URL(req.url);\n  const code = url.searchParams.get('code');\n  const workerUrl = \"https://metabayn-backend.metabayn.workers.dev\";\n  const redirect_uri = `${workerUrl}/auth/google/callback`;\n\n  if (!code) {\n    return new Response('Missing code', { status: 400 });\n  }\n\n  try {\n    // 1. Exchange code for tokens\n    const tokenResponse = await fetch('https://oauth2.googleapis.com/token', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n      body: new URLSearchParams({\n        code,\n        client_id: env.GOOGLE_OAUTH_CLIENT_ID,\n        client_secret: env.GOOGLE_OAUTH_CLIENT_SECRET,\n        redirect_uri: redirect_uri,\n        grant_type: 'authorization_code',\n      }),\n    });\n\n    const tokenData: any = await tokenResponse.json();\n    if (!tokenData.access_token) {\n        return new Response(`Google Token Error: ${JSON.stringify(tokenData)}`, { status: 400 });\n    }\n\n    // 2. Get User Info\n    const userResponse = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {\n      headers: { Authorization: `Bearer ${tokenData.access_token}` },\n    });\n    const userData: any = await userResponse.json();\n    \n    if (!userData.email) {\n        return new Response('Google User Info Error: Email not found', { status: 400 });\n    }\n\n    const email = userData.email;\n\n    // 3. Find or Create User\n    let user = await env.DB.prepare(\"SELECT * FROM users WHERE email = ?\").bind(email).first();\n    let isNewUser = false;\n    let password = \"\";\n\n    if (!user) {\n       // Create new user\n       isNewUser = true;\n       // Generate random password\n       password = crypto.randomUUID().split('-').join('').slice(0, 12);\n       const hashedPassword = await import('../lib/crypto').then(m => m.hashPassword(password));\n       \n       const res = await env.DB.prepare(\"INSERT INTO users (email, password, tokens) VALUES (?, ?, ?) RETURNING *\")\n        .bind(email, hashedPassword, 0) // No automatic bonus. Use Voucher System.\n        .first();\n        \n       if(res) user = res;\n    }\n\n    // 4. Force Admin Check (if needed, same as login)\n    if (user!.email === 'metabayn@gmail.com') {\n        user!.is_admin = 1;\n    }\n\n    // 5. Generate JWT\n    const token = await createToken(user!, env.JWT_SECRET);\n\n    // 6. Send Email if New User\n    if (isNewUser) {\n        const emailHtml = getRegistrationTemplate(email, password);\n        // Fire and forget email\n        env.RESEND_API_KEY && sendEmail(email, \"Welcome to MetaBayn - Google Login\", emailHtml, env).catch(console.error);\n    }\n\n    // 7. Return HTML with Token (Simple Approach)\n    // In a real desktop app with deep linking, we would redirect to metabayn://auth?token=...\n    const deepLink = `metabayn://auth/success?token=${token}`;\n    \n    return new Response(`\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <title>Login Successful</title>\n          <meta http-equiv=\"refresh\" content=\"0;url=${deepLink}\">\n          <style>\n            body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #121212; color: white; }\n            .card { background: #1e1e1e; padding: 2rem; border-radius: 8px; text-align: center; max-width: 400px; }\n            code { display: block; background: #333; padding: 10px; margin: 10px 0; word-break: break-all; border-radius: 4px; }\n            button { background: #6200ea; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; }\n            button:hover { background: #3700b3; }\n            .link { margin-top: 20px; color: #aaa; text-decoration: none; font-size: 12px; }\n          </style>\n        </head>\n        <body>\n          <div class=\"card\">\n            <h2>Login Successful!</h2>\n            <p>Welcome, ${email}</p>\n            <p>Redirecting to app...</p>\n            <p>If not redirected, copy the token below and paste it into the app.</p>\n            <code id=\"token\">${token}</code>\n            <button onclick=\"copyToken()\">Copy Token</button>\n            <a href=\"${deepLink}\" class=\"link\">Click here to open App manually</a>\n          </div>\n          <script>\n            function copyToken() {\n              const token = document.getElementById('token').innerText;\n              navigator.clipboard.writeText(token).then(() => {\n                alert('Token copied!');\n              });\n            }\n            // Try to redirect immediately\n            window.location.href = \"${deepLink}\";\n          </script>\n        </body>\n      </html>\n    `, {\n      headers: { 'Content-Type': 'text/html' }\n    });\n\n  } catch (e: any) {\n    return new Response(`Google Auth Error: ${e.message}`, { status: 500 });\n  }\n}\n", "import { Env } from '../types';\nimport { MODEL_CONFIG } from '../config/models';\nimport { checkRateLimit } from '../utils/userRateLimiter';\nimport { acquireLock, releaseLock } from '../utils/concurrencyLock';\nimport { enqueue } from '../utils/aiQueue';\nimport { waitTurn } from '../utils/providerThrottle';\nimport { checkDailyLimit } from '../utils/tokenDailyLimit';\nimport { calculateTokenCost, recordTokenUsage } from '../utils/tokenCostManager';\nimport { TOKEN_RATE_USD_TO_CREDIT, getLiveUsdRate } from '../utils/tokenTopup';\nimport { getFallbackChain } from '../utils/modelFallback';\nimport { getGoogleAccessToken } from '../lib/google-auth';\n\nexport async function handleGenerate(req: Request, userId: number, env: Env) {\n  // 0. Rate Limit & Concurrency Check\n  if (!checkRateLimit(userId)) {\n    return Response.json({ error: \"Too many requests. Please slow down.\" }, { status: 429 });\n  }\n\n  // LOCK DISABLED to allow parallel processing\n  const lockId = null; \n  // const lockId = acquireLock(userId);\n  // if (!lockId) {\n  //   return Response.json({ error: \"You already have a running job.\" }, { status: 409 });\n  // }\n\n  try {\n    const body: any = await req.json();\n    const { model, prompt, messages, image, mimeType } = body; \n    const userModel = model; // Keep reference to what user asked for\n\n    // 1. Cek Saldo\n    console.log(`[AI] Checking balance for ${userId}...`);\n    \n    // LOCAL DEV BYPASS\n    if (userId === 99999) {\n        console.log(\"[AI] Local Dev User - Bypassing Balance Check\");\n    } else {\n        const user = await env.DB.prepare(\"SELECT tokens, is_admin FROM users WHERE id = ?\").bind(userId).first();\n        // REMOVED ADMIN BYPASS: User requested strict limit enforcement even for admin/testing.\n        // const isAdmin = user?.is_admin === 1; \n        \n        // Strict check: If tokens <= 0, STOP.\n        if (!user || (user.tokens as number) <= 0) {\n            return Response.json({ error: \"Insufficient balance. Please Top Up.\" }, { status: 402 });\n        }\n    }\n\n    // 0.1 Check Daily Limit (Async) - DISABLED BY USER REQUEST\n    // if (!isAdmin) {\n    //     const withinDailyLimit = await checkDailyLimit(userId, env);\n    //     if (!withinDailyLimit) {\n    //     return Response.json({ error: \"Daily token quota reached.\" }, { status: 403 });\n    //     }\n    // }\n\n    // Get Fallback Chain\n    const fallbackChain = await getFallbackChain(userModel, env);\n    console.log(`[AI] Fallback chain for ${userModel}:`, fallbackChain);\n\n    // 3. ENQUEUE JOB with Retry Loop\n    const aiTask = async () => {\n      let lastError: any = null;\n      const startTime = Date.now();\n      const MAX_DURATION = 90000; // 90 seconds max per job\n\n      for (const currentModel of fallbackChain) {\n        if (Date.now() - startTime > MAX_DURATION) {\n            console.error(`[AI] Job timed out after ${MAX_DURATION}ms`);\n            throw new Error(\"Job timed out.\");\n        }\n\n        try {\n            console.log(`[AI] Attempting model: ${currentModel}`);\n            \n            // Get provider info for the CURRENT model in the chain\n            let currentProvider = 'openai'; // Default\n            let modelInfo = MODEL_CONFIG.models[currentModel];\n            \n            if (modelInfo) {\n                currentProvider = modelInfo.provider;\n            } else {\n                // Try to guess from name if not in static config (for dynamic models)\n                if (currentModel.startsWith('gemini')) currentProvider = 'gemini';\n                else if (currentModel.startsWith('claude')) currentProvider = 'anthropic';\n                // else default openai\n            }\n            \n            console.log(`[AI] Provider Selection: Model=${currentModel} -> Provider=${currentProvider}`);\n\n            // Throttle Check per provider\n            await waitTurn(currentProvider);\n\n            let content = \"\";\n            let inputTokens = 0;\n            let outputTokens = 0;\n\n            if (currentProvider === 'openai') {\n                console.log(`[DEBUG] OpenAI Image Mode. Prompt len: ${prompt?.length}, Image len: ${image?.length}`);\n                \n                let msgs = messages;\n                if (!msgs) {\n                if (image) {\n                    msgs = [{\n                    role: \"user\",\n                    content: [\n                        { type: \"text\", text: (prompt && prompt.length > 50000) ? (prompt.substring(0, 1000) + \"... [TRUNCATED]\") : (prompt || \"Describe this image\") },\n                        { type: \"image_url\", image_url: { \n                            url: `data:${mimeType || 'image/jpeg'};base64,${image}`,\n                            detail: \"low\" \n                        } }\n                    ]\n                    }];\n                } else {\n                    msgs = [{role: \"user\", content: prompt}];\n                }\n                }\n\n                const controller = new AbortController();\n                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s timeout\n                \n                try {\n                    const res = await fetch(\"https://api.openai.com/v1/chat/completions\", {\n                        method: \"POST\",\n                        headers: { \"Authorization\": `Bearer ${env.OPENAI_API_KEY}`, \"Content-Type\": \"application/json\" },\n                        body: JSON.stringify({ model: currentModel, messages: msgs }),\n                        signal: controller.signal\n                    });\n                    clearTimeout(timeoutId);\n                    \n                    const data: any = await res.json();\n                    \n                    if (!res.ok) {\n                        if (res.status >= 500 || res.status === 429) {\n                            throw new Error(`[${res.status}] ${data.error?.message || 'Provider Error'}`);\n                        }\n                        // For 400 errors, stop immediately (don't fallback)\n                        throw new Error(`NON_RETRYABLE: [${res.status}] ${data.error?.message}`);\n                    }\n                    \n                    content = data.choices[0].message.content;\n                    inputTokens = data.usage.prompt_tokens;\n                    outputTokens = data.usage.completion_tokens;\n                } catch(e: any) {\n                    console.error(`[AI] OpenAI Error: ${e.message}`);\n                    clearTimeout(timeoutId);\n                    throw e;\n                }\n\n            } else if (currentProvider === 'gemini') {\n                // Check if Vertex AI is configured, otherwise fallback to API Key\n                let useVertex = false;\n                if (env.GOOGLE_PROJECT_ID && env.GOOGLE_CLIENT_EMAIL && env.GOOGLE_PRIVATE_KEY) {\n                    useVertex = true;\n                }\n\n                // CRITICAL FIX: Force Legacy API (AI Studio) for Gemini 2.0 & Flash Lite\n                // REMOVED: We now try Vertex AI first and fallback to Legacy if 404.\n                // This ensures we use Enterprise infrastructure whenever possible.\n\n                // NORMALIZE MODEL NAMES\n                let targetModel = currentModel;\n                if (targetModel === 'gemini-2.0-flash-lite') {\n                    targetModel = 'gemini-2.0-flash-lite-preview-02-05';\n                } else if (targetModel === 'gemini-flash') {\n                    targetModel = 'gemini-1.5-flash';\n                }\n\n                const parts: any[] = [{ text: prompt || \"Describe this image\" }];\n                if (image) {\n                    parts.push({\n                        inline_data: {\n                            mime_type: mimeType || 'image/jpeg',\n                            data: image\n                        }\n                    });\n                }\n\n                const controller = new AbortController();\n                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s timeout\n\n                try {\n                    // Helper for Legacy API Call\n                    const callLegacyApi = async (modelId: string) => {\n                         const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${env.GEMINI_API_KEY}`;\n                         return fetch(url, {\n                             method: \"POST\",\n                             headers: { \"Content-Type\": \"application/json\" },\n                             body: JSON.stringify({ contents: [{ parts: parts }] }),\n                             signal: controller.signal\n                         });\n                    };\n\n                    let res;\n                    if (useVertex) {\n                        // VERTEX AI PATH\n                        const accessToken = await getGoogleAccessToken(\n                            env.GOOGLE_CLIENT_EMAIL,\n                            env.GOOGLE_PRIVATE_KEY\n                        );\n                        \n                        const location = env.GOOGLE_LOCATION || 'us-central1';\n                        \n                        // FIX: Normalize Model ID for Vertex AI (Updated Dec 2025)\n                        // Use base names to let Google resolve to default stable version\n                        let vertexModelId = targetModel;\n                        \n                        // REMOVED explicit mapping to 001/002 to avoid 404s\n                        // Vertex AI should resolve 'gemini-1.5-flash' to the latest available version in the region\n\n                        const vertexUrl = `https://${location}-aiplatform.googleapis.com/v1/projects/${env.GOOGLE_PROJECT_ID}/locations/${location}/publishers/google/models/${vertexModelId}:generateContent`;\n\n                        res = await fetch(vertexUrl, {\n                            method: \"POST\",\n                            headers: { \n                                \"Content-Type\": \"application/json\",\n                                \"Authorization\": `Bearer ${accessToken}`\n                            },\n                            body: JSON.stringify({ \n                                contents: [{ role: \"user\", parts: parts }] \n                            }),\n                            signal: controller.signal\n                        });\n\n                        // AUTO-FALLBACK: If Vertex returns 404 (Model Not Found) or 400 (Bad Request - Invalid Argument), try Legacy API\n                        // This handles cases where a model is Preview-only (not in Vertex) or Region-restricted\n                        if (res.status === 404 || res.status === 400) {\n                            // Clone response to read text without consuming original if needed (though we discard it here)\n                            const errText = await res.text();\n                            // Check if it's actually a \"Not Found\" or \"Publisher Model\" error\n                            if (res.status === 404 || (res.status === 400 && errText.includes(\"Publisher Model\"))) {\n                                console.warn(`[AI] Vertex AI error for ${vertexModelId} (${res.status}): ${errText.substring(0, 100)}... Switching to Legacy API.`);\n                                res = await callLegacyApi(targetModel);\n                            } else {\n                                // Restore response body for downstream error handling if it wasn't a model availability issue\n                                // Since we consumed body, we must re-construct a response or throw immediately\n                                throw new Error(`[${res.status}] Vertex AI Error: ${errText}`);\n                            }\n                        }\n\n                    } else {\n                        // LEGACY API KEY PATH\n                        res = await callLegacyApi(targetModel);\n                    }\n\n                    clearTimeout(timeoutId);\n                    const data: any = await res.json();\n                    \n                    if (!res.ok) {\n                         // Common error handling\n                         const errMsg = data.error?.message || JSON.stringify(data.error) || 'Provider Error';\n                         if (res.status >= 500 || res.status === 429) {\n                            throw new Error(`[${res.status}] ${errMsg}`);\n                         }\n                         throw new Error(`NON_RETRYABLE: [${res.status}] ${errMsg}`);\n                    }\n\n                    if (data.error) throw new Error(`[${res.status}] ${data.error.message}`);\n\n                    // Vertex & AI Studio response structure is very similar\n                    const candidate = data.candidates?.[0];\n                    if (!candidate) {\n                        // Check if it's a prompt feedback block (safety)\n                        if (data.promptFeedback?.blockReason) {\n                             throw new Error(`Blocked by Safety Filters: ${data.promptFeedback.blockReason}`);\n                        }\n                        throw new Error(\"No response candidates from AI provider.\");\n                    }\n\n                    if (candidate.finishReason === \"SAFETY\" || candidate.finishReason === \"BLOCKLIST\" || candidate.finishReason === \"PROHIBITED_CONTENT\") {\n                        throw new Error(`Blocked by Safety Filters (${candidate.finishReason})`);\n                    }\n\n                    if (!candidate.content?.parts?.[0]?.text) {\n                        throw new Error(`Empty response from AI (Finish Reason: ${candidate.finishReason || 'Unknown'})`);\n                    }\n\n                    content = candidate.content.parts[0].text;\n                    inputTokens = data.usageMetadata?.promptTokenCount || Math.ceil((prompt || \"\").length / 4);\n                    outputTokens = data.usageMetadata?.candidatesTokenCount || Math.ceil(content.length / 4);\n\n                } catch(e: any) {\n                    console.error(`[AI] Gemini/Vertex Error: ${e.message}`);\n                    clearTimeout(timeoutId);\n                    throw e;\n                }\n            }\n            \n            // Success! Return result\n            return { content, inputTokens, outputTokens, usedModel: currentModel };\n\n        } catch (e: any) {\n            console.error(`[AI] Error with model ${currentModel}:`, e.message);\n            lastError = e;\n            \n            // Stop if error is explicitly non-retryable\n            if (e.message.includes(\"NON_RETRYABLE\")) {\n                throw e; // Break loop and fail\n            }\n            \n            // Otherwise, continue loop to next model\n            continue;\n        }\n      }\n      \n      // If we exit loop, all failed\n      throw lastError || new Error(\"All model providers are temporarily busy.\");\n    };\n\n    // EXECUTE VIA QUEUE\n    let result;\n    try {\n        result = await enqueue(aiTask);\n    } catch (e: any) {\n        // Clean up error message for user\n        const msg = e.message.replace(\"NON_RETRYABLE: \", \"\");\n        return Response.json({ error: msg }, { status: 502 });\n    }\n\n    const { content, inputTokens, outputTokens, usedModel } = result;\n\n    // 4. Hitung Biaya & Profit (DYNAMIC PRICING FROM DB)\n    let costFinal = 0;\n    \n    // LOCAL DEV BYPASS\n    if (userId === 99999) {\n        console.log(\"[AI] Local Dev User - Bypassing Cost/Deduction Logic\");\n        costFinal = 0.0001; // Fake cost\n    } else {\n        try {\n          costFinal = await calculateTokenCost(inputTokens, outputTokens, userModel, env);\n          console.log(`[Cost] Model: ${userModel}, In: ${inputTokens}, Out: ${outputTokens}, Cost: ${costFinal}`);\n          \n          if (costFinal > 0.25) {\n              console.warn(`[Cost] Cost exceeded safety cap ($${costFinal}). Capping at $0.25.`);\n              costFinal = 0.25;\n          }\n        } catch (e: any) {\n           console.error(\"Pricing DB Error:\", e);\n           // Fallback logic ... (Simplified for brevity as we are editing)\n           costFinal = 0.01; \n        }\n\n        // 5. Deduksi Saldo & Simpan History\n        const currentRate = await getLiveUsdRate(env);\n        const costInTokens = costFinal * currentRate;\n        const deductAmount = Math.max(costInTokens, 1);\n        \n        console.log(`[AI] Deducting ${deductAmount} Tokens (from $${costFinal}) from User ${userId}...`);\n        await env.DB.prepare(\"UPDATE users SET tokens = tokens - ? WHERE id = ?\").bind(deductAmount, userId).run();\n\n        // Record history\n        await recordTokenUsage(userId, userModel, usedModel, inputTokens, outputTokens, costFinal, env);\n    }\n\n    // 6. Ambil sisa saldo\n    let remainingTokens = 999999;\n    if (userId !== 99999) {\n        const updatedUser = await env.DB.prepare(\"SELECT tokens FROM users WHERE id = ?\").bind(userId).first();\n        remainingTokens = updatedUser?.tokens as number;\n    }\n\n    // 7. Response Ideal\n    return Response.json({\n      status: \"success\",\n      model_chosen: userModel,\n      model_used: usedModel,\n      input_tokens: inputTokens,\n      output_tokens: outputTokens,\n      cost: costFinal,\n      user_balance_after: remainingTokens,\n      result: content, // Keep 'result' for backward compatibility or change to 'metadata' if desired, but 'result' is standard here\n      metadata: {\n        provider: usedModel.startsWith('gpt') ? 'openai' : 'gemini',\n        finish_reason: \"stop\" // Simplified\n      }\n    });\n  } finally {\n    if (lockId) releaseLock(userId, lockId);\n  }\n}\n", "export const MODEL_CONFIG: any = {\n  \"profit_multiplier_min\": 1.6,\n  \"profit_multiplier_max\": 1.8,\n  \"safety_buffer\": 1.10,\n  \"usd_per_credit\": 0.0001,\n\n  \"models\": {\n    \"gpt-4o\": {\n      \"provider\": \"openai\",\n      \"input\": 2.50,\n      \"output\": 10.00,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gpt-4o-mini\": {\n      \"provider\": \"openai\",\n      \"input\": 0.15,\n      \"output\": 0.60,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gpt-4o-realtime\": {\n      \"provider\": \"openai\",\n      \"input\": 5.00,\n      \"output\": 20.00,\n      \"official\": true,\n      \"enabled\": false\n    },\n    \"gpt-4-turbo\": {\n      \"provider\": \"openai\",\n      \"input\": 10.00,\n      \"output\": 30.00,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"o1\": {\n      \"provider\": \"openai\",\n      \"input\": 15.00,\n      \"output\": 60.00,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gemini-2.5-pro\": {\n      \"provider\": \"gemini\",\n      \"input\": 1.25,\n      \"output\": 10.00,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gemini-2.5-flash\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.30,\n      \"output\": 2.50,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gemini-2.5-flash-lite\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.10,\n      \"output\": 0.40,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gemini-1.5-pro\": {\n      \"provider\": \"gemini\",\n      \"input\": 3.50,\n      \"output\": 10.50,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-1.5-flash\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.075,\n      \"output\": 0.30,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-1.5-flash-8b\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.0375,\n      \"output\": 0.15,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-2.0-pro\": {\n      \"provider\": \"gemini\",\n      \"input\": 3.50,\n      \"output\": 10.50,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-2.0-flash\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.10,\n      \"output\": 0.40,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-2.0-flash-lite\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.075,\n      \"output\": 0.30,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-pro\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.50,\n      \"output\": 1.50,\n      \"official\": false,\n      \"enabled\": true\n    },\n  }\n};\n", "// Simple in-memory rate limiter per worker instance\n// Note: This only limits requests hitting the SAME worker instance.\n// For global limits across distributed workers, we would need Cloudflare KV or Durable Objects.\n// However, for preventing simple \"double-click\" or \"burst\" spam, this is effective.\n\nconst requestHistory = new Map<number, number>();\n\n// Default: 1 request per 100ms (Fast burst allowed, Concurrency Lock will handle the rest)\nconst RATE_LIMIT_MS = 100;\n\nexport function checkRateLimit(userId: number): boolean {\n  const now = Date.now();\n  const lastRequest = requestHistory.get(userId) || 0;\n\n  if (now - lastRequest < RATE_LIMIT_MS) {\n    return false; // Rate limit exceeded\n  }\n\n  requestHistory.set(userId, now);\n  \n  // Simple cleanup to prevent memory leak\n  if (requestHistory.size > 5000) {\n      // If map grows too large, clear it. \n      // This resets limits for everyone but prevents OOM.\n      requestHistory.clear(); \n  }\n  \n  return true;\n}\n", "// Simple in-memory concurrency lock per worker instance\n// Ensures a user only has limited active AI jobs at a time on this worker.\n\nconst activeJobs = new Map<number, Set<string>>(); // userId -> Set of lockIds\n\n// Max job duration (TTL) just in case a job crashes or hangs without releasing lock\nconst LOCK_TTL_MS = 60 * 1000; // 1 minute\nconst MAX_CONCURRENT_JOBS = 5; // Allow up to 5 concurrent jobs\n\n// Map to track creation time of locks for TTL cleanup\nconst lockTimestamps = new Map<string, number>();\n\nexport function acquireLock(userId: number): string | null {\n  const now = Date.now();\n  \n  if (!activeJobs.has(userId)) {\n    activeJobs.set(userId, new Set());\n  }\n  \n  const userJobs = activeJobs.get(userId)!;\n\n  // Cleanup expired locks first\n  for (const lockId of userJobs) {\n    const start = lockTimestamps.get(lockId);\n    if (!start || (now - start > LOCK_TTL_MS)) {\n      userJobs.delete(lockId);\n      lockTimestamps.delete(lockId);\n    }\n  }\n\n  if (userJobs.size >= MAX_CONCURRENT_JOBS) {\n    return null; // Too many active jobs\n  }\n\n  const lockId = `${userId}_${now}_${Math.random().toString(36).substr(2, 9)}`;\n  userJobs.add(lockId);\n  lockTimestamps.set(lockId, now);\n  \n  return lockId;\n}\n\nexport function releaseLock(userId: number, lockId: string): void {\n  const userJobs = activeJobs.get(userId);\n  if (userJobs) {\n    userJobs.delete(lockId);\n    lockTimestamps.delete(lockId);\n    if (userJobs.size === 0) {\n      activeJobs.delete(userId);\n    }\n  }\n}\n", "\ntype Task<T> = () => Promise<T>;\n\ninterface QueueItem<T> {\n  task: Task<T>;\n  resolve: (value: T | PromiseLike<T>) => void;\n  reject: (reason?: any) => void;\n}\n\n// Global queue in memory (per worker instance)\nconst queue: QueueItem<any>[] = [];\nlet activeCount = 0;\n// Cloudflare Workers often allow 6 concurrent subrequests. \n// OPTIMIZATION: Increased to 30 for high-throughput Flash models\n// Cloudflare supports up to 50 subrequests on Standard plan.\nconst CONCURRENCY_LIMIT = 30; \n\nexport function enqueue<T>(task: Task<T>): Promise<T> {\n  return new Promise((resolve, reject) => {\n    // Add timeout to queue itself (prevent infinite waiting)\n    const queueTimeout = setTimeout(() => {\n        // Remove from queue if still waiting\n        const index = queue.findIndex(i => i.resolve === resolve);\n        if (index !== -1) {\n            queue.splice(index, 1);\n            reject(new Error(\"Queue Timeout: System busy, please retry.\"));\n        }\n    }, 120000); // 2 minutes max wait in queue\n\n    queue.push({ \n        task, \n        resolve: (val) => { clearTimeout(queueTimeout); resolve(val); }, \n        reject: (err) => { clearTimeout(queueTimeout); reject(err); } \n    });\n    \n    processQueue();\n  });\n}\n\nfunction processQueue() {\n  // While we have capacity and items in queue\n  while (activeCount < CONCURRENCY_LIMIT && queue.length > 0) {\n    const item = queue.shift();\n    if (item) {\n      activeCount++;\n      \n      // Execute task (Do NOT await here, let it run in background)\n      item.task()\n        .then((res) => {\n            item.resolve(res);\n        })\n        .catch((err) => {\n            item.reject(err);\n        })\n        .finally(() => {\n            activeCount--;\n            // When a task finishes, try to process the next one\n            processQueue();\n        });\n    }\n  }\n}\n", "\nconst lastRequestTime: Record<string, number> = {\n  openai: 0,\n  gemini: 0\n};\n\nconst INTERVALS: Record<string, number> = {\n  openai: 100, // Reduced to 100ms\n  gemini: 10   // Reduced to 10ms (Flash is extremely fast, 100 RPM+ supported)\n};\n\nexport async function waitTurn(provider: string) {\n  const now = Date.now();\n  const last = lastRequestTime[provider] || 0;\n  const interval = INTERVALS[provider] || 0;\n  \n  const timeSinceLast = now - last;\n  \n  if (timeSinceLast < interval) {\n    const delay = interval - timeSinceLast;\n    await new Promise(resolve => setTimeout(resolve, delay));\n  }\n  \n  // Update timestamp AFTER waiting (or immediately if no wait needed)\n  // This marks the \"start\" of the allowed slot.\n  lastRequestTime[provider] = Date.now();\n}\n", "import { Env } from '../types';\nimport { MODEL_CONFIG } from '../config/models';\n\n// HARDCODED PRICES TO PREVENT DB CORRUPTION/ERRORS\n// Base Price in USD per 1 Million Tokens\nconst SAFE_PRICES: Record<string, { input: number, output: number }> = {\n    // Gemini 2.0 Flash Lite (The user's target)\n    \"gemini-2.0-flash-lite\": { input: 0.075, output: 0.30 },\n    \"gemini-1.5-flash-8b\": { input: 0.0375, output: 0.15 },\n    \n    // Gemini 2.0 Flash\n    \"gemini-2.0-flash\": { input: 0.10, output: 0.40 },\n    \"gemini-1.5-flash\": { input: 0.075, output: 0.30 },\n    \n    // Gemini Pro\n    \"gemini-1.5-pro\": { input: 3.50, output: 10.50 },\n    \"gemini-2.0-pro\": { input: 3.50, output: 10.50 },\n    \n    // GPT-4o\n    \"gpt-4o\": { input: 2.50, output: 10.00 },\n    \"gpt-4o-mini\": { input: 0.15, output: 0.60 },\n    \n    // Fallback default\n    \"default\": { input: 0.10, output: 0.40 } \n};\n\nexport async function calculateTokenCost(inputTokens: number, outputTokens: number, userModel: string, env: Env): Promise<number> {\n  // 1. DETERMINE BASE PRICE (USD PER 1 MILLION TOKENS)\n  let price = SAFE_PRICES[userModel];\n  \n  // TRY TO FETCH DYNAMIC PRICE FROM DB (model_prices table)\n  try {\n      const dbPrice = await env.DB.prepare(\"SELECT input_price, output_price, profit_multiplier FROM model_prices WHERE model_name = ? AND active = 1\").bind(userModel).first();\n      if (dbPrice) {\n          price = {\n              input: Number(dbPrice.input_price),\n              output: Number(dbPrice.output_price)\n          };\n          // Optional: We could use specific profit multiplier from model_prices too, but global config is safer for now\n          // to match user expectation of \"Global Profit Margin\"\n          console.log(`[Pricing] Using DB Price for ${userModel}: Input $${price.input}, Output $${price.output}`);\n      }\n  } catch (e) {\n      console.warn(`[Pricing] Failed to fetch DB price for ${userModel}, using safe fallback.`, e);\n  }\n\n  if (!price) {\n      // Try to find by partial match or fallback\n      if (userModel.includes(\"flash-lite\") || userModel.includes(\"8b\")) price = SAFE_PRICES[\"gemini-2.0-flash-lite\"];\n      else if (userModel.includes(\"flash\")) price = SAFE_PRICES[\"gemini-2.0-flash\"];\n      else if (userModel.includes(\"mini\")) price = SAFE_PRICES[\"gpt-4o-mini\"];\n      else if (userModel.includes(\"pro\")) price = SAFE_PRICES[\"gemini-1.5-pro\"];\n      else if (userModel.includes(\"gpt-4o\")) price = SAFE_PRICES[\"gpt-4o\"];\n      else price = SAFE_PRICES[\"default\"];\n      \n      console.warn(`[Pricing] Model '${userModel}' not found in safe list. Using fallback price: Input $${price.input}/1M`);\n  }\n\n  // 2. CALCULATE RAW COST (USD)\n  // Formula: (Tokens / 1,000,000) * Price_Per_1M\n  const inputCostUSD = (inputTokens / 1_000_000) * price.input;\n  const outputCostUSD = (outputTokens / 1_000_000) * price.output;\n  const rawCostUSD = inputCostUSD + outputCostUSD;\n\n  // 3. APPLY PROFIT MARGIN (Configurable)\n  // Fetch profit margin from DB or use default 60%\n  let profitMarginPercent = 60;\n  try {\n      const config = await env.DB.prepare(\"SELECT value FROM app_config WHERE key = 'profit_margin_percent'\").first();\n      if (config && config.value) {\n          profitMarginPercent = Number(config.value);\n      }\n  } catch (e) {\n      console.warn(\"[TokenCalc] Failed to fetch profit margin, using default 60%\", e);\n  }\n\n  // Multiplier = 1 + (Percent / 100)\n  // e.g. 60% -> 1.6\n  const PROFIT_MULTIPLIER = 1 + (profitMarginPercent / 100);\n  const finalCostUSD = rawCostUSD * PROFIT_MULTIPLIER;\n\n  // 4. LOGGING FOR DEBUGGING\n  console.log(`[TokenCalc] Model: ${userModel}`);\n  console.log(`[TokenCalc] Usage: ${inputTokens} In / ${outputTokens} Out`);\n  console.log(`[TokenCalc] Base Price (1M): $${price.input} / $${price.output}`);\n  console.log(`[TokenCalc] Raw Cost: $${rawCostUSD.toFixed(8)}`);\n  console.log(`[TokenCalc] Profit Margin: ${profitMarginPercent}% (x${PROFIT_MULTIPLIER})`);\n  console.log(`[TokenCalc] Final Cost: $${finalCostUSD.toFixed(8)}`);\n\n  return finalCostUSD;\n}\n\nexport async function recordTokenUsage(userId: number, userModel: string, actualModelUsed: string, inputTokens: number, outputTokens: number, cost: number, env: Env) {\n    try {\n        await env.DB.prepare(\"INSERT INTO history (user_id, model, input_tokens, output_tokens, cost) VALUES (?, ?, ?, ?, ?)\")\n            .bind(userId, userModel, inputTokens, outputTokens, cost)\n            .run();\n    } catch (e) {\n        console.error(\"Failed to record history:\", e);\n    }\n}\n\n// Deprecated but kept for compatibility if imported elsewhere\nexport async function getModelPrice(modelName: string, env: Env) {\n    let profit = 60;\n    try {\n        const config = await env.DB.prepare(\"SELECT value FROM app_config WHERE key = 'profit_margin_percent'\").first();\n        if (config) profit = Number(config.value);\n    } catch {}\n    \n    return {\n        input_price: SAFE_PRICES[modelName]?.input || 0.1,\n        output_price: SAFE_PRICES[modelName]?.output || 0.4,\n        profit_multiplier: 1 + (profit/100)\n    };\n}\n", "import { getExchangeRate } from './currency';\nimport { Env } from '../types';\n\n// Konfigurasi Rate dan Bonus\n\n// IDR: 1000 IDR = 1000 Token (Ratio 1:1)\n// UPDATE DEC 2025: Agar user merasa \"banyak\", kita kalikan 1000\n// $1 = 16,000 IDR\n// Harga Modal 1M Token (Lite) = $0.04 = Rp 640\n// Harga Jual 1M Token (Profit 60%) = $0.064 = Rp 1,024\n// Jadi 1 Rupiah dapat = 1,000,000 / 1,024 = ~976 Token\n// Kita bulatkan: 1 Rupiah = 1000 Token agar marketing mudah\nexport const TOKEN_RATE_IDR = 1; // 1 IDR = 1 Credit\nexport const TOKEN_RATE_IDR_TO_CREDIT = 1; // 1 Rupiah = 1 Credit\n\n// USD: 1 USD = 16,300 Credit (Fixed Rate)\nexport const TOKEN_RATE_USD_TO_CREDIT = 16300;\n\nexport const BONUS_IDR_TABLE: Record<number, number> = {\n  100000: 3,  // Topup 100k -> Bonus 3%\n  200000: 5, // Topup 200k -> Bonus 5%\n  500000: 10  // Topup 500k -> Bonus 10%\n};\n\nexport const BONUS_USD_TABLE: Record<number, number> = {\n  10: 3,  // $10 -> Bonus 3%\n  20: 5, // $20 -> Bonus 5%\n  50: 10  // $50 -> Bonus 10%\n};\n\n// Legacy compatibility\nexport const TOKEN_RATE = TOKEN_RATE_IDR_TO_CREDIT;\nexport const BONUS_TABLE = BONUS_IDR_TABLE;\n\nexport async function getLiveUsdRate(env?: Env): Promise<number> {\n    // 1. Try to get from DB Config (Dynamic)\n    if (env) {\n        try {\n            const config = await env.DB.prepare(\"SELECT value FROM app_config WHERE key = 'usd_idr_rate'\").first();\n            if (config && config.value) {\n                return Number(config.value);\n            }\n        } catch (e) {\n            console.warn(\"[TokenTopup] Failed to fetch usd_idr_rate, using default\", e);\n        }\n    }\n    \n    // 2. Default Fixed Rate\n    return 16300;\n}\n\nexport function getTokenAmount(amountRp: number) {\n  return getTokenFromIDR(amountRp);\n}\n\n/**\n * Calculate tokens from IDR\n */\nexport function getTokenFromIDR(amountRp: number, rate: number = TOKEN_RATE_IDR_TO_CREDIT, bonusTable: Record<number, number> = BONUS_IDR_TABLE) {\n  const tokensBase = Math.floor(amountRp * rate); // FIX: Multiply by rate (1), not divide\n  const bonusPercent = getBonusPercent(amountRp, bonusTable);\n  \n  const tokensBonus = Math.floor(tokensBase * (bonusPercent / 100));\n  const totalTokens = tokensBase + tokensBonus;\n  \n  return {\n    amount: amountRp,\n    currency: 'IDR',\n    tokensBase,\n    bonusPercent,\n    tokensBonus,\n    totalTokens\n  };\n}\n\n/**\n * Calculate tokens from USD\n */\nexport function getTokenFromUSD(amountUsd: number, rate: number = TOKEN_RATE_USD_TO_CREDIT, bonusTable: Record<number, number> = BONUS_USD_TABLE) {\n  const tokensBase = Math.floor(amountUsd * rate);\n  const bonusPercent = getBonusPercent(amountUsd, bonusTable);\n  \n  const tokensBonus = Math.floor(tokensBase * (bonusPercent / 100));\n  const totalTokens = tokensBase + tokensBonus;\n  \n  return {\n    amount: amountUsd,\n    currency: 'USD',\n    tokensBase,\n    bonusPercent,\n    tokensBonus,\n    totalTokens\n  };\n}\n\nfunction getBonusPercent(amount: number, table: Record<number, number>): number {\n    const thresholds = Object.keys(table).map(Number).sort((a, b) => b - a);\n    for (const threshold of thresholds) {\n        if (amount >= threshold) {\n            return table[threshold];\n        }\n    }\n    return 0;\n}\n", "import { Env } from '../types';\nimport { getAllModelPrices } from './tokenCostManager';\n\nexport async function getFallbackChain(userModel: string, env: Env): Promise<string[]> {\n  // STRICT MODE: Fallback disabled per user request.\n  // The system will only attempt the requested model.\n  return [userModel];\n}\n", "\nfunction pemToBinary(pem: string): Uint8Array {\n  const base64 = pem.replace(/-----(BEGIN|END) PRIVATE KEY-----/g, \"\").replace(/\\s/g, \"\");\n  const binaryString = atob(base64);\n  const bytes = new Uint8Array(binaryString.length);\n  for (let i = 0; i < binaryString.length; i++) {\n    bytes[i] = binaryString.charCodeAt(i);\n  }\n  return bytes;\n}\n\nasync function importPrivateKey(pem: string): Promise<CryptoKey> {\n  const binaryDer = pemToBinary(pem);\n  return await crypto.subtle.importKey(\n    \"pkcs8\",\n    binaryDer,\n    {\n      name: \"RSASSA-PKCS1-v1_5\",\n      hash: \"SHA-256\",\n    },\n    false,\n    [\"sign\"]\n  );\n}\n\nfunction arrayBufferToBase64Url(buffer: ArrayBuffer | Uint8Array): string {\n  let binary = \"\";\n  const bytes = buffer instanceof Uint8Array ? buffer : new Uint8Array(buffer);\n  const len = bytes.byteLength;\n  for (let i = 0; i < len; i++) {\n    binary += String.fromCharCode(bytes[i]);\n  }\n  return btoa(binary)\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\")\n    .replace(/=+$/, \"\");\n}\n\nexport async function getGoogleAccessToken(\n  clientEmail: string,\n  privateKey: string,\n  scopes: string[] = [\"https://www.googleapis.com/auth/cloud-platform\"]\n): Promise<string> {\n  const now = Math.floor(Date.now() / 1000);\n  const exp = now + 3600; // 1 hour expiration\n\n  const header = {\n    alg: \"RS256\",\n    typ: \"JWT\",\n  };\n\n  const claimSet = {\n    iss: clientEmail,\n    scope: scopes.join(\" \"),\n    aud: \"https://oauth2.googleapis.com/token\",\n    exp: exp,\n    iat: now,\n  };\n\n  const encodedHeader = arrayBufferToBase64Url(\n    new TextEncoder().encode(JSON.stringify(header))\n  );\n  const encodedClaimSet = arrayBufferToBase64Url(\n    new TextEncoder().encode(JSON.stringify(claimSet))\n  );\n\n  const unsignedToken = `${encodedHeader}.${encodedClaimSet}`;\n\n  const key = await importPrivateKey(privateKey);\n  const signature = await crypto.subtle.sign(\n    \"RSASSA-PKCS1-v1_5\",\n    key,\n    new TextEncoder().encode(unsignedToken)\n  );\n\n  const encodedSignature = arrayBufferToBase64Url(signature);\n  const jwt = `${unsignedToken}.${encodedSignature}`;\n\n  // Exchange JWT for Access Token\n  const response = await fetch(\"https://oauth2.googleapis.com/token\", {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/x-www-form-urlencoded\",\n    },\n    body: new URLSearchParams({\n      grant_type: \"urn:ietf:params:oauth:grant-type:jwt-bearer\",\n      assertion: jwt,\n    }),\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(`Failed to get access token: ${errorText}`);\n  }\n\n  const data: any = await response.json();\n  return data.access_token;\n}\n", "import { Env } from '../index';\nimport { getLiveUsdRate } from '../utils/tokenTopup';\n\nexport async function handleBalance(userId: number, env: Env) {\n  const user = await env.DB.prepare(\"SELECT tokens FROM users WHERE id = ?\").bind(userId).first();\n  const rate = await getLiveUsdRate(env);\n  return Response.json({ balance: user?.tokens || 0, usd_rate: rate });\n}\n\nexport async function handleHistory(userId: number, env: Env) {\n  const history = await env.DB.prepare(\"SELECT * FROM history WHERE user_id = ? ORDER BY timestamp DESC LIMIT 20\").bind(userId).all();\n  return Response.json(history.results);\n}\n\nexport async function handleTopup(req: Request, userId: number, env: Env) {\n  // Disini Anda bisa integrasi Xendit/Midtrans/Stripe\n  // Untuk sekarang, kita buat simulasi topup manual/admin key\n  const body: any = await req.json();\n  const { amount, secret_admin_key } = body;\n\n  // Simple security check (Hardcoded for simplicity, use ENV in production)\n  if (secret_admin_key !== \"RAHASIA_ADMIN_TOPUP\") {\n    return Response.json({ error: \"Unauthorized topup\" }, { status: 403 });\n  }\n\n  await env.DB.prepare(\"UPDATE users SET tokens = tokens + ? WHERE id = ?\").bind(amount, userId).run();\n  return Response.json({ success: true, message: `Added ${amount} tokens` });\n}\n", "import { Env } from '../types';\n\nexport async function handleAdminModelPrices(req: Request, env: Env) {\n  const url = new URL(req.url);\n  const method = req.method;\n  const pathParts = url.pathname.split('/');\n  // /admin/model-prices/:id -> [\"\", \"admin\", \"model-prices\", \"123\"]\n  const id = pathParts[3];\n\n  if (method === 'GET') {\n    // List all\n    const results = await env.DB.prepare(\"SELECT * FROM model_prices ORDER BY fallback_priority ASC\").all();\n    return Response.json(results.results);\n  }\n\n  if (method === 'POST') {\n    // Add new\n    const body: any = await req.json();\n    const { provider, model_name, input_price, output_price, profit_multiplier, active, fallback_priority } = body;\n    \n    try {\n      await env.DB.prepare(`\n        INSERT INTO model_prices (provider, model_name, input_price, output_price, profit_multiplier, active, fallback_priority)\n        VALUES (?, ?, ?, ?, ?, ?, ?)\n      `)\n      .bind(provider, model_name, input_price, output_price, profit_multiplier || 1.5, active !== undefined ? active : 1, fallback_priority || 1)\n      .run();\n      return Response.json({ success: true });\n    } catch (e: any) {\n      return Response.json({ error: e.message }, { status: 500 });\n    }\n  }\n\n  if (method === 'PUT' && id) {\n    // Edit existing\n    const body: any = await req.json();\n    const { provider, model_name, input_price, output_price, profit_multiplier, active, fallback_priority } = body;\n    \n    try {\n      // Dynamic update query builder would be better, but fixed for now\n      await env.DB.prepare(`\n        UPDATE model_prices \n        SET provider = ?, model_name = ?, input_price = ?, output_price = ?, profit_multiplier = ?, active = ?, fallback_priority = ?\n        WHERE id = ?\n      `)\n      .bind(provider, model_name, input_price, output_price, profit_multiplier, active, fallback_priority, id)\n      .run();\n      return Response.json({ success: true });\n    } catch (e: any) {\n       return Response.json({ error: e.message }, { status: 500 });\n    }\n  }\n\n  if (method === 'DELETE' && id) {\n    await env.DB.prepare(\"DELETE FROM model_prices WHERE id = ?\").bind(id).run();\n    return Response.json({ success: true });\n  }\n\n  return Response.json({ error: \"Method not allowed\" }, { status: 405 });\n}\n\nexport async function handleListUsers(request: Request, env: Env): Promise<Response> {\n    try {\n        const users = await env.DB.prepare(\"SELECT id, email, tokens, is_admin, created_at FROM users ORDER BY created_at DESC\").all();\n        return Response.json(users.results);\n    } catch (e: any) {\n        return Response.json({ error: e.message }, { status: 500 });\n    }\n}\n\nexport async function handleAdminConfig(request: Request, env: Env): Promise<Response> {\n  const method = request.method;\n\n  if (method === 'GET') {\n    const configs = await env.DB.prepare(\"SELECT * FROM app_config\").all();\n    const configMap: Record<string, any> = {};\n    configs.results.forEach((row: any) => {\n        try {\n            configMap[row.key] = JSON.parse(row.value);\n        } catch {\n            configMap[row.key] = row.value;\n        }\n    });\n    return Response.json(configMap);\n  }\n\n  if (method === 'POST') {\n    try {\n        const body = await request.json() as Record<string, any>;\n        \n        const batch = [];\n        \n        for (const [key, value] of Object.entries(body)) {\n            const valStr = typeof value === 'object' ? JSON.stringify(value) : String(value);\n            // Prepare a fresh statement for each item to avoid any bind reuse issues\n            batch.push(env.DB.prepare(\"INSERT OR REPLACE INTO app_config (key, value) VALUES (?, ?)\").bind(key, valStr));\n        }\n        \n        if (batch.length > 0) {\n            await env.DB.batch(batch);\n        }\n        \n        return Response.json({ success: true });\n    } catch (e: any) {\n        return Response.json({ error: e.message }, { status: 500 });\n    }\n  }\n\n  return Response.json({ error: \"Method not allowed\" }, { status: 405 });\n}\n", "import { Env } from '../types';\n\nexport async function handleUserUsage(req: Request, env: Env) {\n  const url = new URL(req.url);\n  // /admin/users/:id/usage -> [\"\", \"admin\", \"users\", \"123\", \"usage\"]\n  const pathParts = url.pathname.split('/');\n  const userId = pathParts[3];\n\n  if (!userId) {\n    return Response.json({ error: \"User ID required\" }, { status: 400 });\n  }\n\n  try {\n    const results = await env.DB.prepare(`\n      SELECT \n        date(timestamp, 'unixepoch') as day, \n        SUM(input_tokens) as total_input, \n        SUM(output_tokens) as total_output, \n        SUM(cost) as total_cost,\n        COUNT(*) as request_count\n      FROM history \n      WHERE user_id = ? \n      GROUP BY day \n      ORDER BY day DESC\n    `).bind(userId).all();\n\n    return Response.json(results.results);\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\nexport async function handleExportUsageCsv(req: Request, env: Env) {\n  try {\n    const results = await env.DB.prepare(`\n      SELECT \n        u.email,\n        u.id as user_id,\n        date(h.timestamp, 'unixepoch') as day,\n        SUM(h.input_tokens) as total_input,\n        SUM(h.output_tokens) as total_output,\n        SUM(h.cost) as total_cost,\n        COUNT(h.id) as request_count\n      FROM history h\n      JOIN users u ON h.user_id = u.id\n      GROUP BY u.id, day\n      ORDER BY day DESC, u.email ASC\n    `).all();\n\n    // Generate CSV\n    const rows = results.results as any[];\n    const headers = [\"Date\", \"User Email\", \"User ID\", \"Input Tokens\", \"Output Tokens\", \"Total Cost ($)\", \"Requests\"];\n    \n    let csv = headers.join(\",\") + \"\\n\";\n    \n    for (const row of rows) {\n      csv += [\n        row.day,\n        row.email,\n        row.user_id,\n        row.total_input || 0,\n        row.total_output || 0,\n        (row.total_cost || 0).toFixed(6), // Cost is small usually\n        row.request_count\n      ].join(\",\") + \"\\n\";\n    }\n\n    return new Response(csv, {\n      headers: {\n        \"Content-Type\": \"text/csv\",\n        \"Content-Disposition\": \"attachment; filename=user_usage_report.csv\"\n      }\n    });\n\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n", "\nimport { Env } from '../types';\n\n// Admin: List Vouchers\nexport async function handleListVouchers(req: Request, env: Env) {\n  const vouchers = await env.DB.prepare(\"SELECT * FROM vouchers ORDER BY created_at DESC\").all();\n  return Response.json(vouchers.results);\n}\n\n// Admin: Create Voucher\nexport async function handleCreateVoucher(req: Request, env: Env) {\n  const body: any = await req.json();\n  const { code, amount, max_usage, expires_at, allowed_emails } = body;\n\n  if (!code || !amount) {\n    return Response.json({ error: \"Missing required fields\" }, { status: 400 });\n  }\n\n  try {\n    // allowed_emails: \"email1@a.com, email2@b.com\" -> store as string\n    await env.DB.prepare(\n      \"INSERT INTO vouchers (code, amount, max_usage, current_usage, expires_at, allowed_emails, created_at) VALUES (?, ?, ?, 0, ?, ?, ?)\"\n    ).bind(\n      code.toUpperCase(), \n      amount, \n      max_usage || 0, \n      expires_at || null, \n      allowed_emails || null, \n      new Date().toISOString()\n    ).run();\n\n    return Response.json({ success: true, message: \"Voucher created\" });\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\n// Admin: Delete Voucher\nexport async function handleDeleteVoucher(req: Request, env: Env) {\n  const body: any = await req.json();\n  const { id } = body;\n  await env.DB.prepare(\"DELETE FROM vouchers WHERE id = ?\").bind(id).run();\n  return Response.json({ success: true });\n}\n\n// User: Redeem (Updated)\nexport async function handleRedeemVoucher(req: Request, env: Env) {\n  const body: any = await req.json();\n  const { userId, code, deviceHash } = body;\n\n  if (!userId || !code || !deviceHash) {\n    return Response.json({ error: \"Missing required fields\" }, { status: 400 });\n  }\n\n  const voucherCode = code.toUpperCase().trim();\n\n  // 1. Check Voucher Validity\n  const voucher = await env.DB.prepare(\"SELECT * FROM vouchers WHERE code = ?\").bind(voucherCode).first();\n  if (!voucher) {\n    return Response.json({ error: \"Invalid voucher code\" }, { status: 404 });\n  }\n\n  // Check Expiry\n  if (voucher.expires_at) {\n      const now = new Date();\n      const expiry = new Date(voucher.expires_at as string);\n      if (now > expiry) {\n          return Response.json({ error: \"Voucher has expired\" }, { status: 410 });\n      }\n  }\n\n  // Check Usage Limit\n  const maxUsage = voucher.max_usage as number;\n  const currentUsage = voucher.current_usage as number;\n  if (maxUsage > 0 && currentUsage >= maxUsage) {\n    return Response.json({ error: \"Voucher fully redeemed\" }, { status: 410 });\n  }\n\n  // Check Whitelist (Allowed Emails)\n  if (voucher.allowed_emails) {\n      const allowedList = (voucher.allowed_emails as string).split(',').map(s => s.trim().toLowerCase());\n      // Need user email. Get from DB or Token (if passed in context, but here we only have userId in body)\n      // We should fetch user email from DB to be safe\n      const user = await env.DB.prepare(\"SELECT email FROM users WHERE id = ?\").bind(userId).first();\n      if (!user || !allowedList.includes((user.email as string).toLowerCase())) {\n          return Response.json({ error: \"This voucher is not valid for your account\" }, { status: 403 });\n      }\n  }\n\n  // 2. Check if USER already claimed THIS voucher\n  const userClaim = await env.DB.prepare(\"SELECT * FROM voucher_claims WHERE user_id = ? AND voucher_code = ?\")\n    .bind(userId, voucherCode).first();\n  \n  if (userClaim) {\n    return Response.json({ error: \"You have already redeemed this voucher\" }, { status: 409 });\n  }\n\n  // 3. Check if DEVICE already claimed THIS voucher (Anti-Tuyul)\n  const deviceClaim = await env.DB.prepare(\"SELECT * FROM voucher_claims WHERE device_hash = ? AND voucher_code = ?\")\n    .bind(deviceHash, voucherCode).first();\n\n  if (deviceClaim) {\n    return Response.json({ error: \"This device has already redeemed this voucher code\" }, { status: 403 });\n  }\n\n  // 4. EXECUTE REDEMPTION (Atomic Transaction using Batch)\n  try {\n    const stmts = [\n        // A. Add Tokens to User\n        env.DB.prepare(\"UPDATE users SET tokens = tokens + ? WHERE id = ?\").bind(voucher.amount, userId),\n        // B. Record Claim\n        env.DB.prepare(\"INSERT INTO voucher_claims (user_id, voucher_code, device_hash) VALUES (?, ?, ?)\").bind(userId, voucherCode, deviceHash),\n        // C. Increment Usage\n        env.DB.prepare(\"UPDATE vouchers SET current_usage = current_usage + 1 WHERE code = ?\").bind(voucherCode)\n    ];\n\n    await env.DB.batch(stmts);\n\n    return Response.json({ \n        success: true, \n        message: `Voucher redeemed! ${voucher.amount} tokens added.`,\n        amount_added: voucher.amount \n    });\n\n  } catch (e: any) {\n    console.error(\"Voucher Redeem Error:\", e);\n    // If batch fails, none of the changes are applied (D1 batch is atomic)\n    return Response.json({ error: \"Failed to redeem voucher. Please try again.\" }, { status: 500 });\n  }\n}\n", "import { Env } from '../types';\nimport { addUserTokens } from '../utils/userToken';\nimport { sendEmail, getManualApproveTemplate } from '../utils/email';\n\n// 1. GET /admin/topup/list\nexport async function listTopups(request: Request, env: Env): Promise<Response> {\n  const url = new URL(request.url);\n  const page = parseInt(url.searchParams.get('page') || '1');\n  const limit = parseInt(url.searchParams.get('limit') || '20');\n  const offset = (page - 1) * limit;\n\n  // Filter Params\n  const method = url.searchParams.get('method') || null;\n  const status = url.searchParams.get('status') || null;\n  const search = url.searchParams.get('search') || null; // email or user_id\n  \n  // Date Range (Default to full range if not provided)\n  const dateFrom = url.searchParams.get('date_from') || '1970-01-01';\n  const dateTo = url.searchParams.get('date_to') || '2099-12-31';\n\n  // Helper to get total count with same filters\n  const countQuery = `\n    SELECT COUNT(*) as total \n    FROM topup_transactions t\n    LEFT JOIN users u ON CAST(u.id AS TEXT) = t.user_id \n    WHERE 1=1 \n      AND (t.method = ? OR ? IS NULL) \n      AND (t.status = ? OR ? IS NULL) \n      AND (u.email LIKE ? OR t.user_id = ? OR ? IS NULL) \n      AND (date(t.created_at) BETWEEN date(?) AND date(?))\n  `;\n\n  // Search param handling (if search provided, wrap with %)\n  const searchLike = search ? `%${search}%` : null;\n\n  // Params order: method, method, status, status, searchLike, search, search, dateFrom, dateTo\n  const bindParams = [\n    method, method, \n    status, status, \n    searchLike, search, search, \n    dateFrom, dateTo\n  ];\n\n  const countRes = await env.DB.prepare(countQuery).bind(...bindParams).first();\n  const total = countRes?.total as number || 0;\n  const pageCount = Math.ceil(total / limit);\n\n  // Main Data Query\n  const query = `\n    SELECT t.*, u.email as user_email, u.tokens as user_balance\n    FROM topup_transactions t \n    LEFT JOIN users u ON CAST(u.id AS TEXT) = t.user_id \n    WHERE 1=1 \n      AND (t.method = ? OR ? IS NULL) \n      AND (t.status = ? OR ? IS NULL) \n      AND (u.email LIKE ? OR t.user_id = ? OR ? IS NULL) \n      AND (date(t.created_at) BETWEEN date(?) AND date(?))\n    ORDER BY t.created_at DESC \n    LIMIT ? OFFSET ?\n  `;\n  \n  const results = await env.DB.prepare(query).bind(...bindParams, limit, offset).all();\n\n  return Response.json({\n    total,\n    page,\n    page_count: pageCount,\n    transactions: results.results\n  });\n}\n\n// 2. GET /admin/topup/detail/:id\nexport async function getTopupDetail(request: Request, env: Env): Promise<Response> {\n  const url = new URL(request.url);\n  const id = url.pathname.split('/').pop(); // Assumes /admin/topup/detail/:id\n\n  if (!id) return Response.json({ error: \"Missing ID\" }, { status: 400 });\n\n  const query = `\n    SELECT t.*, u.email, u.tokens as current_balance\n    FROM topup_transactions t \n    LEFT JOIN users u ON t.user_id = CAST(u.id AS TEXT)\n    WHERE t.id = ?\n  `;\n\n  const transaction = await env.DB.prepare(query).bind(id).first();\n\n  if (!transaction) return Response.json({ error: \"Transaction not found\" }, { status: 404 });\n\n  return Response.json(transaction);\n}\n\n// 3. POST /admin/topup/manual-approve\nexport async function manualApproveTopup(request: Request, env: Env, adminId: string = \"SYSTEM\"): Promise<Response> {\n  try {\n    const { id } = await request.json() as { id: number | string };\n    if (!id) return Response.json({ error: \"Missing ID\" }, { status: 400 });\n\n    const transaction = await env.DB.prepare(\"SELECT * FROM topup_transactions WHERE id = ?\").bind(id).first();\n\n    if (!transaction) return Response.json({ error: \"Transaction not found\" }, { status: 404 });\n    if (transaction.status !== 'pending') return Response.json({ error: \"Transaction is not pending\" }, { status: 400 });\n\n    // Update Status\n    await env.DB.prepare(\"UPDATE topup_transactions SET status = 'paid' WHERE id = ?\").bind(id).run();\n\n    // Add Tokens\n    const tokensAdded = transaction.tokens_added as number;\n    await addUserTokens(transaction.user_id as string, tokensAdded, env);\n\n    // Send Email\n    const user = await env.DB.prepare(\"SELECT email FROM users WHERE id = ?\").bind(transaction.user_id).first() as { email: string } | null;\n    if (user && user.email) {\n        const currency = transaction.method === 'paypal' ? 'USD' : 'IDR';\n        const amount = transaction.method === 'paypal' ? transaction.amount_usd : transaction.amount_rp;\n        const name = user.email.split('@')[0]; // Simple name extraction\n        const html = getManualApproveTemplate(name, amount as number, tokensAdded, currency);\n        sendEmail(user.email as string, \"Top-Up Token Anda Berhasil (Manual Approval)\", html, env);\n    }\n\n    // Log Action\n    await env.DB.prepare(\"INSERT INTO admin_logs (admin_id, action, target_id) VALUES (?, ?, ?)\").bind(adminId, 'manual_approve', id).run();\n\n    return Response.json({ success: true });\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\n// 4. POST /admin/topup/delete\nexport async function deleteTopup(request: Request, env: Env, adminId: string = \"SYSTEM\"): Promise<Response> {\n  try {\n    const { id } = await request.json() as { id: number | string };\n    if (!id) return Response.json({ error: \"Missing ID\" }, { status: 400 });\n\n    const transaction = await env.DB.prepare(\"SELECT status FROM topup_transactions WHERE id = ?\").bind(id).first();\n    \n    if (!transaction) return Response.json({ error: \"Transaction not found\" }, { status: 404 });\n    if (transaction.status === 'paid') return Response.json({ error: \"Cannot delete PAID transaction\" }, { status: 400 });\n\n    await env.DB.prepare(\"DELETE FROM topup_transactions WHERE id = ?\").bind(id).run();\n\n    // Log Action\n    await env.DB.prepare(\"INSERT INTO admin_logs (admin_id, action, target_id) VALUES (?, ?, ?)\").bind(adminId, 'delete_transaction', id).run();\n\n    return Response.json({ success: true });\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\n// 5. GET /admin/topup/statistics\nexport async function getTopupStatistics(_request: Request, env: Env): Promise<Response> {\n  // Overall Stats\n  const totalStats = await env.DB.prepare(`\n    SELECT \n      COUNT(*) as total_transactions,\n      SUM(amount_rp) as total_rp,\n      SUM(amount_usd) as total_usd,\n      SUM(tokens_added) as total_tokens_given\n    FROM topup_transactions\n    WHERE status = 'paid'\n  `).first();\n\n  // Top Methods\n  const methods = await env.DB.prepare(`\n    SELECT method, COUNT(*) as count \n    FROM topup_transactions \n    WHERE status = 'paid' \n    GROUP BY method\n  `).all();\n\n  const top_methods: Record<string, number> = {};\n  methods.results.forEach((r: any) => top_methods[r.method] = r.count);\n\n  // Time Series (Daily Statistics as requested)\n  // SELECT DATE(created_at) AS day, COUNT(*) AS count, SUM(amount_rp) AS total_rp, SUM(amount_usd) AS total_usd, SUM(tokens_added) AS total_tokens ...\n  const dailyStats = await env.DB.prepare(`\n    SELECT \n      DATE(created_at) as day,\n      COUNT(*) as count,\n      SUM(amount_rp) as total_rp,\n      SUM(amount_usd) as total_usd,\n      SUM(tokens_added) as total_tokens\n    FROM topup_transactions\n    WHERE status = 'paid'\n    GROUP BY day\n    ORDER BY day DESC\n  `).all();\n\n  return Response.json({\n    total_transactions: totalStats?.total_transactions || 0,\n    total_rp: totalStats?.total_rp || 0,\n    total_usd: totalStats?.total_usd || 0,\n    total_tokens_given: totalStats?.total_tokens_given || 0,\n    top_methods,\n    daily_stats: dailyStats.results // Changed key to daily_stats to be explicit\n  });\n}\n\n// 6. GET /admin/topup/export-csv\nexport async function exportTopupCsv(_request: Request, env: Env): Promise<Response> {\n  // Dump all paid transactions (or all?) - User said \"export-csv\", usually implies full data dump.\n  // Let's dump everything including pending/failed so admin can analyze.\n  const query = `\n    SELECT t.id, t.user_id, u.email, t.amount_rp, t.amount_usd, t.tokens_added, t.method, t.status, t.payment_ref, t.created_at\n    FROM topup_transactions t\n    LEFT JOIN users u ON t.user_id = CAST(u.id AS TEXT)\n    ORDER BY t.created_at DESC\n  `;\n  \n  const results = await env.DB.prepare(query).all();\n  \n  // Build CSV\n  const header = \"id,user_id,user_email,amount_rp,amount_usd,tokens_added,method,status,payment_ref,created_at\\n\";\n  const rows = results.results.map((r: any) => {\n    return [\n      r.id,\n      r.user_id,\n      r.email || '',\n      r.amount_rp || 0,\n      r.amount_usd || 0,\n      r.tokens_added,\n      r.method,\n      r.status,\n      r.payment_ref || '',\n      r.created_at\n    ].join(',');\n  }).join('\\n');\n\n  return new Response(header + rows, {\n    headers: {\n      \"Content-Type\": \"text/csv\",\n      \"Content-Disposition\": \"attachment; filename=topup_transactions.csv\"\n    }\n  });\n}\n", "import { Env } from '../types';\n\n/**\n * Menambah token ke saldo user secara atomic\n * @param userId ID User\n * @param tokens Jumlah token yang ditambahkan\n * @param env Environment variables\n */\nexport async function addUserTokens(userId: string, tokens: number, env: Env): Promise<number> {\n    const res = await env.DB.prepare(\"UPDATE users SET tokens = tokens + ? WHERE id = ? RETURNING tokens\")\n        .bind(tokens, userId)\n        .first();\n    return (res?.tokens as number) || 0;\n}\n", "import { Env } from '../types';\nimport { getTokenFromUSD, getTokenFromIDR } from '../utils/tokenTopup';\nimport { addUserTokens } from '../utils/userToken';\nimport { sendEmail, getTopupSuccessTemplate } from '../utils/email';\n\n// --- PAYPAL HANDLERS (USD) ---\n\nexport async function createPaypalPayment(request: Request, env: Env): Promise<Response> {\n  try {\n    // amount here implies USD\n    const { amount, userId } = await request.json() as { amount: number, userId: string };\n    \n    if (!amount || !userId) {\n      return Response.json({ error: \"Missing amount or userId\" }, { status: 400 });\n    }\n\n    // 1. Fetch Config from DB for Dynamic Rate/Bonus\n    const configRows = await env.DB.prepare(\"SELECT * FROM app_config WHERE key IN ('usd_idr_rate', 'TOKEN_RATE_USD', 'BONUS_USD_TABLE')\").all();\n    let rateUsd: number | undefined;\n    let bonusTable: any | undefined;\n    \n    configRows.results.forEach((row: any) => {\n        if (row.key === 'usd_idr_rate') rateUsd = parseFloat(row.value);\n        if (row.key === 'BONUS_USD_TABLE') {\n            try { bonusTable = JSON.parse(row.value); } catch {}\n        }\n    });\n\n    // Default to 16300 if not set (Ignore old TOKEN_RATE_USD which might be 16)\n    if (!rateUsd) rateUsd = 16300;\n\n    // 2. Hitung Token (USD)\n    const tokenCalc = getTokenFromUSD(amount, rateUsd, bonusTable);\n    \n    // 3. Buat Transaksi Pending di DB\n    const insertRes = await env.DB.prepare(\n      \"INSERT INTO topup_transactions (user_id, amount_usd, tokens_added, method, status) VALUES (?, ?, ?, ?, ?) RETURNING id\"\n    ).bind(userId, amount, tokenCalc.totalTokens, 'paypal', 'pending').first();\n    \n    const transactionId = insertRes?.id;\n\n    // 4. Panggil PayPal API (Real Implementation)\n    const clientId = env.PAYPAL_CLIENT_ID;\n    const clientSecret = env.PAYPAL_CLIENT_SECRET;\n    \n    if (!clientId || !clientSecret) {\n        throw new Error(\"PayPal Credentials missing in Server Config\");\n    }\n\n    const isLive = env.PAYPAL_MODE === 'live';\n    const baseUrl = isLive ? 'https://api-m.paypal.com' : 'https://api-m.sandbox.paypal.com';\n    const auth = btoa(`${clientId}:${clientSecret}`);\n\n    // 4.1. Get Access Token\n    const tokenRes = await fetch(`${baseUrl}/v1/oauth2/token`, {\n        method: 'POST',\n        headers: { \n            'Authorization': `Basic ${auth}`, \n            'Content-Type': 'application/x-www-form-urlencoded' \n        },\n        body: 'grant_type=client_credentials'\n    });\n\n    if (!tokenRes.ok) {\n        const err = await tokenRes.text();\n        console.error(\"PayPal Token Error:\", err);\n        throw new Error(\"Failed to authenticate with PayPal\");\n    }\n\n    const tokenData = await tokenRes.json() as any;\n    const accessToken = tokenData.access_token;\n\n    // 4.2. Create Order\n    const orderRes = await fetch(`${baseUrl}/v2/checkout/orders`, {\n        method: 'POST',\n        headers: { \n            'Authorization': `Bearer ${accessToken}`, \n            'Content-Type': 'application/json' \n        },\n        body: JSON.stringify({\n            intent: 'CAPTURE',\n            purchase_units: [{\n                reference_id: String(transactionId),\n                amount: { currency_code: 'USD', value: amount.toString() },\n                description: `TopUp ${tokenCalc.totalTokens} Tokens (Metabayn)`\n            }],\n            application_context: {\n                // Since this is a desktop app, we might rely on the user manually closing the browser or deep links.\n                // For now, we point to a simple success page or a generic one.\n                return_url: 'https://metabayn.com/payment/success', \n                cancel_url: 'https://metabayn.com/payment/cancel',\n                brand_name: 'Metabayn App',\n                user_action: 'PAY_NOW'\n            }\n        })\n    });\n\n    if (!orderRes.ok) {\n        const err = await orderRes.text();\n        console.error(\"PayPal Order Error:\", err);\n        throw new Error(\"Failed to create PayPal Order\");\n    }\n\n    const orderData = await orderRes.json() as any;\n    const approveLink = orderData.links.find((l: any) => l.rel === 'approve')?.href;\n    const paypalOrderId = orderData.id;\n\n    if (!approveLink) {\n        throw new Error(\"No approval link returned from PayPal\");\n    }\n    \n    // Update payment_ref\n    await env.DB.prepare(\"UPDATE topup_transactions SET payment_ref = ? WHERE id = ?\")\n      .bind(paypalOrderId, transactionId).run();\n\n    return Response.json({\n      status: \"success\",\n      transactionId,\n      tokensExpected: tokenCalc.totalTokens,\n      paymentUrl: approveLink,\n      debug_info: isLive ? \"Live Mode\" : \"Sandbox Mode\"\n    });\n\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\nexport async function checkPaypalStatus(request: Request, env: Env): Promise<Response> {\n  try {\n    const body = await request.json() as { transactionId: number | string };\n    const transactionId = body.transactionId;\n    if (!transactionId) return Response.json({ error: \"Missing transactionId\" }, { status: 400 });\n\n    // 1. Get Transaction from DB\n    const transaction = await env.DB.prepare(\"SELECT * FROM topup_transactions WHERE id = ?\").bind(transactionId).first();\n    if (!transaction) return Response.json({ error: \"Transaction not found\" }, { status: 404 });\n\n    if (transaction.status === 'paid') {\n        return Response.json({ status: 'paid', message: \"Already paid\" });\n    }\n\n    const orderId = transaction.payment_ref;\n    if (!orderId) return Response.json({ error: \"No PayPal Order ID found\" }, { status: 400 });\n\n    // 2. Auth PayPal\n    const clientId = env.PAYPAL_CLIENT_ID;\n    const clientSecret = env.PAYPAL_CLIENT_SECRET;\n    if (!clientId || !clientSecret) throw new Error(\"PayPal Credentials missing\");\n\n    const isLive = env.PAYPAL_MODE === 'live';\n    const baseUrl = isLive ? 'https://api-m.paypal.com' : 'https://api-m.sandbox.paypal.com';\n    const auth = btoa(`${clientId}:${clientSecret}`);\n\n    const tokenRes = await fetch(`${baseUrl}/v1/oauth2/token`, {\n        method: 'POST',\n        headers: { 'Authorization': `Basic ${auth}`, 'Content-Type': 'application/x-www-form-urlencoded' },\n        body: 'grant_type=client_credentials'\n    });\n    const tokenData = await tokenRes.json() as any;\n    const accessToken = tokenData.access_token;\n\n    // 3. Get Order Details\n    const orderRes = await fetch(`${baseUrl}/v2/checkout/orders/${orderId}`, {\n        method: 'GET',\n        headers: { 'Authorization': `Bearer ${accessToken}` }\n    });\n    \n    if (!orderRes.ok) throw new Error(\"Failed to fetch PayPal Order\");\n    \n    const orderData = await orderRes.json() as any;\n    const paypalStatus = orderData.status; // CREATED, APPROVED, COMPLETED\n\n    // 4. If APPROVED, Capture it!\n    if (paypalStatus === 'APPROVED') {\n        const captureRes = await fetch(`${baseUrl}/v2/checkout/orders/${orderId}/capture`, {\n            method: 'POST',\n            headers: { \n                'Authorization': `Bearer ${accessToken}`,\n                'Content-Type': 'application/json'\n            }\n        });\n        \n        if (!captureRes.ok) {\n             const errText = await captureRes.text();\n             console.error(\"Capture Failed:\", errText);\n             return Response.json({ status: 'pending', paypal_status: 'CAPTURE_FAILED' });\n        }\n        \n        const captureData = await captureRes.json() as any;\n        if (captureData.status === 'COMPLETED') {\n            // SUCCESS! Update DB\n            await env.DB.prepare(\"UPDATE topup_transactions SET status = 'paid' WHERE id = ?\").bind(transactionId).run();\n            await addUserTokens(transaction.user_id as string, transaction.tokens_added as number, env);\n            return Response.json({ status: 'paid', paypal_status: 'COMPLETED' });\n        }\n    } else if (paypalStatus === 'COMPLETED') {\n         // Already completed but DB not updated?\n         await env.DB.prepare(\"UPDATE topup_transactions SET status = 'paid' WHERE id = ?\").bind(transactionId).run();\n         // Check if tokens already added? (Ideally we should have idempotent logic in addUserTokens or check logs)\n         // For simplicity, we assume if status was not 'paid' in DB, we add tokens.\n         await addUserTokens(transaction.user_id as string, transaction.tokens_added as number, env);\n         return Response.json({ status: 'paid', paypal_status: 'COMPLETED' });\n    }\n\n    return Response.json({ status: transaction.status, paypal_status: paypalStatus });\n\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\nexport async function handlePaypalWebhook(request: Request, env: Env): Promise<Response> {\n  try {\n    // 1. SECURITY CHECK (Signature Verification)\n    // In production, you MUST verify the PayPal signature header to ensure the request comes from PayPal.\n    // See: https://developer.paypal.com/api/rest/webhooks/rest/#verify-webhook-signature\n    \n    // For now, we rely on the unique 'payment_ref' (Order ID) being present and in 'pending' status in our DB.\n    // An attacker cannot easily guess a valid, pending Order ID.\n    \n    const data = await request.json() as any;\n    \n    if (data.event_type === 'PAYMENT.CAPTURE.COMPLETED') {\n        const orderId = data.resource.id; // PayPal Order ID\n        const amountPaid = parseFloat(data.resource.amount.value); // Ensure we get actual paid amount\n        \n        // 3. Cari Transaksi\n        const transaction = await env.DB.prepare(\"SELECT * FROM topup_transactions WHERE payment_ref = ?\").bind(orderId).first();\n        \n        if (transaction && transaction.status === 'pending') {\n            // Verify amount logic (Optional but recommended)\n            // if (Math.abs(amountPaid - (transaction.amount_usd as number)) > 0.1) ...\n\n            // 4. Update Status & Tambah Token\n            await env.DB.prepare(\"UPDATE topup_transactions SET status = 'paid', amount_usd = ? WHERE id = ?\")\n                .bind(amountPaid, transaction.id).run();\n                \n            const newBalance = await addUserTokens(transaction.user_id as string, transaction.tokens_added as number, env);\n            \n            // 5. Kirim Email Notifikasi\n            const user = await env.DB.prepare(\"SELECT email FROM users WHERE id = ?\").bind(transaction.user_id).first();\n            if (user && user.email) {\n                // Template USD\n                const html = getTopupSuccessTemplate(amountPaid, transaction.tokens_added as number, 'USD');\n                sendEmail(user.email as string, \"Top Up Successful!\", html, env);\n            }\n\n            return Response.json({ \n                status: \"success\", \n                method: \"paypal\",\n                amount_usd: amountPaid,\n                tokens_added: transaction.tokens_added,\n                new_balance: newBalance\n            });\n        }\n    }\n    \n    return Response.json({ status: \"ignored\" });\n\n  } catch (e: any) {\n    console.error(\"PayPal Webhook Error:\", e);\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\n// --- QRIS HANDLERS (IDR) ---\n\nexport async function createQrisPayment(request: Request, env: Env): Promise<Response> {\n  try {\n    // amount here implies IDR\n    const { amount, userId } = await request.json() as { amount: number, userId: string };\n    \n    if (!amount || !userId) {\n      return Response.json({ error: \"Missing amount or userId\" }, { status: 400 });\n    }\n\n    // Fetch Config\n    const configRows = await env.DB.prepare(\"SELECT * FROM app_config WHERE key IN ('TOKEN_RATE_IDR', 'BONUS_IDR_TABLE')\").all();\n    let rateIdr: number | undefined;\n    let bonusTable: any | undefined;\n    \n    configRows.results.forEach((row: any) => {\n        if (row.key === 'TOKEN_RATE_IDR') rateIdr = parseFloat(row.value);\n        if (row.key === 'BONUS_IDR_TABLE') {\n            try { bonusTable = JSON.parse(row.value); } catch {}\n        }\n    });\n\n    const tokenCalc = getTokenFromIDR(amount, rateIdr, bonusTable);\n    \n    // Create Pending Transaction\n    const insertRes = await env.DB.prepare(\n      \"INSERT INTO topup_transactions (user_id, amount_rp, tokens_added, method, status) VALUES (?, ?, ?, ?, ?) RETURNING id\"\n    ).bind(userId, amount, tokenCalc.totalTokens, 'qris', 'pending').first();\n    \n    const transactionId = insertRes?.id;\n    const orderId = `metabayn-${transactionId}-${Date.now()}`; // Unique Order ID for Midtrans\n    \n    // 4. Call Midtrans API (Real Implementation)\n    const serverKey = env.MIDTRANS_SERVER_KEY;\n    const isProduction = env.MIDTRANS_IS_PRODUCTION === 'true';\n    const baseUrl = isProduction ? 'https://api.midtrans.com' : 'https://api.sandbox.midtrans.com';\n\n    if (!serverKey) {\n        throw new Error(\"Midtrans Server Key is missing\");\n    }\n\n    const auth = btoa(serverKey + ':');\n\n    const midtransRes = await fetch(`${baseUrl}/v2/charge`, {\n        method: 'POST',\n        headers: {\n            'Accept': 'application/json',\n            'Content-Type': 'application/json',\n            'Authorization': `Basic ${auth}`\n        },\n        body: JSON.stringify({\n            payment_type: 'qris',\n            transaction_details: {\n                order_id: orderId,\n                gross_amount: amount // Midtrans requires integer for IDR\n            },\n            qris: {\n                acquirer: 'gopay' // Optional, but good for testing\n            }\n        })\n    });\n\n    if (!midtransRes.ok) {\n        const err = await midtransRes.text();\n        console.error(\"Midtrans Error:\", err);\n        throw new Error(\"Failed to create QRIS transaction\");\n    }\n\n    const midtransData = await midtransRes.json() as any;\n    // actions: [{ name: 'generate-qr-code', url: '...' }]\n    // or sometimes qr_string is directly available depending on acquirer\n    \n    // Midtrans Core API for QRIS usually returns `actions` with a URL to the QR image\n    // OR sometimes a `qr_string` if using GoPay directly. \n    // Let's handle both.\n    \n    let qrString = midtransData.qr_string;\n    if (!qrString && midtransData.actions) {\n        const qrAction = midtransData.actions.find((a: any) => a.name === 'generate-qr-code');\n        if (qrAction) qrString = qrAction.url; // This is a URL to image, but frontend expects string to render or image URL?\n        // Frontend currently expects \"qrString\" to likely be raw string or URL.\n        // Let's assume frontend can handle image URL if we pass it.\n        // Wait, current frontend `TopUpModal.tsx` renders raw string as text and QR code.\n        // If it's a URL, we should probably display it as an image.\n        // For now, let's pass the URL as qrString. The frontend might need adjustment if it tries to generate QR from URL.\n        // Actually, Midtrans `qr_string` (if present) is the raw payload. \n        // If we get a URL, it's a hosted image.\n    }\n\n    // Fallback if no QR found (should not happen on success)\n    if (!qrString) {\n        // If using Snap, we would get a redirect_url. But here we use Core API.\n        // Maybe we should use Snap? Snap is easier for UI but we want embedded QR.\n        // Let's stick to Core API. If using Sandbox, sometimes it simulates.\n        qrString = \"https://placehold.co/200x200?text=QR+Error\"; \n    }\n\n    // Update ref\n    await env.DB.prepare(\"UPDATE topup_transactions SET payment_ref = ? WHERE id = ?\")\n      .bind(orderId, transactionId).run();\n\n    return Response.json({\n      status: \"success\",\n      transactionId,\n      tokensExpected: tokenCalc.totalTokens,\n      qrString: qrString, \n      // If it is a URL (starts with http), frontend should render <img src>\n      // If it is raw data, frontend should render <QRCode value>\n      isQrUrl: qrString.startsWith('http'), \n      debug_info: isProduction ? \"Production\" : \"Sandbox\"\n    });\n\n  } catch (e: any) {\n    console.error(\"QRIS Creation Error:\", e);\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\nexport async function checkQrisStatus(request: Request, env: Env): Promise<Response> {\n    try {\n        const body = await request.json() as { transactionId: number | string };\n        const transactionId = body.transactionId;\n        if (!transactionId) return Response.json({ error: \"Missing transactionId\" }, { status: 400 });\n\n        const transaction = await env.DB.prepare(\"SELECT * FROM topup_transactions WHERE id = ?\").bind(transactionId).first();\n        if (!transaction) return Response.json({ error: \"Transaction not found\" }, { status: 404 });\n\n        if (transaction.status === 'paid') return Response.json({ status: 'paid' });\n\n        const orderId = transaction.payment_ref;\n        if (!orderId) return Response.json({ error: \"No Order ID\" }, { status: 400 });\n\n        // Call Midtrans Status API\n        const serverKey = env.MIDTRANS_SERVER_KEY;\n        const isProduction = env.MIDTRANS_IS_PRODUCTION === 'true';\n        const baseUrl = isProduction ? 'https://api.midtrans.com' : 'https://api.sandbox.midtrans.com';\n        const auth = btoa(serverKey + ':');\n\n        const res = await fetch(`${baseUrl}/v2/${orderId}/status`, {\n            method: 'GET',\n            headers: { 'Accept': 'application/json', 'Authorization': `Basic ${auth}` }\n        });\n\n        if (!res.ok) return Response.json({ status: 'pending', midtrans_status: 'error' });\n\n        const data = await res.json() as any;\n        const transactionStatus = data.transaction_status; // settlement, capture, pending, deny, cancel, expire\n        const fraudStatus = data.fraud_status;\n\n        let isPaid = false;\n        if (transactionStatus === 'capture') {\n            if (fraudStatus === 'challenge') {\n                // Manual challenge\n            } else if (fraudStatus === 'accept') {\n                isPaid = true;\n            }\n        } else if (transactionStatus === 'settlement') {\n            isPaid = true;\n        }\n\n        if (isPaid) {\n            await env.DB.prepare(\"UPDATE topup_transactions SET status = 'paid' WHERE id = ?\").bind(transactionId).run();\n            await addUserTokens(transaction.user_id as string, transaction.tokens_added as number, env);\n            return Response.json({ status: 'paid' });\n        }\n\n        return Response.json({ status: 'pending', midtrans_status: transactionStatus });\n\n    } catch (e: any) {\n        return Response.json({ error: e.message }, { status: 500 });\n    }\n}\n\nexport async function handleQrisCallback(request: Request, env: Env): Promise<Response> {\n  try {\n    const data = await request.json() as any;\n    // Midtrans sends notification\n    const orderId = data.order_id;\n    const transactionStatus = data.transaction_status;\n    const fraudStatus = data.fraud_status;\n\n    if (!orderId) return Response.json({ error: \"No Order ID\" }, { status: 400 });\n\n    const transaction = await env.DB.prepare(\"SELECT * FROM topup_transactions WHERE payment_ref = ?\").bind(orderId).first();\n    if (!transaction || transaction.status === 'paid') return Response.json({ message: \"Ignored\" });\n\n    let isPaid = false;\n    if (transactionStatus === 'capture') {\n        if (fraudStatus === 'accept') isPaid = true;\n    } else if (transactionStatus === 'settlement') {\n        isPaid = true;\n    }\n\n    if (isPaid) {\n        await env.DB.prepare(\"UPDATE topup_transactions SET status = 'paid' WHERE id = ?\").bind(transaction.id).run();\n        await addUserTokens(transaction.user_id as string, transaction.tokens_added as number, env);\n        \n        // Email\n        const user = await env.DB.prepare(\"SELECT email FROM users WHERE id = ?\").bind(transaction.user_id).first();\n        if (user && user.email) {\n             const html = getTopupSuccessTemplate(transaction.amount_rp as number, transaction.tokens_added as number, 'IDR');\n             sendEmail(user.email as string, \"Top Up Successful!\", html, env);\n        }\n    }\n\n    return Response.json({ status: \"ok\" });\n  } catch (e) {\n    return Response.json({ error: \"Error\" }, { status: 500 });\n  }\n}\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n"],
  "mappings": "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",
  "names": ["content", "inputTokens", "outputTokens", "authHeader", "token"]
}
