{
  "version": 3,
  "sources": ["../bundle-scSQKP/checked-fetch.js", "wrangler-modules-watch:wrangler:modules-watch", "../../../node_modules/wrangler/templates/modules-watch-stub.js", "../../../src/lib/crypto.ts", "../../../src/handlers/admin.ts", "../bundle-scSQKP/middleware-loader.entry.ts", "../bundle-scSQKP/middleware-insertion-facade.js", "../../../src/index.ts", "../../../src/handlers/auth.ts", "../../../src/utils/email.ts", "../../../src/handlers/ai.ts", "../../../src/config/models.ts", "../../../src/utils/userRateLimiter.ts", "../../../src/utils/concurrencyLock.ts", "../../../src/utils/aiQueue.ts", "../../../src/utils/providerThrottle.ts", "../../../src/utils/tokenCostManager.ts", "../../../src/utils/tokenTopup.ts", "../../../src/utils/currency.ts", "../../../src/lib/google-auth.ts", "../../../src/handlers/user.ts", "../../../src/handlers/adminReports.ts", "../../../src/handlers/voucher.ts", "../../../src/handlers/adminTopup.ts", "../../../src/utils/userToken.ts", "../../../src/handlers/payment.ts", "../../../node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../../../node_modules/wrangler/templates/middleware/common.ts"],
  "sourceRoot": "D:\\Proyek App\\metabayn-Tauri\\tauri\\metabayn-backend\\.wrangler\\tmp\\dev-sj1BtF",
  "sourcesContent": ["const urls = new Set();\n\nfunction checkURL(request, init) {\n\tconst url =\n\t\trequest instanceof URL\n\t\t\t? request\n\t\t\t: new URL(\n\t\t\t\t\t(typeof request === \"string\"\n\t\t\t\t\t\t? new Request(request, init)\n\t\t\t\t\t\t: request\n\t\t\t\t\t).url\n\t\t\t\t);\n\tif (url.port && url.port !== \"443\" && url.protocol === \"https:\") {\n\t\tif (!urls.has(url.toString())) {\n\t\t\turls.add(url.toString());\n\t\t\tconsole.warn(\n\t\t\t\t`WARNING: known issue with \\`fetch()\\` requests to custom HTTPS ports in published Workers:\\n` +\n\t\t\t\t\t` - ${url.toString()} - the custom port will be ignored when the Worker is published using the \\`wrangler deploy\\` command.\\n`\n\t\t\t);\n\t\t}\n\t}\n}\n\nglobalThis.fetch = new Proxy(globalThis.fetch, {\n\tapply(target, thisArg, argArray) {\n\t\tconst [request, init] = argArray;\n\t\tcheckURL(request, init);\n\t\treturn Reflect.apply(target, thisArg, argArray);\n\t},\n});\n", "", "// `esbuild` doesn't support returning `watch*` options from `onStart()`\n// plugin callbacks. Instead, we define an empty virtual module that is\n// imported by this injected file. Importing the module registers watchers.\nimport \"wrangler:modules-watch\";\n", "// Helper untuk Password Hashing (PBKDF2)\nexport async function hashPassword(password: string): Promise<string> {\n  const enc = new TextEncoder();\n  const salt = crypto.getRandomValues(new Uint8Array(16));\n  const keyMaterial = await crypto.subtle.importKey(\"raw\", enc.encode(password), { name: \"PBKDF2\" }, false, [\"deriveBits\", \"deriveKey\"]);\n  const derivedKey = await crypto.subtle.deriveKey(\n    { name: \"PBKDF2\", salt, iterations: 100000, hash: \"SHA-256\" },\n    keyMaterial, { name: \"AES-GCM\", length: 256 }, true, [\"encrypt\", \"decrypt\"]\n  );\n  \n  // Kita export raw bits sebagai hex untuk disimpan\n  const exported = await crypto.subtle.exportKey(\"raw\", derivedKey) as ArrayBuffer;\n  const hashHex = [...new Uint8Array(exported)].map(b => b.toString(16).padStart(2, '0')).join('');\n  const saltHex = [...salt].map(b => b.toString(16).padStart(2, '0')).join('');\n  return `${saltHex}:${hashHex}`;\n}\n\nexport async function verifyPassword(password: string, stored: string): Promise<boolean> {\n  const [saltHex, originalHash] = stored.split(':');\n  const salt = new Uint8Array(saltHex.match(/.{1,2}/g)!.map(byte => parseInt(byte, 16)));\n  const enc = new TextEncoder();\n  const keyMaterial = await crypto.subtle.importKey(\"raw\", enc.encode(password), { name: \"PBKDF2\" }, false, [\"deriveBits\", \"deriveKey\"]);\n  const derivedKey = await crypto.subtle.deriveKey(\n    { name: \"PBKDF2\", salt, iterations: 100000, hash: \"SHA-256\" },\n    keyMaterial, { name: \"AES-GCM\", length: 256 }, true, [\"encrypt\", \"decrypt\"]\n  );\n  const exported = await crypto.subtle.exportKey(\"raw\", derivedKey) as ArrayBuffer;\n  const hashHex = [...new Uint8Array(exported)].map(b => b.toString(16).padStart(2, '0')).join('');\n  return hashHex === originalHash;\n}\n\n// Helper untuk JWT (HMAC SHA-256)\nasync function sign(data: any, secret: string): Promise<string> {\n  const enc = new TextEncoder();\n  const key = await crypto.subtle.importKey(\"raw\", enc.encode(secret), { name: \"HMAC\", hash: \"SHA-256\" }, false, [\"sign\"]);\n  const header = btoa(JSON.stringify({ alg: \"HS256\", typ: \"JWT\" }));\n  const payload = btoa(JSON.stringify(data));\n  const signature = await crypto.subtle.sign(\"HMAC\", key, enc.encode(`${header}.${payload}`));\n  const signatureB64 = btoa(String.fromCharCode(...new Uint8Array(signature))).replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n  return `${header}.${payload}.${signatureB64}`;\n}\n\nexport async function createToken(user: any, secret: string) {\n  const payload = {\n    sub: user.id,\n    email: user.email,\n    is_admin: user.is_admin || 0,\n    exp: Math.floor(Date.now() / 1000) + (3650 * 24 * 60 * 60) // 10 tahun (Lifetime)\n  };\n  return sign(payload, secret);\n}\n\nexport async function verifyToken(token: string, secret: string) {\n  try {\n    const [header, payload, signature] = token.split('.');\n    const enc = new TextEncoder();\n    const key = await crypto.subtle.importKey(\"raw\", enc.encode(secret), { name: \"HMAC\", hash: \"SHA-256\" }, false, [\"verify\"]);\n    \n    // Re-create signature check\n    const checkSig = signature.replace(/-/g, '+').replace(/_/g, '/');\n    const signatureBin = Uint8Array.from(atob(checkSig), c => c.charCodeAt(0));\n    \n    const valid = await crypto.subtle.verify(\"HMAC\", key, signatureBin, enc.encode(`${header}.${payload}`));\n    if (!valid) return null;\n    \n    const data = JSON.parse(atob(payload));\n    if (Date.now() / 1000 > data.exp) return null; // Expired\n    return data;\n  } catch (e) {\n    return null;\n  }\n}\n\n// Helper untuk Enkripsi/Dekripsi Data Sementara (AES-GCM)\nexport async function encryptData(text: string, secret: string): Promise<string> {\n    const enc = new TextEncoder();\n    const key = await crypto.subtle.importKey(\"raw\", enc.encode(secret.padEnd(32).slice(0, 32)), \"AES-GCM\", false, [\"encrypt\"]);\n    const iv = crypto.getRandomValues(new Uint8Array(12));\n    const encrypted = await crypto.subtle.encrypt({ name: \"AES-GCM\", iv }, key, enc.encode(text));\n    \n    const ivHex = [...iv].map(b => b.toString(16).padStart(2, '0')).join('');\n    const encryptedHex = [...new Uint8Array(encrypted)].map(b => b.toString(16).padStart(2, '0')).join('');\n    return `${ivHex}:${encryptedHex}`;\n}\n\nexport async function decryptData(text: string, secret: string): Promise<string> {\n    const [ivHex, encryptedHex] = text.split(':');\n    const iv = new Uint8Array(ivHex.match(/.{1,2}/g)!.map(byte => parseInt(byte, 16)));\n    const encrypted = new Uint8Array(encryptedHex.match(/.{1,2}/g)!.map(byte => parseInt(byte, 16)));\n    \n    const enc = new TextEncoder();\n    const key = await crypto.subtle.importKey(\"raw\", enc.encode(secret.padEnd(32).slice(0, 32)), \"AES-GCM\", false, [\"decrypt\"]);\n    \n    const decrypted = await crypto.subtle.decrypt({ name: \"AES-GCM\", iv }, key, encrypted);\n    return new TextDecoder().decode(decrypted);\n}\n", "import { Env } from '../types';\nimport { hashPassword } from '../lib/crypto';\n\nexport async function handleAdminModelPrices(req: Request, env: Env) {\n  const url = new URL(req.url);\n  const method = req.method;\n  const pathParts = url.pathname.split('/');\n  // /admin/model-prices/:id -> [\"\", \"admin\", \"model-prices\", \"123\"]\n  const id = pathParts[3];\n\n  if (method === 'GET') {\n    // List all\n    const results = await env.DB.prepare(\"SELECT * FROM model_prices ORDER BY fallback_priority ASC\").all();\n    return Response.json(results.results);\n  }\n\n  if (method === 'POST') {\n    // Add new\n    const body: any = await req.json();\n    const { provider, model_name, input_price, output_price, profit_multiplier, active, fallback_priority } = body;\n    \n    try {\n      await env.DB.prepare(`\n        INSERT INTO model_prices (provider, model_name, input_price, output_price, profit_multiplier, active, fallback_priority)\n        VALUES (?, ?, ?, ?, ?, ?, ?)\n      `)\n      .bind(provider, model_name, input_price, output_price, profit_multiplier || 1.5, active !== undefined ? active : 1, fallback_priority || 1)\n      .run();\n      return Response.json({ success: true });\n    } catch (e: any) {\n      return Response.json({ error: e.message }, { status: 500 });\n    }\n  }\n\n  if (method === 'PUT' && id) {\n    // Edit existing\n    const body: any = await req.json();\n    const { provider, model_name, input_price, output_price, profit_multiplier, active, fallback_priority } = body;\n    \n    try {\n      // Dynamic update query builder would be better, but fixed for now\n      await env.DB.prepare(`\n        UPDATE model_prices \n        SET provider = ?, model_name = ?, input_price = ?, output_price = ?, profit_multiplier = ?, active = ?, fallback_priority = ?\n        WHERE id = ?\n      `)\n      .bind(provider, model_name, input_price, output_price, profit_multiplier, active, fallback_priority, id)\n      .run();\n      return Response.json({ success: true });\n    } catch (e: any) {\n       return Response.json({ error: e.message }, { status: 500 });\n    }\n  }\n\n  if (method === 'DELETE' && id) {\n    await env.DB.prepare(\"DELETE FROM model_prices WHERE id = ?\").bind(id).run();\n    return Response.json({ success: true });\n  }\n\n  return Response.json({ error: \"Method not allowed\" }, { status: 405 });\n}\n\nexport async function handleListUsers(request: Request, env: Env): Promise<Response> {\n    try {\n        const users = await env.DB.prepare(\"SELECT id, email, tokens, is_admin, created_at, subscription_active, subscription_expiry FROM users ORDER BY created_at DESC\").all();\n        // Handle both D1 result formats (array directly or object with results)\n        const results = Array.isArray(users) ? users : (users.results || []);\n\n        const formattedUsers = results.map(user => ({\n            ...user,\n            // D1 returns timestamps as numbers (seconds). JS Date needs milliseconds.\n            created_at: user.created_at ? new Date(user.created_at * 1000).toISOString() : null\n        }));\n\n        return Response.json(formattedUsers);\n    } catch (e: any) {\n        return Response.json({ error: e.message }, { status: 500 });\n    }\n}\n\nexport async function handleUpdateSubscription(request: Request, env: Env): Promise<Response> {\n    if (request.method !== 'POST') return Response.json({ error: \"Method not allowed\" }, { status: 405 });\n    \n    try {\n        const body: any = await request.json();\n        const { user_id, is_active, expiry_date } = body;\n        \n        if (!user_id) return Response.json({ error: \"User ID required\" }, { status: 400 });\n        \n        // is_active should be boolean or 0/1. expiry_date should be string or null\n        const activeVal = is_active ? 1 : 0;\n        \n        const result = await env.DB.prepare(\"UPDATE users SET subscription_active = ?, subscription_expiry = ? WHERE id = ?\")\n            .bind(activeVal, expiry_date, user_id)\n            .run();\n\n        // Check if any row was actually updated\n        if (result.meta && result.meta.changes === 0) {\n             return Response.json({ success: false, error: \"User not found or no changes made\" });\n        }\n            \n        return Response.json({ success: true, changes: result.meta.changes });\n    } catch (e: any) {\n        return Response.json({ error: e.message }, { status: 500 });\n    }\n}\n\nexport async function handleResetPassword(request: Request, env: Env): Promise<Response> {\n    if (request.method !== 'POST') return Response.json({ error: \"Method not allowed\" }, { status: 405 });\n\n    try {\n        const body: any = await request.json();\n        const { user_id, new_password } = body;\n\n        if (!user_id || !new_password) {\n            return Response.json({ error: \"User ID and new password are required\" }, { status: 400 });\n        }\n\n        if (new_password.length < 6) {\n            return Response.json({ error: \"Password must be at least 6 characters\" }, { status: 400 });\n        }\n\n        const hashedPassword = await hashPassword(new_password);\n\n        const result = await env.DB.prepare(\"UPDATE users SET password = ? WHERE id = ?\")\n            .bind(hashedPassword, user_id)\n            .run();\n\n        if (result.meta && result.meta.changes === 0) {\n            return Response.json({ success: false, error: \"User not found\" });\n        }\n\n        return Response.json({ success: true, message: \"Password updated successfully\" });\n    } catch (e: any) {\n        return Response.json({ error: e.message }, { status: 500 });\n    }\n}\n\nexport async function handleDeleteUser(request: Request, env: Env): Promise<Response> {\n    if (request.method !== 'POST') return Response.json({ error: \"Method not allowed\" }, { status: 405 });\n\n    try {\n        const body: any = await request.json();\n        const { user_id } = body;\n\n        if (!user_id) {\n            return Response.json({ error: \"User ID is required\" }, { status: 400 });\n        }\n\n        // Prevent deleting special accounts\n        const user = await env.DB.prepare(\"SELECT email FROM users WHERE id = ?\").bind(user_id).first();\n        if (!user) {\n             return Response.json({ error: \"User not found\" }, { status: 404 });\n        }\n        if (user.email === 'metabayn@gmail.com') {\n             return Response.json({ error: \"Cannot delete super admin account\" }, { status: 403 });\n        }\n\n        // --- Execute Deletions sequentially ---\n        // We do NOT use try-catch here because if these fail, the final delete will fail due to FK constraints anyway.\n        // It is better to fail fast or ensure these succeed.\n\n        // 1. Delete Voucher Claims (Has Foreign Key: user_id INTEGER)\n        // Bind as-is (number/string) usually works, but if strict, number is safer for INTEGER column.\n        await env.DB.prepare(\"DELETE FROM voucher_claims WHERE user_id = ?\").bind(user_id).run();\n\n        // 2. Delete History (Has Foreign Key: user_id INTEGER)\n        await env.DB.prepare(\"DELETE FROM history WHERE user_id = ?\").bind(user_id).run();\n\n        // 3. Delete Topup Transactions (user_id TEXT - No FK but good cleanup)\n        // Bind as String because column is TEXT\n        await env.DB.prepare(\"DELETE FROM topup_transactions WHERE user_id = ?\").bind(String(user_id)).run();\n\n        // 4. Delete Auth Logs (user_id TEXT - No FK)\n        await env.DB.prepare(\"DELETE FROM auth_logs WHERE user_id = ?\").bind(String(user_id)).run();\n\n        // 5. Delete User (Parent Table)\n        const result = await env.DB.prepare(\"DELETE FROM users WHERE id = ?\")\n            .bind(user_id)\n            .run();\n\n        if (result.meta && result.meta.changes === 0) {\n            return Response.json({ success: false, error: \"User delete failed (0 changes)\" });\n        }\n\n        return Response.json({ success: true, message: \"User deleted successfully\" });\n    } catch (e: any) {\n        console.error(\"Delete user error:\", e);\n        return Response.json({ error: \"Delete failed: \" + e.message }, { status: 500 });\n    }\n}\n\nexport async function handleSeedUsers(request: Request, env: Env): Promise<Response> {\n    try {\n        // Check if users already exist\n        const count: any = await env.DB.prepare(\"SELECT COUNT(*) as count FROM users\").first();\n        if (count && count.count > 0) {\n            return Response.json({ message: \"Users already exist\", count: count.count });\n        }\n\n        const dummyUsers = [\n            { email: \"user1@example.com\", tokens: 1000, is_admin: 0, subscription_active: 0 },\n            { email: \"user2@example.com\", tokens: 5000, is_admin: 0, subscription_active: 1, subscription_expiry: new Date(Date.now() + 86400000 * 30).toISOString() },\n            { email: \"admin@metabayn.com\", tokens: 999999, is_admin: 1, subscription_active: 1, subscription_expiry: new Date(Date.now() + 86400000 * 365).toISOString() },\n            { email: \"expired@example.com\", tokens: 0, is_admin: 0, subscription_active: 1, subscription_expiry: new Date(Date.now() - 86400000).toISOString() },\n            { email: \"newuser@example.com\", tokens: 100, is_admin: 0, subscription_active: 0 }\n        ];\n\n        const stmt = env.DB.prepare(\"INSERT INTO users (email, password, tokens, is_admin, subscription_active, subscription_expiry, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)\");\n        \n        const batch = dummyUsers.map(u => \n            stmt.bind(u.email, \"hashed_password_placeholder\", u.tokens, u.is_admin, u.subscription_active, u.subscription_expiry || null, new Date().toISOString())\n        );\n\n        await env.DB.batch(batch);\n\n        return Response.json({ success: true, message: `Seeded ${dummyUsers.length} users` });\n    } catch (e: any) {\n        return Response.json({ error: e.message }, { status: 500 });\n    }\n}\n\nexport async function handleAdminConfig(request: Request, env: Env): Promise<Response> {\n  const method = request.method;\n\n  if (method === 'GET') {\n    const configs = await env.DB.prepare(\"SELECT * FROM app_config\").all();\n    const configMap: Record<string, any> = {};\n    configs.results.forEach((row: any) => {\n        try {\n            configMap[row.key] = JSON.parse(row.value);\n        } catch {\n            configMap[row.key] = row.value;\n        }\n    });\n    return Response.json(configMap);\n  }\n\n  if (method === 'POST') {\n    try {\n        const body = await request.json() as Record<string, any>;\n        \n        const batch = [];\n        \n        for (const [key, value] of Object.entries(body)) {\n            const valStr = typeof value === 'object' ? JSON.stringify(value) : String(value);\n            // Prepare a fresh statement for each item to avoid any bind reuse issues\n            batch.push(env.DB.prepare(\"INSERT OR REPLACE INTO app_config (key, value) VALUES (?, ?)\").bind(key, valStr));\n        }\n        \n        if (batch.length > 0) {\n            await env.DB.batch(batch);\n        }\n        \n        return Response.json({ success: true });\n    } catch (e: any) {\n        return Response.json({ error: e.message }, { status: 500 });\n    }\n  }\n\n  return Response.json({ error: \"Method not allowed\" }, { status: 405 });\n}\n\n// Sync Official Model Prices into DB (Upsert by model_name)\nexport async function handleAdminAuthLogs(request: Request, env: Env): Promise<Response> {\n  const method = request.method;\n\n  if (method === 'GET') {\n    try {\n        const logs = await env.DB.prepare(\"SELECT * FROM auth_logs ORDER BY timestamp DESC LIMIT 100\").all();\n        const results = Array.isArray(logs) ? logs : (logs.results || []);\n        return Response.json(results);\n    } catch (e: any) {\n        // If table doesn't exist, return empty\n        if (e.message.includes('no such table')) return Response.json([]);\n        return Response.json({ error: e.message }, { status: 500 });\n    }\n  }\n\n  if (method === 'POST') {\n      // Manual Init / Migration for Auth Logs\n      try {\n          await env.DB.prepare(`\n            CREATE TABLE IF NOT EXISTS auth_logs (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                user_id TEXT,\n                email TEXT NOT NULL,\n                action TEXT NOT NULL,\n                ip_address TEXT,\n                device_hash TEXT,\n                timestamp INTEGER DEFAULT (unixepoch())\n            )\n          `).run();\n\n          // Also init rate_limits if missing\n          await env.DB.prepare(`\n            CREATE TABLE IF NOT EXISTS rate_limits (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                key TEXT NOT NULL,\n                action TEXT NOT NULL,\n                timestamp INTEGER NOT NULL\n            )\n          `).run();\n\n          return Response.json({ success: true, message: \"Tables initialized (auth_logs, rate_limits)\" });\n      } catch (e: any) {\n          return Response.json({ error: e.message }, { status: 500 });\n      }\n  }\n\n  return Response.json({ error: \"Method not allowed\" }, { status: 405 });\n}\n\nexport async function handleSyncModelPrices(request: Request, env: Env): Promise<Response> {\n  try {\n    // Fetch global profit margin from config\n    let profitPercent = 60;\n    try {\n      const cfg = await env.DB.prepare(\"SELECT value FROM app_config WHERE key = 'profit_margin_percent'\").first();\n      if (cfg && cfg.value) profitPercent = Number(cfg.value);\n    } catch {}\n    const profitMultiplier = 1 + (profitPercent / 100);\n\n    // Curated official prices (USD per 1M tokens)\n    const OFFICIAL: Array<{provider:string, model_name:string, input_price:number, output_price:number, active:number, fallback_priority:number}> = [\n      // OpenAI (Updated Dec 2025)\n      { provider: 'openai', model_name: 'o1', input_price: 15.00, output_price: 60.00, active: 1, fallback_priority: 1 },\n      { provider: 'openai', model_name: 'o1-mini', input_price: 3.00, output_price: 12.00, active: 1, fallback_priority: 1 },\n      { provider: 'openai', model_name: 'o3-mini', input_price: 1.10, output_price: 4.40, active: 1, fallback_priority: 1 },\n      { provider: 'openai', model_name: 'gpt-4o', input_price: 2.50, output_price: 10.00, active: 1, fallback_priority: 1 },\n      { provider: 'openai', model_name: 'gpt-4o-mini', input_price: 0.15, output_price: 0.60, active: 1, fallback_priority: 1 },\n      { provider: 'openai', model_name: 'gpt-4.5-preview', input_price: 75.00, output_price: 150.00, active: 0, fallback_priority: 1 },\n      { provider: 'openai', model_name: 'gpt-4-turbo', input_price: 10.00, output_price: 30.00, active: 1, fallback_priority: 1 },\n      \n      // OpenAI Legacy / Custom Aliases\n      { provider: 'openai', model_name: 'gpt-4.1', input_price: 3.00, output_price: 12.00, active: 1, fallback_priority: 1 },\n      { provider: 'openai', model_name: 'gpt-4o-realtime', input_price: 5.00, output_price: 20.00, active: 0, fallback_priority: 1 },\n      { provider: 'openai', model_name: 'o1-preview', input_price: 15.00, output_price: 60.00, active: 0, fallback_priority: 1 },\n      \n      // Gemini\n      { provider: 'gemini', model_name: 'gemini-3.0-flash-preview', input_price: 0.35, output_price: 3.00, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-3.0-pro-preview', input_price: 1.50, output_price: 8.00, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-3.0-ultra', input_price: 4.00, output_price: 12.00, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-2.5-ultra', input_price: 2.50, output_price: 12.00, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-2.5-pro', input_price: 1.25, output_price: 10.00, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-2.5-flash', input_price: 0.30, output_price: 2.50, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-2.5-flash-lite', input_price: 0.10, output_price: 0.40, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-2.0-ultra', input_price: 2.50, output_price: 12.00, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-2.0-pro', input_price: 3.50, output_price: 10.50, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-2.0-pro-exp-02-05', input_price: 3.50, output_price: 10.50, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-2.0-flash', input_price: 0.10, output_price: 0.40, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-2.0-flash-exp', input_price: 0.10, output_price: 0.40, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-2.0-flash-lite', input_price: 0.075, output_price: 0.30, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-2.0-flash-lite-preview-02-05', input_price: 0.075, output_price: 0.30, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-1.5-pro', input_price: 3.50, output_price: 10.50, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-1.5-flash', input_price: 0.075, output_price: 0.30, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-1.5-flash-8b', input_price: 0.0375, output_price: 0.15, active: 1, fallback_priority: 1 },\n      { provider: 'gemini', model_name: 'gemini-pro', input_price: 0.50, output_price: 1.50, active: 1, fallback_priority: 1 },\n    ];\n\n    // Upsert entries\n    for (const p of OFFICIAL) {\n      const existing = await env.DB.prepare(\"SELECT id FROM model_prices WHERE model_name = ?\").bind(p.model_name).first();\n      if (existing && existing.id) {\n        await env.DB.prepare(`\n          UPDATE model_prices \n          SET provider = ?, input_price = ?, output_price = ?, profit_multiplier = ?, active = ?, fallback_priority = ?\n          WHERE id = ?\n        `).bind(p.provider, p.input_price, p.output_price, profitMultiplier, p.active, p.fallback_priority, existing.id).run();\n      } else {\n        await env.DB.prepare(`\n          INSERT INTO model_prices (provider, model_name, input_price, output_price, profit_multiplier, active, fallback_priority)\n          VALUES (?, ?, ?, ?, ?, ?, ?)\n        `).bind(p.provider, p.model_name, p.input_price, p.output_price, profitMultiplier, p.active, p.fallback_priority).run();\n      }\n    }\n\n    return Response.json({ success: true, count: OFFICIAL.length });\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\nexport async function handleSyncLiveModelPrices(request: Request, env: Env): Promise<Response> {\n  try {\n    let profitPercent = 60;\n    try {\n      const cfg = await env.DB.prepare(\"SELECT value FROM app_config WHERE key = 'profit_margin_percent'\").first();\n      if (cfg && cfg.value) profitPercent = Number(cfg.value);\n    } catch {}\n    const profitMultiplier = 1 + (profitPercent / 100);\n\n    const upsert = async (provider: string, model_name: string, input_price: number, output_price: number, active = 1, fallback_priority = 1) => {\n      const existing = await env.DB.prepare(\"SELECT id FROM model_prices WHERE model_name = ?\").bind(model_name).first();\n      if (existing && existing.id) {\n        await env.DB.prepare(`\n          UPDATE model_prices \n          SET provider = ?, input_price = ?, output_price = ?, profit_multiplier = ?, active = ?, fallback_priority = ?\n          WHERE id = ?\n        `).bind(provider, input_price, output_price, profitMultiplier, active, fallback_priority, existing.id).run();\n      } else {\n        await env.DB.prepare(`\n          INSERT INTO model_prices (provider, model_name, input_price, output_price, profit_multiplier, active, fallback_priority)\n          VALUES (?, ?, ?, ?, ?, ?, ?)\n        `).bind(provider, model_name, input_price, output_price, profitMultiplier, active, fallback_priority).run();\n      }\n    };\n\n    let count = 0;\n\n    try {\n      const res = await fetch('https://openai.com/api/pricing');\n      const html = await res.text();\n      const pick = (name: string) => {\n        const re = new RegExp(name + \".*?\\$([0-9\\.]+).*?\\$([0-9\\.]+)\", 'is');\n        const m = html.match(re);\n        if (m) return { in: Number(m[1]), out: Number(m[2]) };\n        return null;\n      };\n      const o4o = pick('gpt-4o');\n      if (o4o) { await upsert('openai', 'gpt-4o', o4o.in, o4o.out); count++; }\n      const o4omini = pick('gpt-4o-mini');\n      if (o4omini) { await upsert('openai', 'gpt-4o-mini', o4omini.in, o4omini.out); count++; }\n      const g41 = pick('gpt-4.1');\n      if (g41) { await upsert('openai', 'gpt-4.1', g41.in, g41.out); count++; }\n      const o1 = pick('o1');\n      if (o1) { await upsert('openai', 'o1', o1.in, o1.out); count++; }\n      const o3 = pick('o3');\n      if (o3) { await upsert('openai', 'o3', o3.in, o3.out); count++; }\n      const o4mini = pick('o4-mini');\n      if (o4mini) { await upsert('openai', 'o4-mini', o4mini.in, o4mini.out); count++; }\n    } catch {}\n\n    try {\n      const res = await fetch('https://ai.google.dev/pricing');\n      const html = await res.text();\n      const pick = (name: string) => {\n        const re = new RegExp(name + \".*?\\$([0-9\\.]+).*?\\$([0-9\\.]+)\", 'is');\n        const m = html.match(re);\n        if (m) return { in: Number(m[1]), out: Number(m[2]) };\n        return null;\n      };\n      const g15pro = pick('Gemini 1\\.5 Pro');\n      if (g15pro) { await upsert('gemini', 'gemini-1.5-pro', g15pro.in, g15pro.out); count++; }\n      const g15flash = pick('Gemini 1\\.5 Flash');\n      if (g15flash) { await upsert('gemini', 'gemini-1.5-flash', g15flash.in, g15flash.out); count++; }\n      const g15flash8b = pick('Flash-8B');\n      if (g15flash8b) { await upsert('gemini', 'gemini-1.5-flash-8b', g15flash8b.in, g15flash8b.out); count++; }\n      const g20flash = pick('Gemini 2\\.0 Flash');\n      if (g20flash) { await upsert('gemini', 'gemini-2.0-flash', g20flash.in, g20flash.out); count++; }\n      const g20flashlite = pick('Flash Lite');\n      if (g20flashlite) { await upsert('gemini', 'gemini-2.0-flash-lite', g20flashlite.in, g20flashlite.out); count++; }\n      const g25pro = pick('Gemini 2\\.5 Pro');\n      if (g25pro) { await upsert('gemini', 'gemini-2.5-pro', g25pro.in, g25pro.out); count++; }\n      const g25flash = pick('Gemini 2\\.5 Flash');\n      if (g25flash) { await upsert('gemini', 'gemini-2.5-flash', g25flash.in, g25flash.out); count++; }\n    } catch {}\n\n    if (count === 0) {\n      const fallback = [\n        ['openai','gpt-4o',5.0,15.0],\n        ['openai','gpt-4o-mini',0.15,0.60],\n        ['openai','gpt-4.1',5.0,15.0],\n        ['openai','o1',15.0,60.0],\n        ['openai','o3',4.0,16.0],\n        ['openai','o4-mini',0.20,0.80],\n        ['gemini','gemini-1.5-pro',3.5,10.5],\n        ['gemini','gemini-1.5-flash',0.075,0.30],\n        ['gemini','gemini-1.5-flash-8b',0.0375,0.15],\n        ['gemini','gemini-2.0-flash',0.10,0.40],\n        ['gemini','gemini-2.0-flash-lite',0.075,0.30],\n        ['gemini','gemini-2.5-pro',1.25,10.0],\n        ['gemini','gemini-2.5-flash',0.30,2.50]\n      ];\n      for (const [prov, name, ip, op] of fallback) {\n        await upsert(String(prov), String(name), Number(ip), Number(op));\n      }\n      count = fallback.length;\n    }\n\n    return Response.json({ success: true, count });\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"D:\\\\Proyek App\\\\metabayn-Tauri\\\\tauri\\\\metabayn-backend\\\\.wrangler\\\\tmp\\\\bundle-scSQKP\\\\middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"D:\\\\Proyek App\\\\metabayn-Tauri\\\\tauri\\\\metabayn-backend\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\common.ts\";\nimport type { WorkerEntrypointConstructor } from \"D:\\\\Proyek App\\\\metabayn-Tauri\\\\tauri\\\\metabayn-backend\\\\.wrangler\\\\tmp\\\\bundle-scSQKP\\\\middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"D:\\\\Proyek App\\\\metabayn-Tauri\\\\tauri\\\\metabayn-backend\\\\.wrangler\\\\tmp\\\\bundle-scSQKP\\\\middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"D:\\\\Proyek App\\\\metabayn-Tauri\\\\tauri\\\\metabayn-backend\\\\src\\\\index.ts\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"D:\\\\Proyek App\\\\metabayn-Tauri\\\\tauri\\\\metabayn-backend\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"D:\\\\Proyek App\\\\metabayn-Tauri\\\\tauri\\\\metabayn-backend\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"D:\\\\Proyek App\\\\metabayn-Tauri\\\\tauri\\\\metabayn-backend\\\\src\\\\index.ts\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "import { handleLogin, handleRegister, handleGetMe, handleVerify } from './handlers/auth';\nimport { handleGenerate } from './handlers/ai';\nimport { handleBalance, handleHistory, handleTopup } from './handlers/user';\nimport { handleAdminModelPrices, handleAdminConfig, handleListUsers, handleUpdateSubscription, handleResetPassword, handleDeleteUser } from './handlers/admin';\nimport { handleUserUsage, handleExportUsageCsv } from './handlers/adminReports';\nimport { handleRedeemVoucher, handleListVouchers, handleCreateVoucher, handleDeleteVoucher, handleBulkCreateVouchers, handleExtendVoucher, handleLynkIdWebhook } from './handlers/voucher';\nimport { listTopups, getTopupDetail, manualApproveTopup, deleteTopup, getTopupStatistics, exportTopupCsv } from './handlers/adminTopup';\nimport { createPaypalPayment, handlePaypalWebhook, checkPaypalStatus, paymentSuccessPage, paymentCancelPage } from './handlers/payment';\nimport { verifyToken } from './lib/crypto';\nimport { Env } from './types';\nimport { getExchangeRate } from './utils/currency';\n\nexport type { Env }; // Re-export for handlers if needed, though they should import from types\n\nexport default {\n  async scheduled(_event: any, env: Env, _ctx: ExecutionContext): Promise<void> {\n    try {\n      const autoRow = await env.DB.prepare(\"SELECT value FROM app_config WHERE key = 'usd_idr_auto_sync'\").first();\n      let auto = false;\n      if (autoRow && autoRow.value) {\n        try { auto = JSON.parse(String(autoRow.value)) === true; } catch { auto = String(autoRow.value) === '1' || String(autoRow.value) === 'true'; }\n      }\n\n      if (!auto) return;\n\n      const live = await getExchangeRate(env);\n      if (live && typeof live === 'number' && live > 0) {\n        await env.DB.prepare(\"INSERT OR REPLACE INTO app_config (key, value) VALUES (?, ?)\\n\").bind('usd_idr_rate', String(live)).run();\n        await env.DB.prepare(\"INSERT OR REPLACE INTO app_config (key, value) VALUES (?, ?)\\n\").bind('usd_idr_rate_last_update', String(Date.now())).run();\n      }\n    } catch (e) {\n      // Silent fail to avoid crashing scheduled event\n      console.log('Scheduled rate sync failed:', e);\n    }\n  },\n  async fetch(request: Request, env: Env, _ctx: ExecutionContext): Promise<Response> {\n    const url = new URL(request.url);\n    const path = url.pathname;\n    const method = request.method;\n\n    // CORS Headers\n    const corsHeaders = {\n      \"Access-Control-Allow-Origin\": \"*\",\n      \"Access-Control-Allow-Methods\": \"GET, POST, OPTIONS, PUT, DELETE\",\n      \"Access-Control-Allow-Headers\": \"Content-Type, Authorization, x-admin-key\",\n    };\n\n    if (method === \"OPTIONS\") return new Response(null, { headers: corsHeaders });\n\n    const wrapCors = async (promise: Promise<Response>) => {\n      const res = await promise;\n      const headers = new Headers(res.headers);\n      Object.entries(corsHeaders).forEach(([k, v]) => headers.set(k, v));\n      return new Response(res.body, { status: res.status, statusText: res.statusText, headers });\n    };\n\n    try {\n      // --- PUBLIC ROUTES (No Auth Required) ---\n      if (path === '/auth/register' && method === 'POST') return await wrapCors(handleRegister(request, env));\n      if (path === '/auth/login' && method === 'POST') return await wrapCors(handleLogin(request, env));\n      if (path === '/auth/verify' && method === 'GET') return await handleVerify(request, env);\n      if (path === '/integration/lynkid/webhook' && method === 'POST') return await wrapCors(handleLynkIdWebhook(request, env));\n      if (path === '/payment/success' && method === 'GET') return await paymentSuccessPage(request, env);\n      if (path === '/payment/cancel' && method === 'GET') return await paymentCancelPage(request, env);\n      \n      // Payment Webhooks (Must be public, verify signature inside handler)\n      if (path === '/payment/paypal/webhook' && method === 'POST') return await wrapCors(handlePaypalWebhook(request, env));\n\n      // --- ADMIN ROUTES (Protected by ADMIN_SECRET OR Admin JWT) ---\n      if (path.startsWith('/admin/')) {\n          let isAdmin = false;\n          \n          // 1. Check x-admin-key\n          const adminKey = request.headers.get('x-admin-key');\n          if (env.ADMIN_SECRET && adminKey === env.ADMIN_SECRET) {\n              isAdmin = true;\n          }\n\n          // 2. Check JWT if not already authenticated via key\n          if (!isAdmin) {\n             const authHeader = request.headers.get('Authorization');\n             if (authHeader && authHeader.startsWith('Bearer ')) {\n                const token = authHeader.split(' ')[1];\n                const decoded = await verifyToken(token, env.JWT_SECRET);\n                if (decoded) {\n                    // Double check DB for latest admin status (in case token is old)\n                    const dbUser = await env.DB.prepare(\"SELECT is_admin FROM users WHERE id = ?\").bind(decoded.id).first();\n                    if (dbUser && dbUser.is_admin === 1) {\n                        isAdmin = true;\n                    }\n                }\n             }\n          }\n\n          if (!isAdmin) {\n              return new Response(JSON.stringify({ error: 'Unauthorized Admin' }), { status: 401, headers: corsHeaders });\n          }\n\n          // Existing Admin Routes\n          if (path === '/admin/model-prices/sync' && method === 'POST') {\n            const { handleSyncModelPrices } = await import('./handlers/admin');\n            return await wrapCors(handleSyncModelPrices(request, env));\n          }\n          if (path === '/admin/model-prices/sync-live' && method === 'POST') {\n            const { handleSyncLiveModelPrices } = await import('./handlers/admin');\n            return await wrapCors(handleSyncLiveModelPrices(request, env));\n          }\n          if (path.startsWith('/admin/model-prices')) return await wrapCors(handleAdminModelPrices(request, env));\n          if (path === '/admin/auth-logs') {\n            const { handleAdminAuthLogs } = await import('./handlers/admin');\n            return await wrapCors(handleAdminAuthLogs(request, env));\n          }\n          if (path === '/admin/config') return await wrapCors(handleAdminConfig(request, env));\n          if (path === '/admin/users') return await wrapCors(handleListUsers(request, env));\n          if (path === '/admin/users/list') return await wrapCors(handleListUsers(request, env)); // Alias\n          if (path === '/admin/users/subscription') return await wrapCors(handleUpdateSubscription(request, env));\n          if (path === '/admin/users/reset-password') return await wrapCors(handleResetPassword(request, env));\n          if (path === '/admin/users/delete') return await wrapCors(handleDeleteUser(request, env));\n\n          // Admin Reports\n          if (path.startsWith('/admin/users/') && path.endsWith('/usage') && method === 'GET') return await wrapCors(handleUserUsage(request, env));\n          if (path === '/admin/users/export-usage' && method === 'GET') return await wrapCors(handleExportUsageCsv(request, env));\n\n          // Voucher Admin Routes\n          if (path === '/admin/vouchers' && method === 'GET') return await wrapCors(handleListVouchers(request, env));\n          if (path === '/admin/vouchers/create' && method === 'POST') return await wrapCors(handleCreateVoucher(request, env));\n  if (path === '/admin/vouchers/bulk-create' && method === 'POST') return await wrapCors(handleBulkCreateVouchers(request, env));\n  if (path === '/admin/vouchers/extend' && method === 'POST') return await wrapCors(handleExtendVoucher(request, env));\n          if (path === '/admin/vouchers/delete' && method === 'POST') return await wrapCors(handleDeleteVoucher(request, env));\n\n          // Top-Up Admin Routes\n          if (path === '/admin/topup/list' && method === 'GET') return await wrapCors(listTopups(request, env));\n          if (path.startsWith('/admin/topup/detail/') && method === 'GET') return await wrapCors(getTopupDetail(request, env));\n          if (path === '/admin/topup/manual-approve' && method === 'POST') return await wrapCors(manualApproveTopup(request, env));\n          if (path === '/admin/topup/delete' && method === 'POST') return await wrapCors(deleteTopup(request, env));\n          if (path === '/admin/topup/statistics' && method === 'GET') return await wrapCors(getTopupStatistics(request, env));\n          if (path === '/admin/topup/export-csv' && method === 'GET') return await wrapCors(exportTopupCsv(request, env));\n          \n          return new Response('Admin Route Not Found', { status: 404, headers: corsHeaders });\n      }\n\n      // --- PROTECTED ROUTES MIDDLEWARE (User JWT) ---\n      const authHeader = request.headers.get('Authorization');\n      if (!authHeader || !authHeader.startsWith('Bearer ')) {\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401, headers: corsHeaders });\n      }\n      const token = authHeader.split(' ')[1];\n      const user = await verifyToken(token, env.JWT_SECRET);\n      if (!user) {\n        return new Response(JSON.stringify({ error: 'Invalid Token' }), { status: 401, headers: corsHeaders });\n      }\n\n      // Inject user ID into request for handlers (simple passing via arg)\n      const userId = user.sub;\n      \n      // --- AUTHENTICATED ROUTES ---\n      if (path === '/user/me' && method === 'GET') return await wrapCors(handleGetMe(userId, env));\n      if ((path === '/token/balance' || path === '/user/balance') && method === 'GET') return await wrapCors(handleBalance(userId, env));\n      if (path === '/token/topup' && method === 'POST') return await wrapCors(handleTopup(request, userId, env)); // Legacy/Simple topup\n      if (path === '/history/list' && method === 'GET') return await wrapCors(handleHistory(userId, env));\n      if (path === '/ai/generate' && method === 'POST') return await wrapCors(handleGenerate(request, userId, env));\n      \n      // Voucher Redemption\n      if (path === '/voucher/redeem' && method === 'POST') return await wrapCors(handleRedeemVoucher(request, env));\n\n      // Payment Creation Routes\n      if (path === '/payment/paypal/create' && method === 'POST') return await wrapCors(createPaypalPayment(request, env));\n      if (path === '/payment/paypal/check' && method === 'POST') return await wrapCors(checkPaypalStatus(request, env));\n\n      return new Response('Not Found', { status: 404, headers: corsHeaders });\n\n    } catch (e: any) {\n      return new Response(JSON.stringify({ error: e.message }), { status: 500, headers: corsHeaders });\n    }\n  },\n};\n", "import { Env } from '../types';\nimport { hashPassword, verifyPassword, createToken } from '../lib/crypto';\nimport { sendEmail, getVerificationTemplate, getWelcomeTemplate } from '../utils/email';\n\nexport async function handleRegister(req: Request, env: Env) {\n  const body: any = await req.json();\n  const { email, password, device_hash } = body;\n\n  if (!email || !password || !device_hash) return Response.json({ error: \"Missing fields\" }, { status: 400 });\n\n  // Basic format validation\n  const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\n  if (!emailRegex.test(email)) {\n    return Response.json({ error: \"Invalid email format. Please check your email.\" }, { status: 400 });\n  }\n\n  // RATE LIMITING REMOVED PER USER REQUEST\n  // (Previously lines 17-37)\n\n  const hashedPassword = await hashPassword(password);\n  \n  // Generate Confirmation Token\n  const confirmToken = crypto.randomUUID();\n  const expiresAt = Date.now() + 24 * 60 * 60 * 1000; // 24 hours\n\n  try {\n    // Fetch USD Rate for initial balance ($3)\n    let initialTokens = 48900; // Default fallback (16300 * 3)\n    try {\n        const rateCfg = await env.DB.prepare(\"SELECT value FROM app_config WHERE key = 'usd_idr_rate'\").first();\n        if (rateCfg && rateCfg.value) {\n            const rate = Number(rateCfg.value);\n            if (!isNaN(rate) && rate > 0) {\n                initialTokens = Math.round(3 * rate);\n            }\n        }\n    } catch (e) {\n        console.error(\"Failed to fetch rate for initial balance, using default:\", e);\n        // Fallback is already set to 48900\n    }\n\n    // Ensure initialTokens is never 0 or invalid for the first device use\n    if (!initialTokens || initialTokens <= 0) initialTokens = 48900;\n\n    // Check if this device has already registered an account before\n    const existingDeviceUser = await env.DB.prepare(\"SELECT id FROM users WHERE device_hash = ?\")\n      .bind(device_hash)\n      .first();\n\n    // If this device was used before, do NOT grant the free $3 again\n    if (existingDeviceUser) {\n        initialTokens = 0;\n    }\n\n    // Insert user with initial tokens (first device registration gets $3 equivalent)\n    await env.DB.prepare(\"INSERT INTO users (email, password, tokens, status, confirmation_token, confirmation_expires_at, device_hash) VALUES (?, ?, ?, ?, ?, ?, ?)\")\n      .bind(email, hashedPassword, initialTokens, 'pending', confirmToken, expiresAt, device_hash)\n      .run();\n\n    // Get the last inserted user ID for potential rollback\n    const userIdResult = await env.DB.prepare(\"SELECT id FROM users WHERE email = ?\").bind(email).first();\n    if (!userIdResult) {\n        // This should realistically never happen if the insert succeeded\n        throw new Error(\"Failed to retrieve user ID after registration.\");\n    }\n    const newUserId = userIdResult.id;\n\n    try {\n        // Construct Link & Send Verification Email (BLOCKING)\n        const workerUrl = \"https://metabayn-backend.metabayn.workers.dev\";\n        const link = `${workerUrl}/auth/verify?token=${confirmToken}`;\n        const emailHtml = getVerificationTemplate(email, password, link);\n        \n        await sendEmail(email, \"Verify Your Email Address\", emailHtml, env);\n\n        // Log email success\n        await env.DB.prepare(\"INSERT INTO email_logs (recipient, subject, status, timestamp) VALUES (?, ?, 'sent', ?)\")\n            .bind(email, \"Verify Your Email Address\", Date.now())\n            .run();\n\n    } catch (emailErr: any) {\n        console.error(\"Email send failed, rolling back user registration:\", emailErr);\n        \n        // Rollback: Delete the user that was just created\n        await env.DB.prepare(\"DELETE FROM users WHERE id = ?\").bind(newUserId).run();\n        \n        // Also log the email failure\n        await env.DB.prepare(\"INSERT INTO email_logs (recipient, subject, status, error, timestamp) VALUES (?, ?, 'failed', ?, ?)\")\n            .bind(email, \"Verify Your Email Address\", String(emailErr), Date.now())\n            .run();\n\n        // Return a more descriptive error for debugging (especially for Resend Sandbox issues)\n        const errorMessage = emailErr.message || String(emailErr);\n        return Response.json({ error: `Registration failed (Email Service): ${errorMessage}` }, { status: 400 });\n    }\n\n    // Log Registration to Auth Logs\n    try {\n        const newUser = await env.DB.prepare(\"SELECT id FROM users WHERE email = ?\").bind(email).first();\n        if (newUser) {\n             const ip = req.headers.get(\"CF-Connecting-IP\") || \"unknown\";\n             await env.DB.prepare(\"INSERT INTO auth_logs (user_id, email, action, ip_address, device_hash, timestamp) VALUES (?, ?, 'register', ?, ?, ?)\")\n                 .bind(newUser.id, email, ip, device_hash, Math.floor(Date.now()/1000))\n                 .run();\n        }\n    } catch (e) { console.error(\"Auth log failed:\", e); }\n\n    return Response.json({ success: true, message: \"Registration successful. Please check your email to verify your account.\" });\n  } catch (e: any) {\n    console.error(\"Register Error:\", e);\n    // Only return \"Email already exists\" if it's actually a constraint violation\n    if (e.message && e.message.includes('UNIQUE constraint failed')) {\n        return Response.json({ error: \"Email already exists\" }, { status: 409 });\n    }\n    // Otherwise return the real error so we can debug\n    return Response.json({ error: \"Registration failed: \" + e.message }, { status: 500 });\n  }\n}\n\nexport async function handleVerify(req: Request, env: Env) {\n    const url = new URL(req.url);\n    const token = url.searchParams.get('token');\n\n    if (!token) return new Response(\"Missing token\", { status: 400 });\n\n    const user = await env.DB.prepare(\"SELECT * FROM users WHERE confirmation_token = ?\").bind(token).first();\n    \n    if (!user) {\n        return new Response(\"Invalid or expired token.\", { status: 400 });\n    }\n\n    if (user.confirmation_expires_at && (user.confirmation_expires_at as number) < Date.now()) {\n        return new Response(\"Token expired. Please register again.\", { status: 400 });\n    }\n\n    // Activate User & Send Welcome Email\n    try {\n        // Send Welcome Email (Verification Success)\n        const emailHtml = getWelcomeTemplate(user.email as string);\n        await sendEmail(user.email as string, \"Verification Successful - Welcome to MetaBayn!\", emailHtml, env);\n\n        // Update User: Active, Clear Token\n        await env.DB.prepare(\"UPDATE users SET status = 'active', confirmation_token = NULL WHERE id = ?\")\n            .bind(user.id)\n            .run();\n\n    } catch (e) {\n        console.error(\"Verification error:\", e);\n        // Even if email fails, we should probably still activate the user? \n        // Or fail? Let's activate them but log error.\n        await env.DB.prepare(\"UPDATE users SET status = 'active', confirmation_token = NULL WHERE id = ?\")\n            .bind(user.id)\n            .run();\n    }\n\n    // Return HTML Success Page\n    return new Response(`\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <title>Account Activated</title>\n        <style>\n          body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #121212; color: #fff; }\n          .container { text-align: center; padding: 40px; background: #1e1e1e; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }\n          h1 { color: #4caf50; }\n          p { color: #aaa; }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n           <h1>Account Activated!</h1>\n           <p>Your email has been verified successfully.</p>\n           <p>You can now return to the MetaBayn app and login.</p>\n        </div>\n      </body>\n      </html>\n    `, { headers: { 'Content-Type': 'text/html' } });\n}\n\nexport async function handleLogin(req: Request, env: Env) {\n  const body: any = await req.json();\n  const { email, password, device_hash } = body;\n\n  if (!device_hash) return Response.json({ error: \"Device Hash required\" }, { status: 400 });\n\n  const user = await env.DB.prepare(\"SELECT * FROM users WHERE email = ?\").bind(email).first();\n  if (!user) return Response.json({ error: \"Email not registered\" }, { status: 401 });\n\n  // CHECK STATUS (Strict: Must verify email)\n  if (user.status === 'pending') {\n      return Response.json({ error: \"Please verify your email address before logging in.\" }, { status: 403 });\n  }\n\n  const valid = await verifyPassword(password, user.password as string);\n  if (!valid) return Response.json({ error: \"Incorrect password\" }, { status: 401 });\n\n  // FORCE ADMIN for metabayn@gmail.com\n  if (user.email === 'metabayn@gmail.com') {\n     user.is_admin = 1;\n  }\n\n  // Check Subscription Expiry Logic\n  if (user.subscription_active === 1 && user.subscription_expiry) {\n      try {\n        const expiryTime = new Date(user.subscription_expiry as string).getTime();\n        if (Date.now() > expiryTime) {\n            // Expired! Update DB and local object\n            await env.DB.prepare(\"UPDATE users SET subscription_active = 0 WHERE id = ?\").bind(user.id).run();\n            user.subscription_active = 0;\n        }\n      } catch {}\n  }\n\n  try {\n      const existing = await env.DB.prepare(\"SELECT DISTINCT device_hash FROM auth_logs WHERE user_id = ? AND device_hash IS NOT NULL AND device_hash != ''\")\n          .bind(String(user.id))\n          .all();\n\n      const rows = Array.isArray(existing) ? existing : (existing.results || []);\n      const knownDevices = rows.map((r: any) => r.device_hash).filter((v: any) => typeof v === 'string' && v.length > 0);\n\n      const isKnown = knownDevices.includes(device_hash);\n\n      if (!isKnown && knownDevices.length >= 3) {\n          return Response.json({\n              error: \"This account has already been used on 3 different devices. Please contact support if you need to reset devices.\"\n          }, { status: 403 });\n      }\n  } catch (e) {\n      console.error(\"Device limit check failed\", e);\n  }\n\n  // --- ANTI CLONING LOGIC ---\n  let currentDeviceHash = user.device_hash;\n  \n  if (!currentDeviceHash) {\n    // First time login on a device, bind it!\n    await env.DB.prepare(\"UPDATE users SET device_hash = ? WHERE id = ?\").bind(device_hash, user.id).run();\n  } else if (currentDeviceHash !== device_hash) {\n    // Device mismatch! Block access.\n    // DISABLED PER USER REQUEST (Allow multiple devices for now)\n    // return Response.json({ error: \"SECURITY ALERT: Account is bound to another device. Anti-cloning protection active.\" }, { status: 403 });\n    \n    // Optional: Update to new device? Or just ignore?\n    // Let's just ignore the mismatch and allow login.\n    // Or maybe update it to the latest one so it tracks \"last used\"?\n    // For now, let's just NOT block.\n  }\n\n  const token = await createToken(user, env.JWT_SECRET);\n  \n  // Log Login\n  try {\n      const ip = req.headers.get(\"CF-Connecting-IP\") || \"unknown\";\n      await env.DB.prepare(\"INSERT INTO auth_logs (user_id, email, action, ip_address, device_hash, timestamp) VALUES (?, ?, 'login', ?, ?, ?)\")\n          .bind(user.id, user.email, ip, device_hash || 'unknown', Math.floor(Date.now()/1000))\n          .run();\n  } catch {}\n\n  return Response.json({\n    token,\n    user: {\n      id: user.id,\n      email: user.email,\n      tokens: user.tokens,\n      is_admin: user.is_admin || 0,\n      subscription_active: user.subscription_active,\n      subscription_expiry: user.subscription_expiry\n    }\n  });\n}\n\nexport async function handleGetMe(userId: number, env: Env) {\n  try {\n    const user = await env.DB.prepare(\"SELECT id, email, tokens, is_admin, subscription_active, subscription_expiry FROM users WHERE id = ?\").bind(userId).first();\n    if (!user) return Response.json({ error: \"User not found\" }, { status: 404 });\n    return Response.json(user);\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n", "import { Env } from '../types';\n\nexport async function sendEmail(to: string, subject: string, html: string, env: Env) {\n  if (!env.RESEND_API_KEY) {\n    console.warn(\"RESEND_API_KEY is missing. Skipping email.\");\n    // If strict mode is required, we should throw here, but for dev we might skip\n    throw new Error(\"Email service not configured (RESEND_API_KEY missing)\");\n  }\n\n  try {\n    const from = env.EMAIL_FROM && env.EMAIL_FROM.includes('<')\n      ? env.EMAIL_FROM\n      : `Metabayn Studio <${env.EMAIL_FROM || 'admin@albayn.site'}>`;\n    const res = await fetch('https://api.resend.com/emails', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${env.RESEND_API_KEY}`\n      },\n      body: JSON.stringify({\n        from: from,\n        reply_to: 'no-reply@albayn.site',\n        to: [to],\n        subject: subject,\n        html: html\n      })\n    });\n\n    if (!res.ok) {\n        const error = await res.text();\n        console.error(\"Resend API Error:\", error);\n        throw new Error(`Email delivery failed: ${error}`);\n    }\n  } catch (e: any) {\n    console.error(\"Failed to send email:\", e);\n    throw new Error(e.message || \"Failed to send email\");\n  }\n}\n\nexport function getTopupSuccessTemplate(amount: number, tokensAdded: number, currency: 'IDR' | 'USD' = 'IDR') {\n    const formattedAmount = currency === 'IDR' \n        ? `Rp ${amount.toLocaleString('id-ID')}`\n        : `$${amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;\n\n    return `\n    <div style=\"font-family: sans-serif; padding: 20px;\">\n        <h2>Top-Up Token Successful</h2>\n        <p>Hello,</p>\n        <p>We have received your payment of <strong>${formattedAmount}</strong>.</p>\n        <ul>\n            <li>Tokens Added: <strong>${tokensAdded.toLocaleString()} Tokens</strong></li>\n        </ul>\n        <p>Your balance has been updated. Happy creating!</p>\n        <hr style=\"border: 0; border-top: 1px solid #eee; margin: 20px 0;\">\n        <p style=\"font-size: 12px; color: #888; text-align: center;\">\n            This is an automated message, please do not reply.<br>\n            For support, join our <a href=\"https://chat.whatsapp.com/JD1KDEjKPV3Fp6fJMRz6qS\" style=\"color: #25D366; text-decoration: none;\">WhatsApp Community</a>.\n        </p>\n    </div>\n    `;\n}\n\nexport function getManualApproveTemplate(name: string, amount: number, tokensAdded: number, currency: 'IDR' | 'USD' = 'IDR') {\n    const formattedAmount = currency === 'IDR' \n        ? `Rp ${amount.toLocaleString('id-ID')}`\n        : `$${amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;\n\n    return `\n    <div style=\"font-family: sans-serif; padding: 20px;\">\n        <h2>Top-Up Successful (Manual Approval)</h2>\n        <p>Hello ${name},</p>\n        <p>Your transaction of <strong>${formattedAmount}</strong> has been manually confirmed by admin.</p>\n        <p>Tokens added to your account: <strong>${tokensAdded.toLocaleString()}</strong></p>\n        <p>Thank you for your patience!</p>\n        <hr style=\"border: 0; border-top: 1px solid #eee; margin: 20px 0;\">\n        <p style=\"font-size: 12px; color: #888; text-align: center;\">\n            This is an automated message, please do not reply.<br>\n            For support, join our <a href=\"https://chat.whatsapp.com/JD1KDEjKPV3Fp6fJMRz6qS\" style=\"color: #25D366; text-decoration: none;\">WhatsApp Community</a>.\n        </p>\n    </div>\n    `;\n}\n\nexport function getVerificationTemplate(email: string, pass: string, confirmLink: string) {\n    return `\n    <div style=\"font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; border: 1px solid #eee; border-radius: 8px;\">\n        <div style=\"text-align: center; margin-bottom: 20px;\">\n             <h2 style=\"color: #333;\">Welcome to Metabayn Studio!</h2>\n        </div>\n        <p>Hello,</p>\n        <p>Thank you for registering. To activate your account, please click the button below:</p>\n        \n        <div style=\"text-align: center; margin: 30px 0;\">\n            <a href=\"${confirmLink}\" style=\"background-color: #4CAF50; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px; font-weight: bold; font-size: 16px;\">Verify Email Address</a>\n        </div>\n\n        <p>If the button doesn't work, you can copy and paste this link into your browser:</p>\n        <p style=\"font-size: 12px; color: #666; word-break: break-all;\">${confirmLink}</p>\n        \n        <hr style=\"border: 0; border-top: 1px solid #eee; margin: 20px 0;\">\n\n        <p><strong>Your Account Credentials:</strong></p>\n        <ul style=\"background: #f9f9f9; padding: 15px; border-radius: 4px; list-style: none;\">\n            <li style=\"margin-bottom: 8px;\"><strong>Email:</strong> ${email}</li>\n            <li><strong>Password:</strong> ${pass}</li>\n        </ul>\n        <p style=\"color: #d32f2f; font-size: 12px;\">*Please keep this information safe. Do not share your password with anyone.</p>\n\n        <br>\n        <p>Best regards,</p>\n        <p>Metabayn Studio Team</p>\n\n        <hr style=\"border: 0; border-top: 1px solid #eee; margin: 20px 0;\">\n        <p style=\"font-size: 12px; color: #888; text-align: center;\">\n            This is an automated message, please do not reply to this email.<br>\n            For support and updates, please join our <a href=\"https://chat.whatsapp.com/JD1KDEjKPV3Fp6fJMRz6qS\" style=\"color: #25D366; text-decoration: none;\">WhatsApp Community</a>.\n        </p>\n    </div>\n    `;\n}\n\nexport function getWelcomeTemplate(email: string) {\n    return `\n    <div style=\"font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; border: 1px solid #eee; border-radius: 8px;\">\n        <div style=\"text-align: center; margin-bottom: 20px;\">\n             <h2 style=\"color: #333;\">Verification Successful!</h2>\n        </div>\n        <p>Hello,</p>\n        <p>Congratulations! Your email has been verified and your account is now active.</p>\n        <p>You can now login to the Metabayn Studio application.</p>\n\n        <hr style=\"border: 0; border-top: 1px solid #eee; margin: 20px 0;\">\n\n        <p><strong>Join Our Community</strong></p>\n        <p>Connect with other users, get updates, and share your experience in our WhatsApp Group:</p>\n        \n        <div style=\"text-align: center; margin: 20px 0;\">\n            <a href=\"https://chat.whatsapp.com/JD1KDEjKPV3Fp6fJMRz6qS\" style=\"background-color: #25D366; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px; font-weight: bold; font-size: 16px;\">Join WhatsApp Group</a>\n        </div>\n        \n        <br>\n        <p>Best regards,</p>\n        <p>Metabayn Studio Team</p>\n\n        <hr style=\"border: 0; border-top: 1px solid #eee; margin: 20px 0;\">\n        <p style=\"font-size: 12px; color: #888; text-align: center;\">\n            This is an automated message, please do not reply to this email.<br>\n            For support and updates, please join our <a href=\"https://chat.whatsapp.com/JD1KDEjKPV3Fp6fJMRz6qS\" style=\"color: #25D366; text-decoration: none;\">WhatsApp Community</a>.\n        </p>\n    </div>\n    `;\n}\n\nexport function getRegistrationTemplate(email: string, pass: string, confirmLink: string) {\n    // DEPRECATED: Kept for backward compatibility if needed, but redirects to verification template\n    return getVerificationTemplate(email, pass, confirmLink);\n}\n\nexport function getGoogleWelcomeTemplate(email: string, pass: string) {\n    return `\n    <div style=\"font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; border: 1px solid #eee; border-radius: 8px;\">\n        <div style=\"text-align: center; margin-bottom: 20px;\">\n             <h2 style=\"color: #333;\">Welcome to Metabayn Studio!</h2>\n        </div>\n        <p>Hello,</p>\n        <p>Thank you for logging in with Google. Your account is now active.</p>\n        \n        <hr style=\"border: 0; border-top: 1px solid #eee; margin: 20px 0;\">\n\n        <p><strong>Your Account Credentials:</strong></p>\n        <p>We have generated a password for you if you wish to login manually later:</p>\n        <ul style=\"background: #f9f9f9; padding: 15px; border-radius: 4px; list-style: none;\">\n            <li style=\"margin-bottom: 8px;\"><strong>Email:</strong> ${email}</li>\n            <li><strong>Password:</strong> ${pass}</li>\n        </ul>\n        <p style=\"color: #d32f2f; font-size: 12px;\">*Please keep this information safe. Do not share your password with anyone.</p>\n        \n        <br>\n        <p>Best regards,</p>\n        <p>Metabayn Studio Team</p>\n    </div>\n    `;\n}\n\nexport function getPurchaseVoucherTemplate(email: string, voucherCode: string, type: 'token' | 'subscription', value: number) {\n  const title = type === 'subscription' \n      ? `${value} Days Subscription Voucher` \n      : `${value.toLocaleString()} Tokens Voucher`;\n\n  const description = type === 'subscription'\n      ? `You have successfully purchased a <strong>${value} Days Subscription</strong>.`\n      : `You have successfully purchased <strong>${value.toLocaleString()} Tokens</strong>.`;\n\n  return `\n  <div style=\"font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; border: 1px solid #eee; border-radius: 8px;\">\n      <div style=\"text-align: center; margin-bottom: 20px;\">\n           <h2 style=\"color: #333;\">Payment Successful</h2>\n      </div>\n  \n      <p>Hi ${email},</p>\n      <p>\n        Thank you for your purchase. We have received your payment from Lynk.id.\n        ${description}\n      </p>\n  \n      <h3>Your Voucher Code</h3>\n      <div style=\"background: #f5f5f5; padding: 12px 16px; border-radius: 4px; text-align: center; margin: 10px 0 20px 0;\">\n        <span style=\"font-size: 20px; letter-spacing: 3px; font-weight: bold; color: #222;\">\n          ${voucherCode}\n        </span>\n      </div>\n  \n      <p style=\"color: #d32f2f; font-size: 12px; margin-top: -8px;\">\n        * This voucher is valid for one-time use only.\n      </p>\n  \n      <h3>How to Redeem</h3>\n      <ol>\n        <li>Open <strong>Metabayn Studio</strong> app.</li>\n        <li>Go to <strong>Voucher / Redeem</strong> menu.</li>\n        <li>Enter the code above and click Redeem.</li>\n      </ol>\n  \n      <br>\n      <p>Best regards,</p>\n      <p><strong>Metabayn Studio Team</strong></p>\n  \n      <hr style=\"border: 0; border-top: 1px solid #eee; margin: 20px 0;\">\n      <p style=\"font-size: 12px; color: #888; text-align: center;\">\n        This is an automated message, please do not reply.<br>\n        For support, join our <a href=\"https://chat.whatsapp.com/JD1KDEjKPV3Fp6fJMRz6qS\" style=\"color: #25D366; text-decoration: none;\">WhatsApp Community</a>.\n      </p>\n  </div>\n  `;\n}\n\nexport function getWelcomeVoucherTemplate(email: string, voucherCode: string, amountTokens: number) {\n    return `\n    <div style=\"font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; border: 1px solid #eee; border-radius: 8px;\">\n        <div style=\"text-align: center; margin-bottom: 20px;\">\n             <h2 style=\"color: #333;\">Thank You for Purchasing Metabayn Studio</h2>\n        </div>\n\n        <p>Hi ${email},</p>\n        <p>\n          Thank you for purchasing <strong>Metabayn Studio</strong>.\n          As a welcome bonus, you receive free credits worth <strong>$3</strong> that you can use inside the app.\n        </p>\n\n        <h3>Your One-Time Voucher Code</h3>\n        <div style=\"background: #f5f5f5; padding: 12px 16px; border-radius: 4px; text-align: center; margin: 10px 0 20px 0;\">\n          <span style=\"font-size: 20px; letter-spacing: 3px; font-weight: bold; color: #222;\">\n            ${voucherCode}\n          </span>\n        </div>\n\n        <p style=\"color: #d32f2f; font-size: 12px; margin-top: -8px;\">\n          * This voucher can only be used once. Please keep it private and do not share it with others.\n        </p>\n\n        <h3>How to Use Your Voucher</h3>\n        <ol>\n          <li>Download and install the Metabayn Studio application.</li>\n          <li>Open the app and create a new account (Register).</li>\n          <li>Verify your email address by clicking the verification link sent to your inbox.</li>\n          <li>After login, open the <strong>Voucher / Redeem</strong> menu inside the app.</li>\n          <li>Enter the voucher code above and confirm.</li>\n        </ol>\n\n        <p>\n          Once redeemed, your token balance will be updated automatically and you can start using Metabayn Studio right away.\n        </p>\n\n        <br>\n        <p>Best regards,</p>\n        <p><strong>Metabayn Studio Team</strong></p>\n\n        <hr style=\"border: 0; border-top: 1px solid #eee; margin: 20px 0;\">\n        <p style=\"font-size: 12px; color: #888; text-align: center;\">\n          This is an automated message, please do not reply to this email.<br>\n          For support and updates, please join our <a href=\"https://chat.whatsapp.com/JD1KDEjKPV3Fp6fJMRz6qS\" style=\"color: #25D366; text-decoration: none;\">WhatsApp Community</a>.\n        </p>\n    </div>\n    `;\n}\n\nexport function getWelcomeDualVoucherTemplate(email: string, tokenCode: string, amountTokens: number, subscriptionCode: string, durationDays: number) {\n  return `\n  <div style=\"font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; border: 1px solid #eee; border-radius: 8px;\">\n      <div style=\"text-align: center; margin-bottom: 20px;\">\n           <h2 style=\"color: #333;\">Thank You for Purchasing Metabayn Studio</h2>\n      </div>\n\n      <p>Hi ${email},</p>\n      <p>\n        As a welcome bonus, you receive <strong>$3</strong> worth of tokens and a <strong>${durationDays} Days API Key Subscription</strong>.\n      </p>\n\n      <h3>Your Token Voucher Code</h3>\n      <div style=\"background: #f5f5f5; padding: 12px 16px; border-radius: 4px; text-align: center; margin: 10px 0 20px 0;\">\n        <span style=\"font-size: 20px; letter-spacing: 3px; font-weight: bold; color: #222;\">\n          ${tokenCode}\n        </span>\n      </div>\n      <p>You will receive <strong>${amountTokens.toLocaleString()} Tokens</strong> after redeeming this voucher.</p>\n\n      <h3>Your Subscription Voucher Code</h3>\n      <div style=\"background: #f5f5f5; padding: 12px 16px; border-radius: 4px; text-align: center; margin: 10px 0 20px 0;\">\n        <span style=\"font-size: 20px; letter-spacing: 3px; font-weight: bold; color: #222;\">\n          ${subscriptionCode}\n        </span>\n      </div>\n      <p>Redeem this voucher to activate <strong>${durationDays} Days</strong> of API Key mode subscription.</p>\n\n      <p style=\"color: #d32f2f; font-size: 12px; margin-top: -8px;\">\n        * Each voucher is valid for one-time use only.\n      </p>\n\n      <h3>How to Redeem</h3>\n      <ol>\n        <li>Open <strong>Metabayn Studio</strong> app.</li>\n        <li>Go to <strong>Voucher / Redeem</strong> menu.</li>\n        <li>Enter the code above and click Redeem.</li>\n      </ol>\n\n      <br>\n      <p>Best regards,</p>\n      <p><strong>Metabayn Studio Team</strong></p>\n\n      <hr style=\"border: 0; border-top: 1px solid #eee; margin: 20px 0;\">\n      <p style=\"font-size: 12px; color: #888; text-align: center;\">\n        This is an automated message, please do not reply.<br>\n        For support, join our <a href=\"https://chat.whatsapp.com/JD1KDEjKPV3Fp6fJMRz6qS\" style=\"color: #25D366; text-decoration: none;\">WhatsApp Community</a>.\n      </p>\n  </div>\n  `;\n}\n", "import { Env } from '../types';\nimport { MODEL_CONFIG } from '../config/models';\nimport { checkRateLimit } from '../utils/userRateLimiter';\nimport { acquireLock, releaseLock } from '../utils/concurrencyLock';\nimport { enqueue } from '../utils/aiQueue';\nimport { waitTurn } from '../utils/providerThrottle';\nimport { checkDailyLimit } from '../utils/tokenDailyLimit';\nimport { calculateTokenCost, recordTokenUsage } from '../utils/tokenCostManager';\nimport { TOKEN_RATE_USD_TO_CREDIT, getLiveUsdRate } from '../utils/tokenTopup';\nimport { getFallbackChain } from '../utils/modelFallback';\nimport { getGoogleAccessToken } from '../lib/google-auth';\n\nexport async function handleGenerate(req: Request, userId: number, env: Env) {\n  // 0. Rate Limit & Concurrency Check\n  if (!checkRateLimit(userId)) {\n    return Response.json({ error: \"Too many requests. Please slow down.\" }, { status: 429 });\n  }\n\n  // LOCK DISABLED to allow parallel processing\n  const lockId = null; \n  // const lockId = acquireLock(userId);\n  // if (!lockId) {\n  //   return Response.json({ error: \"You already have a running job.\" }, { status: 409 });\n  // }\n\n  try {\n    const body: any = await req.json();\n    const { model, prompt, messages, image, mimeType } = body; \n    const userModel = model; // Keep reference to what user asked for\n\n    // 1. Cek Saldo\n    console.log(`[AI] Checking balance for ${userId}...`);\n    const user = await env.DB.prepare(\"SELECT tokens, is_admin FROM users WHERE id = ?\").bind(userId).first();\n    // REMOVED ADMIN BYPASS: User requested strict limit enforcement even for admin/testing.\n    // const isAdmin = user?.is_admin === 1; \n    \n    // Strict check: If tokens <= 0, STOP.\n    if (!user || (user.tokens as number) <= 0) {\n      return Response.json({ error: \"Insufficient balance. Please Top Up.\" }, { status: 402 });\n    }\n\n    // 0.1 Check Daily Limit (Async) - DISABLED BY USER REQUEST\n    // if (!isAdmin) {\n    //     const withinDailyLimit = await checkDailyLimit(userId, env);\n    //     if (!withinDailyLimit) {\n    //     return Response.json({ error: \"Daily token quota reached.\" }, { status: 403 });\n    //     }\n    // }\n\n    // Get Fallback Chain\n    const fallbackChain = [userModel];\n    console.log(`[AI] Fallback chain for ${userModel}:`, fallbackChain);\n\n    // 3. ENQUEUE JOB with Retry Loop\n    const aiTask = async () => {\n      let lastError: any = null;\n      const startTime = Date.now();\n      const MAX_DURATION = 10000;\n\n      for (const currentModel of fallbackChain) {\n        if (Date.now() - startTime > MAX_DURATION) {\n            console.error(`[AI] Job timed out after ${MAX_DURATION}ms`);\n            throw new Error(\"Job timed out.\");\n        }\n\n        try {\n            console.log(`[AI] Attempting model: ${currentModel}`);\n            \n            // Get provider info for the CURRENT model in the chain\n            let currentProvider = 'openai'; // Default\n            let modelInfo = MODEL_CONFIG.models[currentModel];\n            \n            if (modelInfo) {\n                currentProvider = modelInfo.provider;\n            } else {\n                // Try to guess from name if not in static config (for dynamic models)\n                if (currentModel.startsWith('gemini')) currentProvider = 'gemini';\n                else if (currentModel.startsWith('claude')) currentProvider = 'anthropic';\n                // else default openai\n            }\n            \n            console.log(`[AI] Provider Selection: Model=${currentModel} -> Provider=${currentProvider}`);\n\n            await waitTurn(currentProvider);\n\n            let content = \"\";\n            let inputTokens = 0;\n            let outputTokens = 0;\n\n            const selectionMode = !!body.selectionMode;\n            if (currentProvider === 'openai') {\n                console.log(`[DEBUG] OpenAI Image Mode. Prompt len: ${prompt?.length}, Image len: ${image?.length}`);\n                \n                let msgs = messages;\n                if (!msgs) {\n                if (image) {\n                    msgs = [{\n                    role: \"user\",\n                    content: [\n                        { type: \"text\", text: (prompt && prompt.length > 50000) ? (prompt.substring(0, 1000) + \"... [TRUNCATED]\") : (prompt || \"Describe this image\") },\n                        { type: \"image_url\", image_url: { \n                            url: `data:${mimeType || 'image/jpeg'};base64,${image}`,\n                            detail: \"low\" \n                        } }\n                    ]\n                    }];\n                } else {\n                    msgs = [{role: \"user\", content: prompt}];\n                }\n                }\n\n                const controller = new AbortController();\n                const timeoutId = setTimeout(() => controller.abort(), 9000);\n                \n                try {\n                    const res = await fetch(\"https://api.openai.com/v1/chat/completions\", {\n                        method: \"POST\",\n                        headers: { \"Authorization\": `Bearer ${env.OPENAI_API_KEY}`, \"Content-Type\": \"application/json\" },\n                        body: JSON.stringify({ model: currentModel, messages: msgs }),\n                        signal: controller.signal\n                    });\n                    clearTimeout(timeoutId);\n                    \n                    const data: any = await res.json();\n                    \n                    if (!res.ok) {\n                        if (res.status >= 500 || res.status === 429) {\n                            throw new Error(`[${res.status}] ${data.error?.message || 'Provider Error'}`);\n                        }\n                        // For 400 errors, stop immediately (don't fallback)\n                        throw new Error(`NON_RETRYABLE: [${res.status}] ${data.error?.message}`);\n                    }\n                    \n                    content = data.choices[0].message.content;\n                    inputTokens = data.usage.prompt_tokens;\n                    outputTokens = data.usage.completion_tokens;\n                } catch(e: any) {\n                    console.error(`[AI] OpenAI Error: ${e.message}`);\n                    clearTimeout(timeoutId);\n                    throw e;\n                }\n\n            } else if (currentProvider === 'gemini') {\n                // Check if Vertex AI is configured, otherwise fallback to API Key\n                let useVertex = false;\n                if (env.GOOGLE_PROJECT_ID && env.GOOGLE_CLIENT_EMAIL && env.GOOGLE_PRIVATE_KEY) {\n                    useVertex = true;\n                }\n\n                // CRITICAL FIX: Force Legacy API (AI Studio) for Gemini 2.0 & Flash Lite\n                // REMOVED: We now try Vertex AI first and fallback to Legacy if 404.\n                // This ensures we use Enterprise infrastructure whenever possible.\n\n                // NORMALIZE MODEL NAMES\n                let targetModel = currentModel;\n                if (targetModel === 'gemini-2.0-flash-lite') {\n                    targetModel = 'gemini-2.0-flash-lite-preview-02-05';\n                } else if (targetModel === 'gemini-flash') {\n                    targetModel = 'gemini-1.5-flash';\n                }\n\n                const parts: any[] = [{ text: prompt || \"Describe this image\" }];\n                if (image) {\n                    parts.push({\n                        inline_data: {\n                            mime_type: mimeType || 'image/jpeg',\n                            data: image\n                        }\n                    });\n                }\n\n                const controller = new AbortController();\n                const timeoutId = setTimeout(() => controller.abort(), 9000);\n\n                try {\n                    // Helper for Legacy API Call\n                    const callLegacyApi = async (modelId: string) => {\n                         const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${env.GEMINI_API_KEY}`;\n                         return fetch(url, {\n                             method: \"POST\",\n                             headers: { \"Content-Type\": \"application/json\" },\n                             body: JSON.stringify({ contents: [{ parts: parts }] }),\n                             signal: controller.signal\n                         });\n                    };\n\n                    let res;\n                    if (useVertex) {\n                        // VERTEX AI PATH\n                        const accessToken = await getGoogleAccessToken(\n                            env.GOOGLE_CLIENT_EMAIL,\n                            env.GOOGLE_PRIVATE_KEY\n                        );\n                        \n                        const location = env.GOOGLE_LOCATION || 'us-central1';\n                        \n                        // FIX: Normalize Model ID for Vertex AI (Updated Dec 2025)\n                        // Use base names to let Google resolve to default stable version\n                        let vertexModelId = targetModel;\n                        \n                        // REMOVED explicit mapping to 001/002 to avoid 404s\n                        // Vertex AI should resolve 'gemini-1.5-flash' to the latest available version in the region\n\n                        const vertexUrl = `https://${location}-aiplatform.googleapis.com/v1/projects/${env.GOOGLE_PROJECT_ID}/locations/${location}/publishers/google/models/${vertexModelId}:generateContent`;\n\n                        res = await fetch(vertexUrl, {\n                            method: \"POST\",\n                            headers: { \n                                \"Content-Type\": \"application/json\",\n                                \"Authorization\": `Bearer ${accessToken}`\n                            },\n                            body: JSON.stringify({ \n                                contents: [{ role: \"user\", parts: parts }] \n                            }),\n                            signal: controller.signal\n                        });\n\n                        // AUTO-FALLBACK: If Vertex returns 404 (Model Not Found) or 400 (Bad Request - Invalid Argument), try Legacy API\n                        // This handles cases where a model is Preview-only (not in Vertex) or Region-restricted\n                        if (res.status === 404 || res.status === 400) {\n                            // Clone response to read text without consuming original if needed (though we discard it here)\n                            const errText = await res.text();\n                            // Check if it's actually a \"Not Found\" or \"Publisher Model\" error\n                            if (res.status === 404 || (res.status === 400 && errText.includes(\"Publisher Model\"))) {\n                                console.warn(`[AI] Vertex AI error for ${vertexModelId} (${res.status}): ${errText.substring(0, 100)}... Switching to Legacy API.`);\n                                res = await callLegacyApi(targetModel);\n                            } else {\n                                // Restore response body for downstream error handling if it wasn't a model availability issue\n                                // Since we consumed body, we must re-construct a response or throw immediately\n                                throw new Error(`[${res.status}] Vertex AI Error: ${errText}`);\n                            }\n                        }\n\n                    } else {\n                        // LEGACY API KEY PATH\n                        res = await callLegacyApi(targetModel);\n                    }\n\n                    clearTimeout(timeoutId);\n                    const data: any = await res.json();\n                    \n                    if (!res.ok) {\n                         // Common error handling\n                         const errMsg = data.error?.message || JSON.stringify(data.error) || 'Provider Error';\n                         if (res.status >= 500 || res.status === 429) {\n                            throw new Error(`[${res.status}] ${errMsg}`);\n                         }\n                         throw new Error(`NON_RETRYABLE: [${res.status}] ${errMsg}`);\n                    }\n\n                    if (data.error) throw new Error(`[${res.status}] ${data.error.message}`);\n\n                    // Vertex & AI Studio response structure is very similar\n                    const candidate = data.candidates?.[0];\n                    if (!candidate) {\n                        // Check if it's a prompt feedback block (safety)\n                        if (data.promptFeedback?.blockReason) {\n                             throw new Error(`Blocked by Safety Filters: ${data.promptFeedback.blockReason}`);\n                        }\n                        throw new Error(\"No response candidates from AI provider.\");\n                    }\n\n                    if (candidate.finishReason === \"SAFETY\" || candidate.finishReason === \"BLOCKLIST\" || candidate.finishReason === \"PROHIBITED_CONTENT\") {\n                        throw new Error(`Blocked by Safety Filters (${candidate.finishReason})`);\n                    }\n\n                    if (!candidate.content?.parts?.[0]?.text) {\n                        throw new Error(`Empty response from AI (Finish Reason: ${candidate.finishReason || 'Unknown'})`);\n                    }\n\n                    content = candidate.content.parts[0].text;\n                    inputTokens = data.usageMetadata?.promptTokenCount || Math.ceil((prompt || \"\").length / 4);\n                    outputTokens = data.usageMetadata?.candidatesTokenCount || Math.ceil(content.length / 4);\n\n                } catch(e: any) {\n                    console.error(`[AI] Gemini/Vertex Error: ${e.message}`);\n                    clearTimeout(timeoutId);\n                    throw e;\n                }\n            }\n            \n            // Success! Return result\n            return { content, inputTokens, outputTokens, usedModel: currentModel };\n\n        } catch (e: any) {\n            console.error(`[AI] Error with model ${currentModel}:`, e.message);\n            lastError = e;\n            \n            // Stop if error is explicitly non-retryable\n            if (e.message.includes(\"NON_RETRYABLE\")) {\n                throw e; // Break loop and fail\n            }\n            \n            // Otherwise, continue loop to next model\n            continue;\n        }\n      }\n      \n      // If we exit loop, all failed\n      throw lastError || new Error(\"All model providers are temporarily busy.\");\n    };\n\n    // EXECUTE VIA QUEUE\n    let result;\n    try {\n        result = await enqueue(aiTask);\n    } catch (e: any) {\n        // Clean up error message for user\n        const msg = e.message.replace(\"NON_RETRYABLE: \", \"\");\n        return Response.json({ error: msg }, { status: 502 });\n    }\n\n    const { content, inputTokens, outputTokens, usedModel } = result;\n\n    // 4. Hitung Biaya & Profit (DYNAMIC PRICING FROM DB)\n    // CRITICAL: Calculate cost based on USER MODEL (userModel), not usedModel (Rule #2)\n    // Profit Margin Strategy: 50% - 70%\n    let costFinal = 0;\n    try {\n      costFinal = await calculateTokenCost(inputTokens, outputTokens, userModel, env);\n      console.log(`[Cost] Model: ${userModel}, In: ${inputTokens}, Out: ${outputTokens}, Cost: ${costFinal}`);\n      \n      // SAFETY CAP: Prevent astronomical costs due to bugs or huge inputs\n      // Cap at $0.25 per request (approx Rp 4.000)\n      if (costFinal > 0.25) {\n          console.warn(`[Cost] Cost exceeded safety cap ($${costFinal}). Capping at $0.25.`);\n          costFinal = 0.25;\n      }\n      \n    } catch (e: any) {\n       console.error(\"Pricing DB Error:\", e);\n       // Fallback logic for pricing\n       // Default to 60% profit margin for safety if DB config is missing\n       let profitMarginPercent = 60;\n       try {\n            const config = await env.DB.prepare(\"SELECT value FROM app_config WHERE key = 'profit_margin_percent'\").first();\n            if (config && config.value) {\n                profitMarginPercent = Number(config.value);\n            }\n       } catch {}\n       \n       const profitMultiplier = 1 + (profitMarginPercent / 100);\n\n       // Try to get static price for userModel from MODEL_CONFIG\n       const staticModel = MODEL_CONFIG.models[userModel];\n       if (staticModel) {\n            const costRaw = ((inputTokens / 1_000_000) * staticModel.input) + ((outputTokens / 1_000_000) * staticModel.output);\n            costFinal = costRaw * profitMultiplier;\n            console.log(`[Cost Fallback] Model: ${userModel}, Raw: ${costRaw}, Multiplier: ${profitMultiplier}, Final: ${costFinal}`);\n       } else {\n            // Extreme fallback: Assume high cost ($5/1M) to prevent loss\n            const safePrice = 5.0; \n            costFinal = ((inputTokens + outputTokens) / 1_000_000) * safePrice * profitMultiplier; \n            console.log(`[Cost Extreme Fallback] Model: ${userModel}, Price: ${safePrice}, Final: ${costFinal}`);\n       }\n       \n       // SAFETY CAP for Fallback too\n       if (costFinal > 0.25) {\n           console.warn(`[Cost Fallback] Cost exceeded safety cap ($${costFinal}). Capping at $0.25.`);\n           costFinal = 0.25;\n       }\n    }\n\n    // 5. Deduksi Saldo & Simpan History (Atomic Transaction)\n    // Note: We record 'userModel' in history to match the cost calculation basis.\n    // REMOVED !isAdmin CHECK - Admin also pays tokens now for testing/tracking purposes.\n    \n    // CONVERT USD COST TO TOKENS (CREDITS)\n    // costFinal is in USD. We need to convert to our Token unit (IDR-pegged).\n    // Rate: 1 USD = ~16,000 Tokens (Credits) - Real-time\n    const currentRate = await getLiveUsdRate(env);\n    const costInTokens = costFinal * currentRate;\n    \n    // Ensure cost is at least minimal to register a change\n    const deductAmount = Math.max(costInTokens, 1); // Minimum 1 Token (Rp 1) deduction\n    \n    console.log(`[AI] Deducting ${deductAmount} Tokens (from $${costFinal}) from User ${userId}...`);\n    // Prevent negative balance: only deduct if user has enough tokens to cover the cost\n    const deductRes = await env.DB\n      .prepare(\"UPDATE users SET tokens = tokens - ? WHERE id = ? AND tokens >= ? RETURNING tokens\")\n      .bind(deductAmount, userId, deductAmount)\n      .first();\n\n    if (!deductRes || typeof deductRes.tokens !== 'number') {\n      // Abort: do not allow negative balance, return error with current balance\n      const currentBal = await env.DB.prepare(\"SELECT tokens FROM users WHERE id = ?\").bind(userId).first();\n      return Response.json({ \n        error: \"Insufficient balance. Process cancelled to prevent negative balance.\",\n        required_tokens: Math.ceil(deductAmount),\n        user_balance: (currentBal?.tokens as number) || 0\n      }, { status: 402 });\n    }\n\n    // Record history with actual model used (and cost in USD for reporting)\n    // We store cost in USD in the history table for financial tracking\n    await recordTokenUsage(userId, userModel, usedModel, inputTokens, outputTokens, costFinal, env);\n\n    // 6. Ambil sisa saldo dari RETURNING\n    const updatedUserTokens = deductRes.tokens as number;\n\n    // 7. Response Ideal\n    return Response.json({\n      status: \"success\",\n      model_chosen: userModel,\n      model_used: usedModel,\n      input_tokens: inputTokens,\n      output_tokens: outputTokens,\n      cost: costFinal,\n      user_balance_after: updatedUserTokens,\n      result: content, // Keep 'result' for backward compatibility or change to 'metadata' if desired, but 'result' is standard here\n      metadata: {\n        provider: body.useGroq ? 'groq' : (usedModel.startsWith('gpt') ? 'openai' : 'gemini'),\n        finish_reason: \"stop\" // Simplified\n      }\n    });\n  } finally {\n    if (lockId) releaseLock(userId, lockId);\n  }\n}\n", "export const MODEL_CONFIG: any = {\n  \"profit_multiplier_min\": 1.6,\n  \"profit_multiplier_max\": 1.8,\n  \"safety_buffer\": 1.10,\n  \"usd_per_credit\": 0.0001,\n\n  \"models\": {\n    \"gpt-4.1\": {\n      \"provider\": \"openai\",\n      \"input\": 3.00,\n      \"output\": 12.00,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gpt-4o\": {\n      \"provider\": \"openai\",\n      \"input\": 2.50,\n      \"output\": 10.00,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gpt-4o-mini\": {\n      \"provider\": \"openai\",\n      \"input\": 0.15,\n      \"output\": 0.60,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gpt-4o-realtime\": {\n      \"provider\": \"openai\",\n      \"input\": 5.00,\n      \"output\": 20.00,\n      \"official\": true,\n      \"enabled\": false\n    },\n    \"gpt-4-turbo\": {\n      \"provider\": \"openai\",\n      \"input\": 10.00,\n      \"output\": 30.00,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"o3\": {\n      \"provider\": \"openai\",\n      \"input\": 4.00,\n      \"output\": 16.00,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"o4-mini\": {\n      \"provider\": \"openai\",\n      \"input\": 0.20,\n      \"output\": 0.80,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"o1\": {\n      \"provider\": \"openai\",\n      \"input\": 15.00,\n      \"output\": 60.00,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gemini-2.5-pro\": {\n      \"provider\": \"gemini\",\n      \"input\": 1.25,\n      \"output\": 10.00,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gemini-2.5-flash\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.30,\n      \"output\": 2.50,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gemini-2.5-flash-lite\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.10,\n      \"output\": 0.40,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gemini-2.5-ultra\": {\n      \"provider\": \"gemini\",\n      \"input\": 2.50,\n      \"output\": 12.00,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gemini-1.5-pro\": {\n      \"provider\": \"gemini\",\n      \"input\": 3.50,\n      \"output\": 10.50,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-1.5-flash\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.075,\n      \"output\": 0.30,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-1.5-flash-8b\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.0375,\n      \"output\": 0.15,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-2.0-pro\": {\n      \"provider\": \"gemini\",\n      \"input\": 3.50,\n      \"output\": 10.50,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-2.0-pro-exp-02-05\": {\n      \"provider\": \"gemini\",\n      \"input\": 3.50,\n      \"output\": 10.50,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-2.0-flash\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.10,\n      \"output\": 0.40,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-2.0-flash-exp\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.10,\n      \"output\": 0.40,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-2.0-flash-lite\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.075,\n      \"output\": 0.30,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-2.0-flash-lite-preview-02-05\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.075,\n      \"output\": 0.30,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-2.0-ultra\": {\n      \"provider\": \"gemini\",\n      \"input\": 2.50,\n      \"output\": 12.00,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gemini-3.0-flash-preview\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.35,\n      \"output\": 3.00,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-3.0-pro-preview\": {\n      \"provider\": \"gemini\",\n      \"input\": 1.50,\n      \"output\": 8.00,\n      \"official\": false,\n      \"enabled\": true\n    },\n    \"gemini-3.0-ultra\": {\n      \"provider\": \"gemini\",\n      \"input\": 4.00,\n      \"output\": 12.00,\n      \"official\": true,\n      \"enabled\": true\n    },\n    \"gemini-pro\": {\n      \"provider\": \"gemini\",\n      \"input\": 0.50,\n      \"output\": 1.50,\n      \"official\": false,\n      \"enabled\": true\n    }\n  }\n};\n", "// Simple in-memory rate limiter per worker instance\n// Note: This only limits requests hitting the SAME worker instance.\n// For global limits across distributed workers, we would need Cloudflare KV or Durable Objects.\n// However, for preventing simple \"double-click\" or \"burst\" spam, this is effective.\n\nconst requestHistory = new Map<number, number>();\n\n// Default: 1 request per 100ms (Fast burst allowed, Concurrency Lock will handle the rest)\nconst RATE_LIMIT_MS = 10;\n\nexport function checkRateLimit(userId: number): boolean {\n  const now = Date.now();\n  const lastRequest = requestHistory.get(userId) || 0;\n\n  if (now - lastRequest < RATE_LIMIT_MS) {\n    return false; // Rate limit exceeded\n  }\n\n  requestHistory.set(userId, now);\n  \n  // Simple cleanup to prevent memory leak\n  if (requestHistory.size > 5000) {\n      // If map grows too large, clear it. \n      // This resets limits for everyone but prevents OOM.\n      requestHistory.clear(); \n  }\n  \n  return true;\n}\n", "// Simple in-memory concurrency lock per worker instance\n// Ensures a user only has limited active AI jobs at a time on this worker.\n\nconst activeJobs = new Map<number, Set<string>>(); // userId -> Set of lockIds\n\n// Max job duration (TTL) just in case a job crashes or hangs without releasing lock\nconst LOCK_TTL_MS = 60 * 1000; // 1 minute\nconst MAX_CONCURRENT_JOBS = 5; // Allow up to 5 concurrent jobs\n\n// Map to track creation time of locks for TTL cleanup\nconst lockTimestamps = new Map<string, number>();\n\nexport function acquireLock(userId: number): string | null {\n  const now = Date.now();\n  \n  if (!activeJobs.has(userId)) {\n    activeJobs.set(userId, new Set());\n  }\n  \n  const userJobs = activeJobs.get(userId)!;\n\n  // Cleanup expired locks first\n  for (const lockId of userJobs) {\n    const start = lockTimestamps.get(lockId);\n    if (!start || (now - start > LOCK_TTL_MS)) {\n      userJobs.delete(lockId);\n      lockTimestamps.delete(lockId);\n    }\n  }\n\n  if (userJobs.size >= MAX_CONCURRENT_JOBS) {\n    return null; // Too many active jobs\n  }\n\n  const lockId = `${userId}_${now}_${Math.random().toString(36).substr(2, 9)}`;\n  userJobs.add(lockId);\n  lockTimestamps.set(lockId, now);\n  \n  return lockId;\n}\n\nexport function releaseLock(userId: number, lockId: string): void {\n  const userJobs = activeJobs.get(userId);\n  if (userJobs) {\n    userJobs.delete(lockId);\n    lockTimestamps.delete(lockId);\n    if (userJobs.size === 0) {\n      activeJobs.delete(userId);\n    }\n  }\n}\n", "\ntype Task<T> = () => Promise<T>;\n\ninterface QueueItem<T> {\n  task: Task<T>;\n  resolve: (value: T | PromiseLike<T>) => void;\n  reject: (reason?: any) => void;\n}\n\n// Global queue in memory (per worker instance)\nconst queue: QueueItem<any>[] = [];\nlet activeCount = 0;\n// Cloudflare Workers often allow 6 concurrent subrequests. \n// OPTIMIZATION: Increased to 30 for high-throughput Flash models\n// Cloudflare supports up to 50 subrequests on Standard plan.\nconst CONCURRENCY_LIMIT = 100; \n\nexport function enqueue<T>(task: Task<T>): Promise<T> {\n  return new Promise((resolve, reject) => {\n    // Add timeout to queue itself (prevent infinite waiting)\n    const queueTimeout = setTimeout(() => {\n        // Remove from queue if still waiting\n        const index = queue.findIndex(i => i.resolve === resolve);\n        if (index !== -1) {\n            queue.splice(index, 1);\n            reject(new Error(\"Queue Timeout: System busy, please retry.\"));\n        }\n    }, 10000);\n\n    queue.push({ \n        task, \n        resolve: (val) => { clearTimeout(queueTimeout); resolve(val); }, \n        reject: (err) => { clearTimeout(queueTimeout); reject(err); } \n    });\n    \n    processQueue();\n  });\n}\n\nfunction processQueue() {\n  // While we have capacity and items in queue\n  while (activeCount < CONCURRENCY_LIMIT && queue.length > 0) {\n    const item = queue.shift();\n    if (item) {\n      activeCount++;\n      \n      // Execute task (Do NOT await here, let it run in background)\n      item.task()\n        .then((res) => {\n            item.resolve(res);\n        })\n        .catch((err) => {\n            item.reject(err);\n        })\n        .finally(() => {\n            activeCount--;\n            // When a task finishes, try to process the next one\n            processQueue();\n        });\n    }\n  }\n}\n", "\nconst lastRequestTime: Record<string, number> = {\n  openai: 0,\n  gemini: 0\n};\n\nconst INTERVALS: Record<string, number> = {\n  openai: 10,\n  gemini: 10,\n  groq: 10\n};\n\nexport async function waitTurn(provider: string) {\n  const now = Date.now();\n  const last = lastRequestTime[provider] || 0;\n  const interval = INTERVALS[provider] || 0;\n  \n  const timeSinceLast = now - last;\n  \n  if (timeSinceLast < interval) {\n    const delay = interval - timeSinceLast;\n    await new Promise(resolve => setTimeout(resolve, delay));\n  }\n  \n  // Update timestamp AFTER waiting (or immediately if no wait needed)\n  // This marks the \"start\" of the allowed slot.\n  lastRequestTime[provider] = Date.now();\n}\n", "import { Env } from '../types';\nimport { MODEL_CONFIG } from '../config/models';\n\n// HARDCODED PRICES TO PREVENT DB CORRUPTION/ERRORS\n// Base Price in USD per 1 Million Tokens\nconst SAFE_PRICES: Record<string, { input: number, output: number }> = {\n    // Gemini 2.0 Flash Lite (The user's target)\n    \"gemini-2.0-flash-lite\": { input: 0.075, output: 0.30 },\n    \"gemini-2.0-flash-lite-preview-02-05\": { input: 0.075, output: 0.30 },\n    \"gemini-1.5-flash-8b\": { input: 0.0375, output: 0.15 },\n    \n    // Gemini 2.0 Flash\n    \"gemini-2.0-flash\": { input: 0.10, output: 0.40 },\n    \"gemini-2.0-flash-exp\": { input: 0.10, output: 0.40 },\n    \n    // Gemini 1.5 Flash\n    \"gemini-1.5-flash\": { input: 0.075, output: 0.30 },\n    \"gemini-1.5-flash-001\": { input: 0.075, output: 0.30 },\n    \"gemini-1.5-flash-002\": { input: 0.075, output: 0.30 },\n    \n    // Gemini Pro\n    \"gemini-1.5-pro\": { input: 3.50, output: 10.50 },\n    \"gemini-1.5-pro-001\": { input: 3.50, output: 10.50 },\n    \"gemini-1.5-pro-002\": { input: 3.50, output: 10.50 },\n    \"gemini-2.0-pro\": { input: 3.50, output: 10.50 },\n    \"gemini-2.0-pro-exp-02-05\": { input: 3.50, output: 10.50 },\n\n    // Gemini 1.0\n    \"gemini-1.0-pro\": { input: 0.50, output: 1.50 },\n\n    // Gemini 2.5 (Hypothetical / Future)\n    \"gemini-2.5-pro\": { input: 1.25, output: 10.00 },\n    \"gemini-2.5-flash\": { input: 0.30, output: 2.50 },\n    \"gemini-2.5-flash-lite\": { input: 0.10, output: 0.40 },\n    \"gemini-2.5-ultra\": { input: 2.50, output: 12.00 },\n\n    // Gemini 3.0 (Preview)\n    \"gemini-3.0-flash-preview\": { input: 0.35, output: 3.00 },\n    \"gemini-3.0-pro-preview\": { input: 1.50, output: 8.00 },\n    \"gemini-3.0-ultra\": { input: 4.00, output: 12.00 },\n\n    // Gemini Ultra (2.0)\n    \"gemini-2.0-ultra\": { input: 2.50, output: 12.00 },\n    \n    // GPT-4o\n    \"gpt-4o\": { input: 2.50, output: 10.00 },\n    \"gpt-4o-mini\": { input: 0.15, output: 0.60 },\n\n    // OpenAI Next Gen (Estimates)\n    \"gpt-4.1\": { input: 2.50, output: 10.00 },\n    \"gpt-4.1-mini\": { input: 0.15, output: 0.60 },\n    \"gpt-4.1-distilled\": { input: 1.10, output: 4.40 },\n    \"gpt-5.1\": { input: 15.00, output: 60.00 },\n    \"gpt-5.1-mini\": { input: 3.00, output: 12.00 },\n    \"gpt-5.1-instant\": { input: 1.10, output: 4.40 },\n    \"o1\": { input: 15.00, output: 60.00 },\n    \"o3\": { input: 20.00, output: 80.00 },\n    \"o4-mini\": { input: 0.50, output: 2.00 },\n    \n    // Fallback default\n    \"default\": { input: 0.10, output: 0.40 } \n};\n\nexport async function calculateTokenCost(inputTokens: number, outputTokens: number, userModel: string, env: Env): Promise<number> {\n  // 1. DETERMINE BASE PRICE (USD PER 1 MILLION TOKENS)\n  let price = SAFE_PRICES[userModel];\n  \n  // TRY TO FETCH DYNAMIC PRICE FROM DB (model_prices table)\n  try {\n      const dbPrice = await env.DB.prepare(\"SELECT input_price, output_price, profit_multiplier FROM model_prices WHERE model_name = ? AND active = 1\").bind(userModel).first();\n      if (dbPrice) {\n          price = {\n              input: Number(dbPrice.input_price),\n              output: Number(dbPrice.output_price)\n          };\n          // Optional: We could use specific profit multiplier from model_prices too, but global config is safer for now\n          // to match user expectation of \"Global Profit Margin\"\n          console.log(`[Pricing] Using DB Price for ${userModel}: Input $${price.input}, Output $${price.output}`);\n      }\n  } catch (e) {\n      console.warn(`[Pricing] Failed to fetch DB price for ${userModel}, using safe fallback.`, e);\n  }\n\n  if (!price) {\n      // Try to find by partial match or fallback\n      if (userModel.includes(\"flash-lite\") || userModel.includes(\"8b\")) price = SAFE_PRICES[\"gemini-2.0-flash-lite\"];\n      else if (userModel.includes(\"flash\") && (userModel.includes(\"1.5\") || userModel.includes(\"001\") || userModel.includes(\"002\"))) price = SAFE_PRICES[\"gemini-1.5-flash\"];\n      else if (userModel.includes(\"flash\")) price = SAFE_PRICES[\"gemini-2.0-flash\"];\n      else if (userModel.includes(\"mini\")) price = SAFE_PRICES[\"gpt-4o-mini\"];\n      else if (userModel.includes(\"ultra\")) price = SAFE_PRICES[\"gemini-2.5-ultra\"]; // Safe high fallback\n      else if (userModel.includes(\"pro\")) price = SAFE_PRICES[\"gemini-1.5-pro\"];\n      else if (userModel.includes(\"gpt-4o\") || userModel.includes(\"gpt-4.1\")) price = SAFE_PRICES[\"gpt-4o\"];\n      else if (userModel.includes(\"gpt-5\") || userModel.includes(\"o1\") || userModel.includes(\"o3\")) price = SAFE_PRICES[\"gpt-5.1\"];\n      else price = SAFE_PRICES[\"default\"];\n      \n      console.warn(`[Pricing] Model '${userModel}' not found in safe list. Using fallback price: Input $${price.input}/1M`);\n  }\n\n  // 2. CALCULATE RAW COST (USD)\n  // Formula: (Tokens / 1,000,000) * Price_Per_1M\n  const inputCostUSD = (inputTokens / 1_000_000) * price.input;\n  const outputCostUSD = (outputTokens / 1_000_000) * price.output;\n  const rawCostUSD = inputCostUSD + outputCostUSD;\n\n  // 3. APPLY PROFIT MARGIN (Configurable)\n  // Fetch profit margin from DB or use default 60%\n  let profitMarginPercent = 60;\n  try {\n      const config = await env.DB.prepare(\"SELECT value FROM app_config WHERE key = 'profit_margin_percent'\").first();\n      if (config && config.value) {\n          profitMarginPercent = Number(config.value);\n      }\n  } catch (e) {\n      console.warn(\"[TokenCalc] Failed to fetch profit margin, using default 60%\", e);\n  }\n\n  // Multiplier = 1 + (Percent / 100)\n  // e.g. 60% -> 1.6\n  const PROFIT_MULTIPLIER = 1 + (profitMarginPercent / 100);\n  const finalCostUSD = rawCostUSD * PROFIT_MULTIPLIER;\n\n  // 4. LOGGING FOR DEBUGGING\n  console.log(`[TokenCalc] Model: ${userModel}`);\n  console.log(`[TokenCalc] Usage: ${inputTokens} In / ${outputTokens} Out`);\n  console.log(`[TokenCalc] Base Price (1M): $${price.input} / $${price.output}`);\n  console.log(`[TokenCalc] Raw Cost: $${rawCostUSD.toFixed(8)}`);\n  console.log(`[TokenCalc] Profit Margin: ${profitMarginPercent}% (x${PROFIT_MULTIPLIER})`);\n  console.log(`[TokenCalc] Final Cost: $${finalCostUSD.toFixed(8)}`);\n\n  return finalCostUSD;\n}\n\nexport async function recordTokenUsage(userId: number, userModel: string, actualModelUsed: string, inputTokens: number, outputTokens: number, cost: number, env: Env) {\n    try {\n        await env.DB.prepare(\"INSERT INTO history (user_id, model, input_tokens, output_tokens, cost) VALUES (?, ?, ?, ?, ?)\")\n            .bind(userId, userModel, inputTokens, outputTokens, cost)\n            .run();\n    } catch (e) {\n        console.error(\"Failed to record history:\", e);\n    }\n}\n\n// Deprecated but kept for compatibility if imported elsewhere\nexport async function getModelPrice(modelName: string, env: Env) {\n    let profit = 60;\n    try {\n        const config = await env.DB.prepare(\"SELECT value FROM app_config WHERE key = 'profit_margin_percent'\").first();\n        if (config) profit = Number(config.value);\n    } catch {}\n    \n    return {\n        input_price: SAFE_PRICES[modelName]?.input || 0.1,\n        output_price: SAFE_PRICES[modelName]?.output || 0.4,\n        profit_multiplier: 1 + (profit/100)\n    };\n}\n", "import { getExchangeRate } from './currency';\nimport { Env } from '../types';\n\n// Konfigurasi Rate dan Bonus\n\n// IDR: 1000 IDR = 1000 Token (Ratio 1:1)\n// UPDATE DEC 2025: Agar user merasa \"banyak\", kita kalikan 1000\n// $1 = 16,000 IDR\n// Harga Modal 1M Token (Lite) = $0.04 = Rp 640\n// Harga Jual 1M Token (Profit 60%) = $0.064 = Rp 1,024\n// Jadi 1 Rupiah dapat = 1,000,000 / 1,024 = ~976 Token\n// Kita bulatkan: 1 Rupiah = 1000 Token agar marketing mudah\nexport const TOKEN_RATE_IDR = 1; // 1 IDR = 1 Credit\nexport const TOKEN_RATE_IDR_TO_CREDIT = 1; // 1 Rupiah = 1 Credit\n\n// USD: 1 USD = 16,300 Credit (Fixed Rate)\nexport const TOKEN_RATE_USD_TO_CREDIT = 0; // Deprecated default; use admin setting 'usd_idr_rate'\n\nexport const BONUS_IDR_TABLE: Record<number, number> = {\n  100000: 3,  // Topup 100k -> Bonus 3%\n  200000: 5, // Topup 200k -> Bonus 5%\n  500000: 10  // Topup 500k -> Bonus 10%\n};\n\nexport const BONUS_USD_TABLE: Record<number, number> = {\n  10: 3,  // $10 -> Bonus 3%\n  20: 5, // $20 -> Bonus 5%\n  50: 10  // $50 -> Bonus 10%\n};\n\n// Legacy compatibility\nexport const TOKEN_RATE = TOKEN_RATE_IDR_TO_CREDIT;\nexport const BONUS_TABLE = BONUS_IDR_TABLE;\n\nexport async function getLiveUsdRate(env?: Env): Promise<number> {\n  if (!env) throw new Error(\"Env required to read usd_idr_rate\");\n  let auto = false;\n  try {\n    const autoRow = await env.DB.prepare(\"SELECT value FROM app_config WHERE key = 'usd_idr_auto_sync'\").first();\n    if (autoRow && autoRow.value) {\n      const v = String(autoRow.value);\n      try { auto = JSON.parse(v) === true; } catch { auto = v === '1' || v === 'true'; }\n    }\n  } catch {}\n\n  if (auto) {\n    try {\n      const live = await getExchangeRate(env);\n      if (live && typeof live === 'number' && live > 0) {\n        await env.DB.prepare(\"INSERT OR REPLACE INTO app_config (key, value) VALUES (?, ?)\").bind('usd_idr_rate', String(live)).run();\n        await env.DB.prepare(\"INSERT OR REPLACE INTO app_config (key, value) VALUES (?, ?)\").bind('usd_idr_rate_last_update', String(Date.now())).run();\n        return live;\n      }\n    } catch {}\n  }\n\n  const config = await env.DB.prepare(\"SELECT value FROM app_config WHERE key = 'usd_idr_rate'\").first();\n  const rate = Number(config?.value);\n  if (!rate || isNaN(rate) || rate <= 0) {\n    try {\n      const live = await getExchangeRate(env);\n      if (live && typeof live === 'number' && live > 0) return live;\n    } catch {}\n    throw new Error(\"USD/IDR rate not configured in Admin Settings (usd_idr_rate)\");\n  }\n  return rate;\n}\n\nexport function getTokenAmount(amountRp: number) {\n  return getTokenFromIDR(amountRp);\n}\n\n/**\n * Calculate tokens from IDR\n */\nexport function getTokenFromIDR(amountRp: number, rate: number = TOKEN_RATE_IDR_TO_CREDIT) {\n  const tokensBase = Math.floor(amountRp * rate);\n  const totalTokens = tokensBase;\n  return {\n    amount: amountRp,\n    currency: 'IDR',\n    tokensBase,\n    bonusPercent: 0,\n    tokensBonus: 0,\n    totalTokens\n  };\n}\n\n/**\n * Calculate tokens from USD\n */\nexport function getTokenFromUSD(amountUsd: number, rate?: number) {\n  if (typeof rate !== 'number' || rate <= 0) {\n    throw new Error(\"USD/IDR rate missing. Set 'usd_idr_rate' in Admin Settings.\");\n  }\n  const tokensBase = Math.floor(amountUsd * rate);\n  const totalTokens = tokensBase;\n  return {\n    amount: amountUsd,\n    currency: 'USD',\n    tokensBase,\n    bonusPercent: 0,\n    tokensBonus: 0,\n    totalTokens\n  };\n}\n\nfunction getBonusPercent(amount: number, table: Record<number, number>): number {\n    const thresholds = Object.keys(table).map(Number).sort((a, b) => b - a);\n    for (const threshold of thresholds) {\n        if (amount >= threshold) {\n            return table[threshold];\n        }\n    }\n    return 0;\n}\n", "import { Env } from '../types';\n\nlet cachedRate: number | null = null;\nlet lastFetch = 0;\nconst CACHE_TTL = 3600 * 1000; // 1 hour\nconst FALLBACK_RATE = 17000; // Safe fallback\n\nexport async function getExchangeRate(env?: Env): Promise<number> {\n  const now = Date.now();\n  if (cachedRate && (now - lastFetch < CACHE_TTL)) {\n    return cachedRate;\n  }\n\n  try {\n    // Use a reliable free API\n    const resp = await fetch('https://open.er-api.com/v6/latest/USD');\n    if (resp.ok) {\n      const data: any = await resp.json();\n      const rate = data.rates?.IDR;\n      if (rate && typeof rate === 'number') {\n        cachedRate = rate;\n        lastFetch = now;\n        console.log(`Updated Exchange Rate: 1 USD = ${rate} IDR`);\n        return rate;\n      }\n    }\n  } catch (e) {\n    console.error(\"Failed to fetch exchange rate:\", e);\n  }\n\n  // Fallback to Env var or Hardcoded\n  return cachedRate || FALLBACK_RATE;\n}\n", "\nfunction pemToBinary(pem: string): Uint8Array {\n  const base64 = pem.replace(/-----(BEGIN|END) PRIVATE KEY-----/g, \"\").replace(/\\s/g, \"\");\n  const binaryString = atob(base64);\n  const bytes = new Uint8Array(binaryString.length);\n  for (let i = 0; i < binaryString.length; i++) {\n    bytes[i] = binaryString.charCodeAt(i);\n  }\n  return bytes;\n}\n\nasync function importPrivateKey(pem: string): Promise<CryptoKey> {\n  const binaryDer = pemToBinary(pem);\n  return await crypto.subtle.importKey(\n    \"pkcs8\",\n    binaryDer,\n    {\n      name: \"RSASSA-PKCS1-v1_5\",\n      hash: \"SHA-256\",\n    },\n    false,\n    [\"sign\"]\n  );\n}\n\nfunction arrayBufferToBase64Url(buffer: ArrayBuffer | Uint8Array): string {\n  let binary = \"\";\n  const bytes = buffer instanceof Uint8Array ? buffer : new Uint8Array(buffer);\n  const len = bytes.byteLength;\n  for (let i = 0; i < len; i++) {\n    binary += String.fromCharCode(bytes[i]);\n  }\n  return btoa(binary)\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\")\n    .replace(/=+$/, \"\");\n}\n\nexport async function getGoogleAccessToken(\n  clientEmail: string,\n  privateKey: string,\n  scopes: string[] = [\"https://www.googleapis.com/auth/cloud-platform\"]\n): Promise<string> {\n  const now = Math.floor(Date.now() / 1000);\n  const exp = now + 3600; // 1 hour expiration\n\n  const header = {\n    alg: \"RS256\",\n    typ: \"JWT\",\n  };\n\n  const claimSet = {\n    iss: clientEmail,\n    scope: scopes.join(\" \"),\n    aud: \"https://oauth2.googleapis.com/token\",\n    exp: exp,\n    iat: now,\n  };\n\n  const encodedHeader = arrayBufferToBase64Url(\n    new TextEncoder().encode(JSON.stringify(header))\n  );\n  const encodedClaimSet = arrayBufferToBase64Url(\n    new TextEncoder().encode(JSON.stringify(claimSet))\n  );\n\n  const unsignedToken = `${encodedHeader}.${encodedClaimSet}`;\n\n  const key = await importPrivateKey(privateKey);\n  const signature = await crypto.subtle.sign(\n    \"RSASSA-PKCS1-v1_5\",\n    key,\n    new TextEncoder().encode(unsignedToken)\n  );\n\n  const encodedSignature = arrayBufferToBase64Url(signature);\n  const jwt = `${unsignedToken}.${encodedSignature}`;\n\n  // Exchange JWT for Access Token\n  const response = await fetch(\"https://oauth2.googleapis.com/token\", {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/x-www-form-urlencoded\",\n    },\n    body: new URLSearchParams({\n      grant_type: \"urn:ietf:params:oauth:grant-type:jwt-bearer\",\n      assertion: jwt,\n    }),\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(`Failed to get access token: ${errorText}`);\n  }\n\n  const data: any = await response.json();\n  return data.access_token;\n}\n", "import { Env } from '../index';\nimport { getLiveUsdRate } from '../utils/tokenTopup';\n\nexport async function handleBalance(userId: number, env: Env) {\n  const user = await env.DB.prepare(\"SELECT tokens FROM users WHERE id = ?\").bind(userId).first();\n  const rate = await getLiveUsdRate(env);\n  return Response.json({ balance: user?.tokens || 0, usd_rate: rate });\n}\n\nexport async function handleHistory(userId: number, env: Env) {\n  const history = await env.DB.prepare(\"SELECT * FROM history WHERE user_id = ? ORDER BY timestamp DESC LIMIT 20\").bind(userId).all();\n  return Response.json(history.results);\n}\n\nexport async function handleTopup(req: Request, userId: number, env: Env) {\n  // Disini Anda bisa integrasi Xendit/Midtrans/Stripe\n  // Untuk sekarang, kita buat simulasi topup manual/admin key\n  const body: any = await req.json();\n  const { amount, secret_admin_key } = body;\n\n  // Simple security check (Hardcoded for simplicity, use ENV in production)\n  if (secret_admin_key !== \"RAHASIA_ADMIN_TOPUP\") {\n    return Response.json({ error: \"Unauthorized topup\" }, { status: 403 });\n  }\n\n  // Clamp saldo negatif lama ke 0 sebelum menambahkan topup\n  await env.DB.prepare(\"UPDATE users SET tokens = (CASE WHEN tokens < 0 THEN 0 ELSE tokens END) + ? WHERE id = ?\")\n    .bind(amount, userId)\n    .run();\n  return Response.json({ success: true, message: `Added ${amount} tokens` });\n}\n", "import { Env } from '../types';\n\nexport async function handleUserUsage(req: Request, env: Env) {\n  const url = new URL(req.url);\n  // /admin/users/:id/usage -> [\"\", \"admin\", \"users\", \"123\", \"usage\"]\n  const pathParts = url.pathname.split('/');\n  const userId = pathParts[3];\n\n  if (!userId) {\n    return Response.json({ error: \"User ID required\" }, { status: 400 });\n  }\n\n  try {\n    const results = await env.DB.prepare(`\n      SELECT \n        date(timestamp, 'unixepoch') as day, \n        SUM(input_tokens) as total_input, \n        SUM(output_tokens) as total_output, \n        SUM(cost) as total_cost,\n        COUNT(*) as request_count\n      FROM history \n      WHERE user_id = ? \n      GROUP BY day \n      ORDER BY day DESC\n    `).bind(userId).all();\n\n    return Response.json(results.results);\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\nexport async function handleExportUsageCsv(req: Request, env: Env) {\n  try {\n    const results = await env.DB.prepare(`\n      SELECT \n        u.email,\n        u.id as user_id,\n        date(h.timestamp, 'unixepoch') as day,\n        SUM(h.input_tokens) as total_input,\n        SUM(h.output_tokens) as total_output,\n        SUM(h.cost) as total_cost,\n        COUNT(h.id) as request_count\n      FROM history h\n      JOIN users u ON h.user_id = u.id\n      GROUP BY u.id, day\n      ORDER BY day DESC, u.email ASC\n    `).all();\n\n    // Generate CSV\n    const rows = results.results as any[];\n    const headers = [\"Date\", \"User Email\", \"User ID\", \"Input Tokens\", \"Output Tokens\", \"Total Cost ($)\", \"Requests\"];\n    \n    let csv = headers.join(\",\") + \"\\n\";\n    \n    for (const row of rows) {\n      csv += [\n        row.day,\n        row.email,\n        row.user_id,\n        row.total_input || 0,\n        row.total_output || 0,\n        (row.total_cost || 0).toFixed(6), // Cost is small usually\n        row.request_count\n      ].join(\",\") + \"\\n\";\n    }\n\n    return new Response(csv, {\n      headers: {\n        \"Content-Type\": \"text/csv\",\n        \"Content-Disposition\": \"attachment; filename=user_usage_report.csv\"\n      }\n    });\n\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n", "\nimport { Env } from '../types';\nimport { getWelcomeVoucherTemplate, getPurchaseVoucherTemplate, sendEmail, getWelcomeDualVoucherTemplate } from '../utils/email';\n\n// --- VOUCHER PACKAGES CONFIGURATION (SMART RANGES) ---\n// Define min/max price ranges to handle:\n// 1. Admin Fees (e.g., Price 20k becomes 24k paid)\n// 2. Discounts (e.g., Price 20k becomes 15k paid)\n// 3. App Purchase detection (Specific range for App License)\n\n\n// Admin: List Vouchers\nexport async function handleListVouchers(_req: Request, env: Env) {\n  // 1. Lazy Cleanup: Delete vouchers expired more than 7 days ago\n  // We also need to delete associated claims to prevent FK violations (if enforced) or just for cleanup\n  try {\n    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();\n    \n    // Find codes to delete (optional, but safer if we need to delete claims first)\n    // For performance, we can just run delete query if FKs are not strict or configured to cascade\n    // But D1/SQLite default FK is often OFF or RESTRICT. Safest is to delete claims first.\n    \n    // Get codes that are really old\n    const oldVouchers = await env.DB.prepare(\"SELECT code FROM vouchers WHERE expires_at IS NOT NULL AND expires_at < ?\").bind(sevenDaysAgo).all();\n    \n    if (oldVouchers.results && oldVouchers.results.length > 0) {\n      const codes = oldVouchers.results.map((v: any) => v.code);\n      const placeholders = codes.map(() => '?').join(',');\n      \n      // Delete claims first\n      await env.DB.prepare(`DELETE FROM voucher_claims WHERE voucher_code IN (${placeholders})`).bind(...codes).run();\n      \n      // Delete vouchers\n      await env.DB.prepare(`DELETE FROM vouchers WHERE code IN (${placeholders})`).bind(...codes).run();\n      \n      console.log(`Cleaned up ${codes.length} expired vouchers`);\n    }\n  } catch (e) {\n    console.error(\"Auto-cleanup error:\", e);\n    // Continue listing even if cleanup fails\n  }\n\n  const vouchers = await env.DB.prepare(\"SELECT * FROM vouchers ORDER BY created_at DESC\").all();\n  return Response.json(vouchers.results);\n}\n\n// Admin: Extend Voucher\nexport async function handleExtendVoucher(req: Request, env: Env) {\n  try {\n    const body: any = await req.json();\n    let { code, days } = body;\n\n    if (!code || !days) {\n      return Response.json({ error: \"Missing code or days\" }, { status: 400 });\n    }\n    \n    // Normalize code\n    code = code.toUpperCase().trim();\n\n    const daysInt = parseInt(days);\n    if (isNaN(daysInt) || daysInt < 1) {\n        return Response.json({ error: \"Invalid days value\" }, { status: 400 });\n    }\n\n    const voucher = await env.DB.prepare(\"SELECT * FROM vouchers WHERE code = ?\").bind(code).first();\n    if (!voucher) {\n      return Response.json({ error: \"Voucher not found\" }, { status: 404 });\n    }\n\n    // Calculate new expiry: max(now, current_expiry) + days\n    const now = new Date();\n    let baseDate = now;\n    \n    if (voucher.expires_at) {\n        const currentExpiry = new Date(voucher.expires_at as string);\n        // If current expiry is in the future, we extend FROM that future date\n        // If it's in the past (expired), we extend from NOW to make it valid again\n        if (currentExpiry > now) {\n            baseDate = currentExpiry;\n        }\n    }\n\n    const newExpiry = new Date(baseDate);\n    newExpiry.setDate(newExpiry.getDate() + daysInt);\n    const newExpiryIso = newExpiry.toISOString();\n\n    await env.DB.prepare(\"UPDATE vouchers SET expires_at = ? WHERE code = ?\").bind(newExpiryIso, code).run();\n\n    return Response.json({ success: true, message: `Voucher extended until ${newExpiryIso}`, new_expiry: newExpiryIso });\n  } catch (e: any) {\n    return Response.json({ error: \"Extend Error: \" + e.message }, { status: 500 });\n  }\n}\n\n// Admin: Create Voucher\nexport async function handleCreateVoucher(req: Request, env: Env) {\n  const body: any = await req.json();\n  const { code, amount, max_usage, expires_at, allowed_emails, type, duration_days } = body;\n\n  if (!code) {\n    return Response.json({ error: \"Missing voucher code\" }, { status: 400 });\n  }\n\n  // Validation based on type\n  const voucherType = type || 'token'; // Default to token\n  \n  if (voucherType === 'token' && !amount) {\n      return Response.json({ error: \"Amount is required for token vouchers\" }, { status: 400 });\n  }\n\n  if (voucherType === 'subscription' && !duration_days) {\n      return Response.json({ error: \"Duration is required for subscription vouchers\" }, { status: 400 });\n  }\n\n  try {\n    // allowed_emails: \"email1@a.com, email2@b.com\" -> store as string\n    await env.DB.prepare(\n      \"INSERT INTO vouchers (code, amount, max_usage, current_usage, expires_at, allowed_emails, type, duration_days, created_at) VALUES (?, ?, ?, 0, ?, ?, ?, ?, ?)\"\n    ).bind(\n      code.toUpperCase(), \n      amount || 0, \n      max_usage || 0, \n      expires_at || null, \n      allowed_emails || null, \n      voucherType,\n      duration_days || 0,\n      new Date().toISOString()\n    ).run();\n\n    return Response.json({ success: true, message: \"Voucher created\" });\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\n// Admin: Bulk Create Vouchers\nexport async function handleBulkCreateVouchers(req: Request, env: Env) {\n  const body: any = await req.json();\n  const { amount, quantity, max_usage, expires_at, type, duration_days } = body;\n\n  // Validation\n  const voucherType = type || 'token';\n  \n  if (voucherType === 'token' && (!amount || amount < 1)) {\n      return Response.json({ error: \"Invalid amount for token vouchers\" }, { status: 400 });\n  }\n\n  if (voucherType === 'subscription' && (!duration_days || duration_days < 1)) {\n      return Response.json({ error: \"Invalid duration for subscription vouchers\" }, { status: 400 });\n  }\n\n  if (!quantity || quantity < 1) {\n    return Response.json({ error: \"Invalid quantity\" }, { status: 400 });\n  }\n\n  // Helper to generate 6-char random alphanumeric code\n  const generateCode = () => {\n    const chars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\";\n    let result = \"\";\n    const randomValues = new Uint8Array(6);\n    crypto.getRandomValues(randomValues);\n    for (let i = 0; i < 6; i++) {\n      result += chars[randomValues[i] % chars.length];\n    }\n    return result;\n  };\n\n  const generatedCodes: string[] = [];\n  const stmts: any[] = [];\n  const createdAt = new Date().toISOString();\n\n  // Limit quantity to prevent timeout/abuse (e.g. max 500 per request)\n  const safeQuantity = Math.min(quantity, 500);\n\n  for (let i = 0; i < safeQuantity; i++) {\n    const code = generateCode();\n    generatedCodes.push(code);\n    stmts.push(\n      env.DB.prepare(\n        \"INSERT INTO vouchers (code, amount, max_usage, current_usage, expires_at, type, duration_days, created_at) VALUES (?, ?, ?, 0, ?, ?, ?, ?)\"\n      ).bind(\n          code, \n          amount || 0, \n          max_usage || 1, \n          expires_at || null, \n          voucherType,\n          duration_days || 0,\n          createdAt\n      )\n    );\n  }\n\n  try {\n    // Execute in batches of 50 to respect D1 limits\n    const BATCH_SIZE = 50;\n    for (let i = 0; i < stmts.length; i += BATCH_SIZE) {\n      const batch = stmts.slice(i, i + BATCH_SIZE);\n      await env.DB.batch(batch);\n    }\n\n    return Response.json({ \n      success: true, \n      message: `${safeQuantity} vouchers created successfully`,\n      codes: generatedCodes \n    });\n  } catch (e: any) {\n    // If collision occurs (rare but possible), it might fail. \n    // Ideally we should handle it, but for simplicity we return error.\n    return Response.json({ error: \"Failed to create vouchers (Code collision or DB error). Try again.\" + e.message }, { status: 500 });\n  }\n}\n\n// Admin: Delete Voucher\nexport async function handleDeleteVoucher(req: Request, env: Env) {\n  const body: any = await req.json();\n  const { id } = body;\n  await env.DB.prepare(\"DELETE FROM vouchers WHERE id = ?\").bind(id).run();\n  return Response.json({ success: true });\n}\n\n// User: Redeem (Updated)\nexport async function handleRedeemVoucher(req: Request, env: Env) {\n  const body: any = await req.json();\n  const { userId, code, deviceHash } = body;\n\n  if (!userId || !code || !deviceHash) {\n    return Response.json({ error: \"Missing required fields\" }, { status: 400 });\n  }\n\n  const voucherCode = code.toUpperCase().trim();\n\n  // 1. Check Voucher Validity\n  const voucher = await env.DB.prepare(\"SELECT * FROM vouchers WHERE code = ?\").bind(voucherCode).first();\n  if (!voucher) {\n    return Response.json({ error: \"Invalid voucher code\" }, { status: 404 });\n  }\n\n  // Check Expiry\n  if (voucher.expires_at) {\n      const now = new Date();\n      const expiry = new Date(voucher.expires_at as string);\n      if (now > expiry) {\n          return Response.json({ error: \"Voucher has expired\" }, { status: 410 });\n      }\n  }\n\n  // Check Usage Limit\n  const maxUsage = voucher.max_usage as number;\n  const currentUsage = voucher.current_usage as number;\n  if (maxUsage > 0 && currentUsage >= maxUsage) {\n    return Response.json({ error: \"Voucher fully redeemed\" }, { status: 410 });\n  }\n\n  // Check Whitelist (Allowed Emails)\n  if (voucher.allowed_emails) {\n      const allowedList = (voucher.allowed_emails as string).split(',').map(s => s.trim().toLowerCase());\n      // Need user email. Get from DB or Token (if passed in context, but here we only have userId in body)\n      // We should fetch user email from DB to be safe\n      const user = await env.DB.prepare(\"SELECT email FROM users WHERE id = ?\").bind(userId).first();\n      if (!user || !allowedList.includes((user.email as string).toLowerCase())) {\n          return Response.json({ error: \"This voucher is not valid for your account\" }, { status: 403 });\n      }\n  }\n\n  // 2. Check if USER already claimed THIS voucher\n  const userClaim = await env.DB.prepare(\"SELECT * FROM voucher_claims WHERE user_id = ? AND voucher_code = ?\")\n    .bind(userId, voucherCode).first();\n  \n  if (userClaim) {\n    return Response.json({ error: \"You have already redeemed this voucher\" }, { status: 409 });\n  }\n\n  // 3. Check if DEVICE already claimed THIS voucher (Anti-Tuyul)\n  const deviceClaim = await env.DB.prepare(\"SELECT * FROM voucher_claims WHERE device_hash = ? AND voucher_code = ?\")\n    .bind(deviceHash, voucherCode).first();\n\n  if (deviceClaim) {\n    return Response.json({ error: \"This device has already redeemed this voucher code\" }, { status: 403 });\n  }\n\n  // 4. EXECUTE REDEMPTION (Atomic Transaction using Batch)\n  try {\n    const stmts: any[] = [];\n    let successMessage = \"\";\n    let responseData: any = {};\n\n    if (voucher.type === 'subscription') {\n        // --- SUBSCRIPTION LOGIC ---\n        let durationDays = Number(voucher.duration_days);\n        if (isNaN(durationDays) || durationDays < 1) durationDays = 30;\n        \n        // Get current user subscription status to determine start date\n        const currentUser = await env.DB.prepare(\"SELECT subscription_expiry FROM users WHERE id = ?\").bind(userId).first();\n        \n        let newExpiryDate = new Date();\n        if (currentUser && currentUser.subscription_expiry) {\n            const currentExpiry = new Date(currentUser.subscription_expiry as string);\n            // If current expiry is in the future, extend from there\n            if (currentExpiry > new Date()) {\n                newExpiryDate = currentExpiry;\n            }\n        }\n        \n        // Add duration\n        newExpiryDate.setDate(newExpiryDate.getDate() + durationDays);\n        const newExpiryIso = newExpiryDate.toISOString();\n\n        stmts.push(\n            env.DB.prepare(\"UPDATE users SET subscription_active = 1, subscription_expiry = ? WHERE id = ?\")\n                .bind(newExpiryIso, userId)\n        );\n\n        successMessage = `Subscription activated! Valid until ${newExpiryDate.toLocaleDateString()}`;\n        responseData = { subscription_active: true, subscription_expiry: newExpiryIso };\n\n    } else {\n        // --- TOKEN LOGIC (Default) ---\n        stmts.push(\n            env.DB.prepare(\"UPDATE users SET tokens = tokens + ? WHERE id = ?\").bind(voucher.amount, userId)\n        );\n        successMessage = `Voucher redeemed! ${voucher.amount} tokens added.`;\n        responseData = { amount_added: voucher.amount };\n    }\n\n    // Common Statements\n    stmts.push(\n        env.DB.prepare(\"INSERT INTO voucher_claims (user_id, voucher_code, device_hash) VALUES (?, ?, ?)\").bind(userId, voucherCode, deviceHash),\n        env.DB.prepare(\"UPDATE vouchers SET current_usage = current_usage + 1 WHERE code = ?\").bind(voucherCode)\n    );\n\n    await env.DB.batch(stmts);\n\n    // 5. Auto-Delete if Max Usage Reached\n    // User Requirement: \"setiap kode voucher yang maksimal usage nya terpenuhi maka otomatis terhapus\"\n    // \"tidak mempengaruhi token user\" -> We already updated user tokens in the batch above.\n    \n    // We check if the NEW usage matches Max Usage.\n    // currentUsage (from DB select) was before increment. So new usage is currentUsage + 1.\n    if (maxUsage > 0 && (currentUsage + 1) >= maxUsage) {\n       // Delete claims first to avoid FK issues\n       await env.DB.prepare(\"DELETE FROM voucher_claims WHERE voucher_code = ?\").bind(voucherCode).run();\n       // Delete voucher\n       await env.DB.prepare(\"DELETE FROM vouchers WHERE code = ?\").bind(voucherCode).run();\n       console.log(`Voucher ${voucherCode} auto-deleted (Max usage reached)`);\n    }\n\n    return Response.json({ \n        success: true, \n        message: successMessage,\n        ...responseData\n    });\n\n  } catch (e: any) {\n    console.error(\"Voucher Redeem Error:\", e);\n    // If batch fails, none of the changes are applied (D1 batch is atomic)\n    return Response.json({ error: \"Failed to redeem voucher. Please try again.\" }, { status: 500 });\n  }\n}\n\nexport async function handleLynkIdWebhook(req: Request, env: Env) {\n  const url = new URL(req.url);\n  const secretQuery = url.searchParams.get('secret');\n  const secretHeader = req.headers.get('x-webhook-secret');\n  \n  // Prioritize header, fallback to query param\n  const receivedSecret = secretHeader || secretQuery;\n\n  if (!env.LYNKID_WEBHOOK_SECRET || receivedSecret !== env.LYNKID_WEBHOOK_SECRET) {\n    return Response.json({ success: false, error: \"Invalid webhook secret\" }, { status: 401 });\n  }\n\n  let body: any;\n  try {\n    body = await req.json();\n    \n    // LOGGING: Save the raw webhook payload to DB for debugging/inspection\n    try {\n        await env.DB.prepare(\"INSERT OR REPLACE INTO app_config (key, value) VALUES (?, ?)\").bind('last_lynkid_webhook', JSON.stringify(body)).run();\n    } catch (logErr) {\n        console.error(\"Failed to log webhook payload\", logErr);\n    }\n\n  } catch {\n    return Response.json({ success: false, error: \"Invalid JSON body\" }, { status: 400 });\n  }\n\n  // --- PARSE LYNK.ID PAYLOAD (Updated based on actual payload) ---\n  // Structure: { event: \"payment.received\", data: { message_data: { customer: { email: ... }, items: [ ... ], totals: { ... } } } }\n  \n  const event = body.event;\n  const data = body.data;\n  const messageData = data?.message_data;\n  \n  // 1. Validate Event\n  // Lynk.id sends 'payment.received'\n  if (!event || event !== 'payment.received') {\n    return Response.json({ success: true, message: `Event '${event || 'unknown'}' received but ignored` });\n  }\n\n  // 2. Validate Email\n  const email = messageData?.customer?.email;\n  if (!email || typeof email !== 'string') {\n    return Response.json({ success: false, error: \"Missing email in customer data\" }, { status: 400 });\n  }\n\n  // 3. Process Items\n  const items = messageData?.items || [];\n  if (items.length === 0) {\n      return Response.json({ success: false, error: \"No items in transaction\" }, { status: 400 });\n  }\n\n  const results = [];\n  let totalTokensAdded = 0;\n  let totalAmountRp = 0;\n\n  // We loop through items, but usually there's only 1.\n  for (const item of items) {\n      const title = item.title || \"\";\n      const price = Number(item.price) || 0; // Original Price (before discount)\n      totalAmountRp += price;\n      \n      let voucherType: 'token' | 'subscription' = 'token';\n      let tokenAmount = 0;\n      let subscriptionDuration = 0;\n      let emailSubject = 'Your Metabayn Studio Voucher';\n      let isWelcomeBonus = false;\n      let matched = false;\n\n      const titleLower = title.toLowerCase();\n      const normalizeTitle = (s: string) => s.toLowerCase().replace(/\u2013/g, '-').replace(/\\s+/g, ' ').trim();\n      const TITLE_MAP: Record<string, { type: 'license' | 'token' | 'subscription', amount?: number, duration?: number }> = {\n          [normalizeTitle('Metabayn \u2013 Smart Metadata Generator App for Images & Videos')]: { type: 'license' },\n          [normalizeTitle('Metabayn Token Voucher 20.000 \u2013 Credit Top-Up for Metadata Processing')]: { type: 'token', amount: 20000 },\n          [normalizeTitle('Metabayn Token Voucher 50.000 \u2013 Credit Top-Up for Metadata Processing')]: { type: 'token', amount: 50000 },\n          [normalizeTitle('Metabayn Token Voucher 100.000 \u2013 Credit Top-Up for Metadata Processing')]: { type: 'token', amount: 100000 },\n          [normalizeTitle('Metabayn Token Voucher 150.000 \u2013 Credit Top-Up for Metadata Processing')]: { type: 'token', amount: 150000 },\n          [normalizeTitle('Metabayn API Key Mode Subscription - 30 Days')]: { type: 'subscription', duration: 30 },\n          [normalizeTitle('Metabayn API Key Mode Subscription - 3 Months')]: { type: 'subscription', duration: 90 },\n          [normalizeTitle('Metabayn API Key Mode Subscription - 6 Months')]: { type: 'subscription', duration: 180 },\n          [normalizeTitle('Metabayn API Key Mode Subscription - 1 Year')]: { type: 'subscription', duration: 365 }\n      };\n      const mapped = TITLE_MAP[normalizeTitle(title)];\n      if (mapped) {\n          matched = true;\n          if (mapped.type === 'license') {\n              isWelcomeBonus = true;\n              let welcomeAmountThreshold = 48900;\n              try {\n                const rateCfg = await env.DB.prepare(\"SELECT value FROM app_config WHERE key = 'usd_idr_rate'\").first();\n                if (rateCfg && rateCfg.value) {\n                    const rate = Number(rateCfg.value);\n                    if (!isNaN(rate) && rate > 0) welcomeAmountThreshold = Math.round(3 * rate);\n                }\n              } catch {}\n              tokenAmount = welcomeAmountThreshold;\n              emailSubject = 'Your Metabayn Studio Welcome Vouchers';\n          } else if (mapped.type === 'token') {\n              voucherType = 'token';\n              tokenAmount = mapped.amount || 0;\n              emailSubject = `Your ${title}`;\n          } else {\n              voucherType = 'subscription';\n              subscriptionDuration = mapped.duration || 30;\n              emailSubject = `Your ${title}`;\n          }\n      } else if (titleLower.includes('subscription') || titleLower.includes('langganan')) {\n          // SUBSCRIPTION\n          voucherType = 'subscription';\n          matched = true;\n          // Detect duration from title or price\n          if (titleLower.includes('1 year') || titleLower.includes('tahun') || titleLower.includes('12 month')) {\n              subscriptionDuration = 365;\n              emailSubject = 'Your 1 Year Subscription Voucher';\n          } else if (titleLower.includes('3 month') || titleLower.includes('3 bulan')) {\n              subscriptionDuration = 90;\n              emailSubject = 'Your 3 Months Subscription Voucher';\n          } else {\n              subscriptionDuration = 30; // Default 1 month\n              emailSubject = 'Your 1 Month Subscription Voucher';\n          }\n\n      } else if (titleLower.includes('token')) {\n          // TOKEN PACKAGES\n          voucherType = 'token';\n          matched = true;\n          emailSubject = `Your ${title}`;\n          \n          // Detect amount from title (e.g. \"100k Tokens\") or Price\n          // Fallback to Price logic if title parsing is hard\n          // Mapping based on price (ignoring discount)\n          if (price >= 15000 && price <= 29000) tokenAmount = 20000;\n          else if (price >= 40000 && price <= 70000) tokenAmount = 55000;\n          else if (price >= 80000 && price <= 130000) tokenAmount = 120000;\n          else tokenAmount = price; // Fallback 1:1\n\n      } else if (normalizeTitle(title) === normalizeTitle('Metabayn \u2013 Smart Metadata Generator App for Images & Videos')) {\n          // APP LICENSE (Welcome Bonus) - strictly match exact app title\n          isWelcomeBonus = true;\n          matched = true;\n\n          let welcomeAmountThreshold = 48900; \n          try {\n            const rateCfg = await env.DB.prepare(\"SELECT value FROM app_config WHERE key = 'usd_idr_rate'\").first();\n            if (rateCfg && rateCfg.value) {\n                const rate = Number(rateCfg.value);\n                if (!isNaN(rate) && rate > 0) welcomeAmountThreshold = Math.round(3 * rate);\n            }\n          } catch {}\n          tokenAmount = welcomeAmountThreshold;\n          emailSubject = 'Your Metabayn Studio Welcome Vouchers';\n\n      } else {\n          // Final Fallback: Treat as Token Topup 1:1 based on price\n          tokenAmount = price;\n          emailSubject = 'Your Token Voucher';\n      }\n\n      if (tokenAmount > 0 || subscriptionDuration > 0) {\n          // Accumulate tokens for transaction log\n          if (voucherType === 'token') {\n              totalTokensAdded += tokenAmount;\n          }\n\n          const expiresAt = new Date();\n          expiresAt.setDate(expiresAt.getDate() + 30);\n          let emailHtml = \"\";\n          if (isWelcomeBonus) {\n              const tokenCode = generateCode();\n              const subscriptionCode = generateCode();\n              await env.DB.prepare(\n                \"INSERT INTO vouchers (code, amount, max_usage, current_usage, expires_at, type, duration_days, created_at) VALUES (?, ?, 1, 0, ?, ?, ?, ?)\"\n              ).bind(\n                  tokenCode,\n                  tokenAmount,\n                  expiresAt.toISOString(),\n                  'token',\n                  0,\n                  new Date().toISOString()\n              ).run();\n              await env.DB.prepare(\n                \"INSERT INTO vouchers (code, amount, max_usage, current_usage, expires_at, type, duration_days, created_at) VALUES (?, ?, 1, 0, ?, ?, ?, ?)\"\n              ).bind(\n                  subscriptionCode,\n                  0,\n                  expiresAt.toISOString(),\n                  'subscription',\n                  30,\n                  new Date().toISOString()\n              ).run();\n              emailSubject = 'Your Metabayn Studio Welcome Vouchers';\n              emailHtml = getWelcomeDualVoucherTemplate(email, tokenCode, tokenAmount, subscriptionCode, 30);\n              await sendEmail(email, emailSubject, emailHtml, env);\n              results.push({ code: tokenCode, type: 'token', amount: tokenAmount });\n              results.push({ code: subscriptionCode, type: 'subscription', amount: 30 });\n          } else {\n              const code = generateCode();\n              await env.DB.prepare(\n                \"INSERT INTO vouchers (code, amount, max_usage, current_usage, expires_at, type, duration_days, created_at) VALUES (?, ?, 1, 0, ?, ?, ?, ?)\"\n              ).bind(\n                  code,\n                  tokenAmount,\n                  expiresAt.toISOString(),\n                  voucherType,\n                  subscriptionDuration,\n                  new Date().toISOString()\n              ).run();\n              emailHtml = getPurchaseVoucherTemplate(email, code, voucherType, voucherType === 'subscription' ? subscriptionDuration : tokenAmount);\n              await sendEmail(email, emailSubject, emailHtml, env);\n              results.push({ code, type: voucherType, amount: tokenAmount || subscriptionDuration });\n          }\n      }\n  }\n\n  // LOG TRANSACTION TO topup_transactions\n  try {\n      const orderId = data?.order_id || body.event_id || `lynkid-${Date.now()}`;\n      \n      // Try to find user by email\n      const user = await env.DB.prepare(\"SELECT id FROM users WHERE email = ?\").bind(email).first();\n      // If user not found, use special format \"email:user@example.com\" so admin panel can extract it\n      const userId = user ? String(user.id) : `email:${email}`;\n      \n      await env.DB.prepare(`\n          INSERT INTO topup_transactions \n          (user_id, amount_rp, tokens_added, method, status, payment_ref, created_at) \n          VALUES (?, ?, ?, 'lynkid', 'paid', ?, ?)\n      `).bind(\n          userId, \n          totalAmountRp, \n          totalTokensAdded, \n          orderId, \n          new Date().toISOString()\n      ).run();\n      \n      console.log(`Logged Lynk.id transaction for ${email} (User: ${userId}, Amount: ${totalAmountRp})`);\n  } catch (txErr) {\n      console.error(\"Failed to log Lynk.id transaction:\", txErr);\n  }\n\n  return Response.json({ success: true, generated: results });\n}\n\n// Helper to generate 6-char random alphanumeric code (Moved out to be shared)\nfunction generateCode() {\n    const chars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\";\n    let result = \"\";\n    const randomValues = new Uint8Array(6);\n    crypto.getRandomValues(randomValues);\n    for (let i = 0; i < 6; i++) {\n      result += chars[randomValues[i] % chars.length];\n    }\n    return result;\n}\n", "import { Env } from '../types';\nimport { addUserTokens } from '../utils/userToken';\nimport { sendEmail, getManualApproveTemplate } from '../utils/email';\n\n// 1. GET /admin/topup/list\nexport async function listTopups(request: Request, env: Env): Promise<Response> {\n  const url = new URL(request.url);\n  const page = parseInt(url.searchParams.get('page') || '1');\n  const limit = parseInt(url.searchParams.get('limit') || '20');\n  const offset = (page - 1) * limit;\n\n  // Filter Params\n  const method = url.searchParams.get('method') || null;\n  const status = url.searchParams.get('status') || null;\n  const search = url.searchParams.get('search') || null; // email or user_id\n  \n  // Date Range (Default to full range if not provided)\n  const dateFrom = url.searchParams.get('date_from') || '1970-01-01';\n  const dateTo = url.searchParams.get('date_to') || '2099-12-31';\n\n  // Helper to get total count with same filters\n  const countQuery = `\n    SELECT COUNT(*) as total \n    FROM topup_transactions t\n    LEFT JOIN users u ON u.id = CAST(t.user_id AS INTEGER)\n    WHERE 1=1 \n      AND (t.method = ? OR ? IS NULL) \n      AND (t.status = ? OR ? IS NULL) \n      AND (CASE \n          WHEN u.email IS NOT NULL THEN u.email \n          WHEN t.user_id LIKE 'email:%' THEN SUBSTR(t.user_id, 7) \n          ELSE NULL \n        END LIKE ? OR t.user_id = ? OR ? IS NULL) \n      AND (date(t.created_at) BETWEEN date(?) AND date(?))\n  `;\n\n  // Search param handling (if search provided, wrap with %)\n  const searchLike = search ? `%${search}%` : null;\n\n  // Params order: method, method, status, status, searchLike, search, search, dateFrom, dateTo\n  const bindParams = [\n    method, method, \n    status, status, \n    searchLike, search, search, \n    dateFrom, dateTo\n  ];\n\n  const countRes = await env.DB.prepare(countQuery).bind(...bindParams).first();\n  const total = countRes?.total as number || 0;\n  const pageCount = Math.ceil(total / limit);\n\n  // Main Data Query\n  const query = `\n    SELECT t.*, \n      CASE \n        WHEN u.email IS NOT NULL THEN u.email \n        WHEN t.user_id LIKE 'email:%' THEN SUBSTR(t.user_id, 7) \n        ELSE NULL \n      END as user_email, \n      u.tokens as user_balance\n    FROM topup_transactions t \n    LEFT JOIN users u ON u.id = CAST(t.user_id AS INTEGER)\n    WHERE 1=1 \n      AND (t.method = ? OR ? IS NULL) \n      AND (t.status = ? OR ? IS NULL) \n      AND (CASE \n          WHEN u.email IS NOT NULL THEN u.email \n          WHEN t.user_id LIKE 'email:%' THEN SUBSTR(t.user_id, 7) \n          ELSE NULL \n        END LIKE ? OR t.user_id = ? OR ? IS NULL) \n      AND (date(t.created_at) BETWEEN date(?) AND date(?))\n    ORDER BY t.created_at DESC \n    LIMIT ? OFFSET ?\n  `;\n  \n  const results = await env.DB.prepare(query).bind(...bindParams, limit, offset).all();\n\n  return Response.json({\n    total,\n    page,\n    page_count: pageCount,\n    transactions: results.results\n  });\n}\n\n// 2. GET /admin/topup/detail/:id\nexport async function getTopupDetail(request: Request, env: Env): Promise<Response> {\n  const url = new URL(request.url);\n  const id = url.pathname.split('/').pop(); // Assumes /admin/topup/detail/:id\n\n  if (!id) return Response.json({ error: \"Missing ID\" }, { status: 400 });\n\n  const query = `\n    SELECT t.*, u.email, u.tokens as current_balance\n    FROM topup_transactions t \n    LEFT JOIN users u ON t.user_id = CAST(u.id AS TEXT)\n    WHERE t.id = ?\n  `;\n\n  const transaction = await env.DB.prepare(query).bind(id).first();\n\n  if (!transaction) return Response.json({ error: \"Transaction not found\" }, { status: 404 });\n\n  return Response.json(transaction);\n}\n\n// 3. POST /admin/topup/manual-approve\nexport async function manualApproveTopup(request: Request, env: Env, adminId: string = \"SYSTEM\"): Promise<Response> {\n  try {\n    const { id } = await request.json() as { id: number | string };\n    if (!id) return Response.json({ error: \"Missing ID\" }, { status: 400 });\n\n    const transaction = await env.DB.prepare(\"SELECT * FROM topup_transactions WHERE id = ?\").bind(id).first();\n\n    if (!transaction) return Response.json({ error: \"Transaction not found\" }, { status: 404 });\n    if (transaction.status !== 'pending') return Response.json({ error: \"Transaction is not pending\" }, { status: 400 });\n\n    // Update Status\n    await env.DB.prepare(\"UPDATE topup_transactions SET status = 'paid' WHERE id = ?\").bind(id).run();\n\n    // Add Tokens\n    const tokensAdded = transaction.tokens_added as number;\n    await addUserTokens(transaction.user_id as string, tokensAdded, env);\n\n    // Send Email\n    const user = await env.DB.prepare(\"SELECT email FROM users WHERE id = ?\").bind(transaction.user_id).first() as { email: string } | null;\n    if (user && user.email) {\n        const currency = transaction.method === 'paypal' ? 'USD' : 'IDR';\n        const amount = transaction.method === 'paypal' ? transaction.amount_usd : transaction.amount_rp;\n        const name = user.email.split('@')[0]; // Simple name extraction\n        const html = getManualApproveTemplate(name, amount as number, tokensAdded, currency);\n        sendEmail(user.email as string, \"Top-Up Token Anda Berhasil (Manual Approval)\", html, env);\n    }\n\n    // Log Action\n    await env.DB.prepare(\"INSERT INTO admin_logs (admin_id, action, target_id) VALUES (?, ?, ?)\").bind(adminId, 'manual_approve', id).run();\n\n    return Response.json({ success: true });\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\n// 4. POST /admin/topup/delete\nexport async function deleteTopup(request: Request, env: Env, adminId: string = \"SYSTEM\"): Promise<Response> {\n  try {\n    const { id } = await request.json() as { id: number | string };\n    if (!id) return Response.json({ error: \"Missing ID\" }, { status: 400 });\n\n    const transaction = await env.DB.prepare(\"SELECT status FROM topup_transactions WHERE id = ?\").bind(id).first();\n    \n    if (!transaction) return Response.json({ error: \"Transaction not found\" }, { status: 404 });\n    if (transaction.status === 'paid') return Response.json({ error: \"Cannot delete PAID transaction\" }, { status: 400 });\n\n    await env.DB.prepare(\"DELETE FROM topup_transactions WHERE id = ?\").bind(id).run();\n\n    // Log Action\n    await env.DB.prepare(\"INSERT INTO admin_logs (admin_id, action, target_id) VALUES (?, ?, ?)\").bind(adminId, 'delete_transaction', id).run();\n\n    return Response.json({ success: true });\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\n// 5. GET /admin/topup/statistics\nexport async function getTopupStatistics(_request: Request, env: Env): Promise<Response> {\n  // Overall Stats\n  const totalStats = await env.DB.prepare(`\n    SELECT \n      COUNT(*) as total_transactions,\n      SUM(amount_rp) as total_rp,\n      SUM(amount_usd) as total_usd,\n      SUM(tokens_added) as total_tokens_given\n    FROM topup_transactions\n    WHERE status = 'paid'\n  `).first();\n\n  // Top Methods\n  const methods = await env.DB.prepare(`\n    SELECT method, COUNT(*) as count \n    FROM topup_transactions \n    WHERE status = 'paid' \n    GROUP BY method\n  `).all();\n\n  const top_methods: Record<string, number> = {};\n  methods.results.forEach((r: any) => top_methods[r.method] = r.count);\n\n  // Time Series (Daily Statistics as requested)\n  // SELECT DATE(created_at) AS day, COUNT(*) AS count, SUM(amount_rp) AS total_rp, SUM(amount_usd) AS total_usd, SUM(tokens_added) AS total_tokens ...\n  const dailyStats = await env.DB.prepare(`\n    SELECT \n      DATE(created_at) as day,\n      COUNT(*) as count,\n      SUM(amount_rp) as total_rp,\n      SUM(amount_usd) as total_usd,\n      SUM(tokens_added) as total_tokens\n    FROM topup_transactions\n    WHERE status = 'paid'\n    GROUP BY day\n    ORDER BY day DESC\n  `).all();\n\n  return Response.json({\n    total_transactions: totalStats?.total_transactions || 0,\n    total_rp: totalStats?.total_rp || 0,\n    total_usd: totalStats?.total_usd || 0,\n    total_tokens_given: totalStats?.total_tokens_given || 0,\n    top_methods,\n    daily_stats: dailyStats.results // Changed key to daily_stats to be explicit\n  });\n}\n\n// 6. GET /admin/topup/export-csv\nexport async function exportTopupCsv(_request: Request, env: Env): Promise<Response> {\n  // Dump all paid transactions (or all?) - User said \"export-csv\", usually implies full data dump.\n  // Let's dump everything including pending/failed so admin can analyze.\n  const query = `\n    SELECT t.id, t.user_id, u.email, t.amount_rp, t.amount_usd, t.tokens_added, t.method, t.status, t.payment_ref, t.created_at\n    FROM topup_transactions t\n    LEFT JOIN users u ON u.id = CAST(t.user_id AS INTEGER)\n    ORDER BY t.created_at DESC\n  `;\n  \n  const results = await env.DB.prepare(query).all();\n  \n  // Build CSV\n  const header = \"id,user_id,user_email,amount_rp,amount_usd,tokens_added,method,status,payment_ref,created_at\\n\";\n  const rows = results.results.map((r: any) => {\n    return [\n      r.id,\n      r.user_id,\n      r.email || '',\n      r.amount_rp || 0,\n      r.amount_usd || 0,\n      r.tokens_added,\n      r.method,\n      r.status,\n      r.payment_ref || '',\n      r.created_at\n    ].join(',');\n  }).join('\\n');\n\n  return new Response(header + rows, {\n    headers: {\n      \"Content-Type\": \"text/csv\",\n      \"Content-Disposition\": \"attachment; filename=topup_transactions.csv\"\n    }\n  });\n}\n", "import { Env } from '../types';\n\n/**\n * Menambah token ke saldo user secara atomic\n * @param userId ID User\n * @param tokens Jumlah token yang ditambahkan\n * @param env Environment variables\n */\nexport async function addUserTokens(userId: string, tokens: number, env: Env): Promise<number> {\n    // Clamp saldo negatif lama ke 0 sebelum menambahkan topup\n    const res = await env.DB.prepare(\"UPDATE users SET tokens = (CASE WHEN tokens < 0 THEN 0 ELSE tokens END) + ? WHERE id = ? RETURNING tokens\")\n        .bind(tokens, userId)\n        .first();\n    return (res?.tokens as number) || 0;\n}\n", "import { Env } from '../types';\nimport { getTokenFromUSD, getTokenFromIDR, getLiveUsdRate } from '../utils/tokenTopup';\nimport { addUserTokens } from '../utils/userToken';\nimport { sendEmail, getTopupSuccessTemplate } from '../utils/email';\n\n// --- PAYPAL HANDLERS (USD) ---\n\nexport async function createPaypalPayment(request: Request, env: Env): Promise<Response> {\n  try {\n    // amount here implies USD\n    const body = await request.json() as { amount: number, userId: string, type?: string, tokensPack?: number };\n    const amount = body.amount;\n    let userId = String(body.userId);\n    // Ensure userId is clean string (remove .0 if present from potential float conversion)\n    if (!isNaN(Number(userId)) && userId.includes('.')) {\n        userId = userId.split('.')[0];\n    }\n    const type = body.type === 'subscription' ? 'subscription' : 'token';\n    const tokensPack = Number(body.tokensPack || 0) || 0;\n    \n    if (!amount || !userId) {\n      return Response.json({ error: \"Missing amount or userId\" }, { status: 400 });\n    }\n\n    const rateUsd = await getLiveUsdRate(env);\n    // 2. Hitung Token (USD) khusus untuk top up token\n    // NORMALISASI: jika tokensPack dikirim dari frontend, gunakan nilai tetap tersebut\n    const tokenCalc = type === 'token'\n      ? (tokensPack > 0 ? { totalTokens: tokensPack } : getTokenFromUSD(amount, rateUsd))\n      : { totalTokens: 0 } as any;\n    \n    // 3. Buat Transaksi Pending di DB\n    const method = type === 'subscription' ? 'paypal_subscription' : 'paypal';\n    const insertRes = await env.DB.prepare(\n      \"INSERT INTO topup_transactions (user_id, amount_usd, tokens_added, method, status) VALUES (?, ?, ?, ?, ?) RETURNING id\"\n    ).bind(userId, amount, tokenCalc.totalTokens, method, 'pending').first();\n    \n    const transactionId = insertRes?.id;\n\n    // 4. Panggil PayPal API (Real Implementation)\n    const clientId = env.PAYPAL_CLIENT_ID;\n    const clientSecret = env.PAYPAL_CLIENT_SECRET;\n    \n    if (!clientId || !clientSecret) {\n        throw new Error(\"PayPal Credentials missing in Server Config\");\n    }\n\n    const isLive = env.PAYPAL_MODE === 'live';\n    const baseUrl = isLive ? 'https://api-m.paypal.com' : 'https://api-m.sandbox.paypal.com';\n    const auth = btoa(`${clientId}:${clientSecret}`);\n\n    // 4.1. Get Access Token\n    const tokenRes = await fetch(`${baseUrl}/v1/oauth2/token`, {\n        method: 'POST',\n        headers: { \n            'Authorization': `Basic ${auth}`, \n            'Content-Type': 'application/x-www-form-urlencoded' \n        },\n        body: 'grant_type=client_credentials'\n    });\n\n    if (!tokenRes.ok) {\n        const err = await tokenRes.text();\n        console.error(\"PayPal Token Error:\", err);\n        throw new Error(\"Failed to authenticate with PayPal\");\n    }\n\n    const tokenData = await tokenRes.json() as any;\n    const accessToken = tokenData.access_token;\n\n    // 4.2. Create Order\n    const orderRes = await fetch(`${baseUrl}/v2/checkout/orders`, {\n        method: 'POST',\n        headers: { \n            'Authorization': `Bearer ${accessToken}`, \n            'Content-Type': 'application/json' \n        },\n        body: JSON.stringify({\n            intent: 'CAPTURE',\n            purchase_units: [{\n                reference_id: String(transactionId),\n                amount: { currency_code: 'USD', value: amount.toString() },\n                description: type === 'subscription'\n                  ? 'Metabayn API Subscription 30 Days'\n                  : `TopUp ${tokenCalc.totalTokens} Tokens (Metabayn)`\n            }],\n            application_context: {\n                return_url: 'https://metabayn-backend.metabayn.workers.dev/payment/success',\n                cancel_url: 'https://metabayn-backend.metabayn.workers.dev/payment/cancel',\n                brand_name: 'Metabayn App',\n                user_action: 'PAY_NOW'\n            }\n        })\n    });\n\n    if (!orderRes.ok) {\n        const err = await orderRes.text();\n        console.error(\"PayPal Order Error:\", err);\n        throw new Error(\"Failed to create PayPal Order\");\n    }\n\n    const orderData = await orderRes.json() as any;\n    const approveLink = orderData.links.find((l: any) => l.rel === 'approve')?.href;\n    const paypalOrderId = orderData.id;\n\n    if (!approveLink) {\n        throw new Error(\"No approval link returned from PayPal\");\n    }\n    \n    // Update payment_ref\n    await env.DB.prepare(\"UPDATE topup_transactions SET payment_ref = ? WHERE id = ?\")\n      .bind(paypalOrderId, transactionId).run();\n\n    return Response.json({\n      status: \"success\",\n      transactionId,\n      tokensExpected: tokenCalc.totalTokens,\n      paymentUrl: approveLink,\n      type,\n      debug_info: isLive ? \"Live Mode\" : \"Sandbox Mode\"\n    });\n\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\nexport async function checkPaypalStatus(request: Request, env: Env): Promise<Response> {\n  try {\n    const body = await request.json() as { transactionId: number | string };\n    const transactionId = body.transactionId;\n    if (!transactionId) return Response.json({ error: \"Missing transactionId\" }, { status: 400 });\n\n    // 1. Get Transaction from DB\n    const transaction = await env.DB.prepare(\"SELECT * FROM topup_transactions WHERE id = ?\").bind(transactionId).first();\n    if (!transaction) return Response.json({ error: \"Transaction not found\" }, { status: 404 });\n\n    if (transaction.status === 'paid') {\n        // For subscription payments, also return subscription info if available\n        if (transaction.method === 'paypal_subscription') {\n            const user = await env.DB.prepare(\"SELECT subscription_active, subscription_expiry FROM users WHERE id = ?\")\n              .bind(transaction.user_id).first();\n            return Response.json({\n                status: 'paid',\n                message: \"Already paid\",\n                subscription_active: user?.subscription_active === 1,\n                subscription_expiry: user?.subscription_expiry || null\n            });\n        }\n        return Response.json({ status: 'paid', message: \"Already paid\" });\n    }\n\n    const orderId = transaction.payment_ref;\n    if (!orderId) return Response.json({ error: \"No PayPal Order ID found\" }, { status: 400 });\n\n    // 2. Auth PayPal\n    const clientId = env.PAYPAL_CLIENT_ID;\n    const clientSecret = env.PAYPAL_CLIENT_SECRET;\n    if (!clientId || !clientSecret) throw new Error(\"PayPal Credentials missing\");\n\n    const isLive = env.PAYPAL_MODE === 'live';\n    const baseUrl = isLive ? 'https://api-m.paypal.com' : 'https://api-m.sandbox.paypal.com';\n    const auth = btoa(`${clientId}:${clientSecret}`);\n\n    const tokenRes = await fetch(`${baseUrl}/v1/oauth2/token`, {\n        method: 'POST',\n        headers: { 'Authorization': `Basic ${auth}`, 'Content-Type': 'application/x-www-form-urlencoded' },\n        body: 'grant_type=client_credentials'\n    });\n    const tokenData = await tokenRes.json() as any;\n    const accessToken = tokenData.access_token;\n\n    // 3. Get Order Details\n    const orderRes = await fetch(`${baseUrl}/v2/checkout/orders/${orderId}`, {\n        method: 'GET',\n        headers: { 'Authorization': `Bearer ${accessToken}` }\n    });\n    \n    if (!orderRes.ok) throw new Error(\"Failed to fetch PayPal Order\");\n    \n    const orderData = await orderRes.json() as any;\n    const paypalStatus = orderData.status; // CREATED, APPROVED, COMPLETED\n\n    const isSubscription = transaction.method === 'paypal_subscription';\n\n    // 4. If APPROVED, Capture it!\n    if (paypalStatus === 'APPROVED') {\n        const captureRes = await fetch(`${baseUrl}/v2/checkout/orders/${orderId}/capture`, {\n            method: 'POST',\n            headers: { \n                'Authorization': `Bearer ${accessToken}`,\n                'Content-Type': 'application/json'\n            }\n        });\n        \n        if (!captureRes.ok) {\n             const errText = await captureRes.text();\n             console.error(\"Capture Failed:\", errText);\n             return Response.json({ status: 'pending', paypal_status: 'CAPTURE_FAILED' });\n        }\n        \n        const captureData = await captureRes.json() as any;\n        if (captureData.status === 'COMPLETED') {\n            await env.DB.prepare(\"UPDATE topup_transactions SET status = 'paid' WHERE id = ?\").bind(transactionId).run();\n\n            if (isSubscription) {\n                let durationDays = 30;\n                const currentUser = await env.DB.prepare(\"SELECT subscription_active, subscription_expiry FROM users WHERE id = ?\")\n                  .bind(transaction.user_id).first();\n                let newExpiryDate = new Date();\n                if (currentUser && currentUser.subscription_expiry) {\n                    const currentExpiry = new Date(currentUser.subscription_expiry as string);\n                    if (currentExpiry > new Date()) {\n                        newExpiryDate = currentExpiry;\n                    }\n                }\n                newExpiryDate.setDate(newExpiryDate.getDate() + durationDays);\n                const newExpiryIso = newExpiryDate.toISOString();\n\n                await env.DB.prepare(\"UPDATE users SET subscription_active = 1, subscription_expiry = ? WHERE id = ?\")\n                  .bind(newExpiryIso, transaction.user_id).run();\n\n                return Response.json({\n                    status: 'paid',\n                    paypal_status: 'COMPLETED',\n                    subscription_active: true,\n                    subscription_expiry: newExpiryIso\n                });\n            }\n\n            await addUserTokens(transaction.user_id as string, transaction.tokens_added as number, env);\n            return Response.json({ status: 'paid', paypal_status: 'COMPLETED' });\n        }\n    } else if (paypalStatus === 'COMPLETED') {\n         await env.DB.prepare(\"UPDATE topup_transactions SET status = 'paid' WHERE id = ?\").bind(transactionId).run();\n\n         if (isSubscription) {\n             let durationDays = 30;\n             const currentUser = await env.DB.prepare(\"SELECT subscription_active, subscription_expiry FROM users WHERE id = ?\")\n               .bind(transaction.user_id).first();\n             let newExpiryDate = new Date();\n             if (currentUser && currentUser.subscription_expiry) {\n                 const currentExpiry = new Date(currentUser.subscription_expiry as string);\n                 if (currentExpiry > new Date()) {\n                     newExpiryDate = currentExpiry;\n                 }\n             }\n             newExpiryDate.setDate(newExpiryDate.getDate() + durationDays);\n             const newExpiryIso = newExpiryDate.toISOString();\n\n             await env.DB.prepare(\"UPDATE users SET subscription_active = 1, subscription_expiry = ? WHERE id = ?\")\n               .bind(newExpiryIso, transaction.user_id).run();\n\n             return Response.json({\n                 status: 'paid',\n                 paypal_status: 'COMPLETED',\n                 subscription_active: true,\n                 subscription_expiry: newExpiryIso\n             });\n         }\n\n         await addUserTokens(transaction.user_id as string, transaction.tokens_added as number, env);\n         return Response.json({ status: 'paid', paypal_status: 'COMPLETED' });\n    }\n\n    return Response.json({ status: transaction.status, paypal_status: paypalStatus });\n\n  } catch (e: any) {\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\nexport async function handlePaypalWebhook(request: Request, env: Env): Promise<Response> {\n  try {\n    // 1. SECURITY CHECK (Signature Verification)\n    // In production, you MUST verify the PayPal signature header to ensure the request comes from PayPal.\n    // See: https://developer.paypal.com/api/rest/webhooks/rest/#verify-webhook-signature\n    \n    // For now, we rely on the unique 'payment_ref' (Order ID) being present and in 'pending' status in our DB.\n    // An attacker cannot easily guess a valid, pending Order ID.\n    \n    const data = await request.json() as any;\n    \n    if (data.event_type === 'PAYMENT.CAPTURE.COMPLETED') {\n        const orderId = data.resource.id; // PayPal Order ID\n        const amountPaid = parseFloat(data.resource.amount.value); // Ensure we get actual paid amount\n        \n        // 3. Cari Transaksi\n        const transaction = await env.DB.prepare(\"SELECT * FROM topup_transactions WHERE payment_ref = ?\").bind(orderId).first();\n        \n        if (transaction && transaction.status === 'pending') {\n            // Verify amount logic (Optional but recommended)\n            // if (Math.abs(amountPaid - (transaction.amount_usd as number)) > 0.1) ...\n\n            // 4. Update Status & Tambah Token\n            await env.DB.prepare(\"UPDATE topup_transactions SET status = 'paid', amount_usd = ? WHERE id = ?\")\n                .bind(amountPaid, transaction.id).run();\n\n            if (transaction.method === 'paypal_subscription') {\n                let durationDays = 30;\n                const currentUser = await env.DB.prepare(\"SELECT subscription_active, subscription_expiry, email FROM users WHERE id = ?\")\n                  .bind(transaction.user_id).first();\n\n                let newExpiryDate = new Date();\n                if (currentUser && currentUser.subscription_expiry) {\n                    const currentExpiry = new Date(currentUser.subscription_expiry as string);\n                    if (currentExpiry > new Date()) {\n                        newExpiryDate = currentExpiry;\n                    }\n                }\n                newExpiryDate.setDate(newExpiryDate.getDate() + durationDays);\n                const newExpiryIso = newExpiryDate.toISOString();\n\n                await env.DB.prepare(\"UPDATE users SET subscription_active = 1, subscription_expiry = ? WHERE id = ?\")\n                  .bind(newExpiryIso, transaction.user_id).run();\n\n                return Response.json({\n                    status: \"success\",\n                    method: \"paypal_subscription\",\n                    amount_usd: amountPaid,\n                    subscription_active: true,\n                    subscription_expiry: newExpiryIso\n                });\n            }\n\n            const newBalance = await addUserTokens(transaction.user_id as string, transaction.tokens_added as number, env);\n            \n            const user = await env.DB.prepare(\"SELECT email FROM users WHERE id = ?\").bind(transaction.user_id).first();\n            if (user && user.email) {\n                const html = getTopupSuccessTemplate(amountPaid, transaction.tokens_added as number, 'USD');\n                sendEmail(user.email as string, \"Top Up Successful!\", html, env);\n            }\n\n            return Response.json({ \n                status: \"success\", \n                method: \"paypal\",\n                amount_usd: amountPaid,\n                tokens_added: transaction.tokens_added,\n                new_balance: newBalance\n            });\n        }\n    }\n    \n    return Response.json({ status: \"ignored\" });\n\n  } catch (e: any) {\n    console.error(\"PayPal Webhook Error:\", e);\n    return Response.json({ error: e.message }, { status: 500 });\n  }\n}\n\nexport async function paymentSuccessPage(_req: Request, _env: Env): Promise<Response> {\n  const html = `<!DOCTYPE html><html><head><meta charset=\"utf-8\"><title>Payment Successful</title><style>body{font-family:sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;background:#121212;color:#fff}.box{background:#1e1e1e;padding:32px;border-radius:12px;text-align:center;max-width:520px}h1{color:#4caf50;margin:0 0 8px}p{color:#aaa;margin:6px 0}.btn{margin-top:12px;padding:10px 16px;border:none;border-radius:8px;background:#4caf50;color:#fff;cursor:pointer;font-weight:600}.link{color:#4fc3f7;text-decoration:none}</style><script>function returnToApp(){try{window.location.href='metabayn-studio://return'}catch(e){}setTimeout(function(){window.close()},800)}</script></head><body><div class=\"box\"><h1>Payment Successful</h1><p>You can close this tab and return to the app.</p><p>If your balance has not updated yet, the app will check automatically.</p><button class=\"btn\" onclick=\"returnToApp()\">Return to App</button><p style=\"margin-top:10px\"><a class=\"link\" href=\"metabayn-studio://return\">Open Metabayn Studio</a></p></div></body></html>`;\n  return new Response(html, { headers: { 'Content-Type': 'text/html' } });\n}\n\nexport async function paymentCancelPage(_req: Request, _env: Env): Promise<Response> {\n  const html = `<!DOCTYPE html><html><head><meta charset=\"utf-8\"><title>Payment Cancelled</title><style>body{font-family:sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;background:#121212;color:#fff}.box{background:#1e1e1e;padding:32px;border-radius:12px;text-align:center;max-width:520px}h1{color:#ff7043;margin:0 0 8px}p{color:#aaa;margin:6px 0}.btn{margin-top:12px;padding:10px 16px;border:none;border-radius:8px;background:#4caf50;color:#fff;cursor:pointer;font-weight:600}.link{color:#4fc3f7;text-decoration:none}</style><script>function returnToApp(){try{window.location.href='metabayn-studio://return'}catch(e){}setTimeout(function(){window.close()},800)}</script></head><body><div class=\"box\"><h1>Payment Cancelled</h1><p>The transaction was not completed. You can close this tab and return to the app.</p><p>If you encounter issues with your payment, please contact the admin via WhatsApp at <a class=\"link\" href=\"https://wa.me/628996701661\" target=\"_blank\" rel=\"noopener\">+62 899 6701 661</a>.</p><button class=\"btn\" onclick=\"returnToApp()\">Return to App</button><p style=\"margin-top:10px\"><a class=\"link\" href=\"metabayn-studio://return\">Open Metabayn Studio</a></p></div></body></html>`;\n  return new Response(html, { headers: { 'Content-Type': 'text/html' } });\n}\n\n// --- QRIS HANDLERS (IDR) ---\n\nexport async function createQrisPayment(_request: Request, _env: Env): Promise<Response> {\n  return Response.json({ error: \"QRIS disabled\" }, { status: 410 });\n}\n\nexport async function checkQrisStatus(_request: Request, _env: Env): Promise<Response> {\n  return Response.json({ error: \"QRIS disabled\" }, { status: 410 });\n}\n\nexport async function handleQrisCallback(_request: Request, _env: Env): Promise<Response> {\n  return Response.json({ error: \"QRIS disabled\" }, { status: 410 });\n}\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n"],
  "mappings": "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",
  "names": ["content", "inputTokens", "outputTokens", "generateCode", "authHeader", "token", "handleSyncModelPrices", "handleSyncLiveModelPrices", "handleAdminAuthLogs"]
}
